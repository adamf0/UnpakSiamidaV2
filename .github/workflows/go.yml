name: Go Test, Coverage, Swagger & DAST

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: write

# ==========================================================
# BUILD
# ==========================================================
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v4
        with:
          go-version: '1.25.4'

      - run: go mod tidy
      - run: go list ./...

# ==========================================================
# TEST + COVERAGE (PER MODULE)
# ==========================================================
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    needs: build
    env:
      TESTCONTAINERS_REUSE_ENABLE: "true"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v4
        with:
          go-version: '1.25.4'

      - name: Run tests (per module coverage)
        run: |
          set -e
          mkdir -p coverage

          for module in modules/*; do
            name=$(basename "$module")
            echo "▶ Processing module: $name"

            out="coverage/${name}.out"
            echo "mode: atomic" > "$out"

            # === DOMAIN ===
            if [ -d "$module/domaintest" ]; then
              go test -v \
                -covermode=atomic \
                -coverpkg=./modules/$name/domain/... \
                -coverprofile=coverage/tmp.out \
                ./modules/$name/domaintest || exit 1

              grep -v "^mode:" coverage/tmp.out >> "$out"
            fi

            # === APPLICATION ===
            if [ -d "$module/applicationtest" ]; then
              go test -v \
                -covermode=atomic \
                -coverpkg=./modules/$name/application/... \
                -coverprofile=coverage/tmp.out \
                ./modules/$name/applicationtest || exit 1

              grep -v "^mode:" coverage/tmp.out >> "$out"
            fi

            # === SKIP MODULE TANPA COVERAGE ===
            if [ "$(wc -l < "$out")" -le 1 ]; then
              echo "⚠ Skip $name (no coverage)"
              rm -f "$out"
            fi
          done

          rm -f coverage/tmp.out

      - uses: actions/upload-artifact@v4
        with:
          name: go-coverage
          path: coverage

# ==========================================================
# SWAGGER + COVERAGE REPORT
# ==========================================================
  report:
    name: Coverage & Swagger
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v4
        with:
          go-version: '1.25.4'

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install tools
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest
          go install github.com/boumenot/gocover-cobertura@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

          dotnet tool install --global dotnet-reportgenerator-globaltool
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      # =============================
      # SWAGGER
      # =============================
      - name: Generate Swagger
        run: |
          swag init -g main.go --parseDependency --parseInternal

      - name: Build Swagger UI
        run: |
          mkdir -p public/swagger
          cp docs/swagger.json public/swagger/swagger.json

          cat <<EOF > public/swagger/index.html
          <!DOCTYPE html>
          <html>
          <head>
            <title>UnpakSiamida API</title>
            <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist/swagger-ui.css"/>
          </head>
          <body>
            <div id="swagger-ui"></div>
            <script src="https://unpkg.com/swagger-ui-dist/swagger-ui-bundle.js"></script>
            <script>
              SwaggerUIBundle({
                url: "swagger.json",
                dom_id: "#swagger-ui",
              });
            </script>
          </body>
          </html>
          EOF

      # =============================
      # COVERAGE REPORT (PER MODULE)
      # =============================
      - uses: actions/download-artifact@v4
        with:
          name: go-coverage
          path: coverage

      - name: Generate Coverage HTML (per module)
        run: |
          mkdir -p public/coverage

          for out in coverage/*.out; do
            modulename=$(basename "$out" .out)
            echo "▶ Generate coverage for $modulename"

            mkdir -p public/coverage/$modulename

            gocover-cobertura < "$out" > coverage/$modulename.xml

            reportgenerator \
              -reports:coverage/$modulename.xml \
              -targetdir:public/coverage/$modulename \
              -reporttypes:Html \
              -sourcedirs:./modules/$modulename
          done

      - name: Coverage index page
        run: |
          cat <<EOF > public/coverage/index.html
          <html>
          <body>
          <h1>Module Coverage</h1>
          <ul>
          $(for d in public/coverage/*; do
            name=$(basename "$d")
            [ "$name" != "index.html" ] && echo "<li><a href='./$name/'>$name</a></li>"
          done)
          </ul>
          </body>
          </html>
          EOF

      - name: Deploy Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages

# ==========================================================
# SECRET SCANNING
# ==========================================================
  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trufflehog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: edplato/trufflehog-actions-scan@master
