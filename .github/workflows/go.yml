name: Go Test, Coverage, Swagger & DAST

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: write

# ==========================================================
# BUILD
# ==========================================================
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: '1.25.4'
      - run: go mod tidy
      - run: go list ./...

# ==========================================================
# TEST + COVERAGE
# ==========================================================
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    env:
      TESTCONTAINERS_REUSE_ENABLE: "true"
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: '1.25.4'

      - name: Run tests
        run: |
          set -e
          mkdir -p coverage
          for testdir in $(find ./modules -type d \( -name "applicationtest" -o -name "domaintest" \)); do
            modulepath=$(dirname "$testdir")
            modulename=$(basename "$modulepath")
            testname=$(basename "$testdir")

            if [[ "$testname" == "applicationtest" ]]; then
              coverpkg="UnpakSiamida/modules/${modulename}/application/..."
            else
              coverpkg="UnpakSiamida/modules/${modulename}/domain/..."
            fi

            go test -v \
              -covermode=atomic \
              -coverpkg=$coverpkg \
              -coverprofile=coverage/${modulename}_${testname}.out \
              $testdir
          done

      - name: Merge coverage
        run: |
          echo "mode: count" > coverage/coverage_all.out
          tail -q -n +2 coverage/*.out >> coverage/coverage_all.out

      - uses: actions/upload-artifact@v4
        with:
          name: go-coverage
          path: coverage

# ==========================================================
# SWAGGER + COVERAGE REPORT (serial)
# ==========================================================
  report:
    name: Coverage & Swagger
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: '1.25.4'
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install tools
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest
          go install github.com/boumenot/gocover-cobertura@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
          dotnet tool install --global dotnet-reportgenerator-globaltool
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Generate Swagger
        run: |
          swag init -g main.go --parseDependency --parseInternal

      - name: Build Swagger UI
        run: |
          mkdir -p public/swagger
          cp docs/swagger.json public/swagger/swagger.json
          cat <<EOF > public/swagger/index.html
          <!DOCTYPE html>
          <html>
          <head>
            <title>UnpakSiamida API</title>
            <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist/swagger-ui.css"/>
          </head>
          <body>
            <div id="swagger-ui"></div>
            <script src="https://unpkg.com/swagger-ui-dist/swagger-ui-bundle.js"></script>
            <script>
              SwaggerUIBundle({
                url: "swagger.json",
                dom_id: "#swagger-ui",
              });
            </script>
          </body>
          </html>
          EOF

      - uses: actions/download-artifact@v4
        with:
          name: go-coverage
          path: coverage

      - name: Generate Coverage HTML
        run: |
          gocover-cobertura < coverage/coverage_all.out > coverage/coverage.xml
          reportgenerator \
            -reports:coverage/coverage.xml \
            -targetdir:public/coverage \
            -reporttypes:Html \
            -sourcedirs:./modules
          
          # Pastikan index.html ada
          if [ ! -f public/coverage/index.html ]; then
            if [ -f public/coverage/index.htm ]; then
              mv public/coverage/index.htm public/coverage/index.html
            fi
          fi

      - name: Deploy Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages

# ==========================================================
# DAST (ZAP) — JALAN SETELAH SWAGGER SIAP
# ==========================================================
  # dast:
  #   name: ZAP DAST
  #   runs-on: ubuntu-latest
  #   needs: report
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Start Docker Compose (CI)
  #       run: |
  #         docker compose -f docker-compose.ci.yml up -d
  #         docker compose -f docker-compose.ci.yml ps

  #     - name: Wait Swagger ready
  #       run: |
  #         echo "⏳ Waiting for Swagger..."
  #         for i in {1..40}; do
  #           if curl -s https://adamf0.github.io/UnpakSiamidaV2/swagger/swagger.json | grep -q '"openapi"'; then
  #             echo "✅ Swagger ready"
  #             exit 0
  #           fi
  #           sleep 3
  #         done
  #         echo "❌ Swagger not ready"
  #         exit 1

  #     - name: ZAP DAST Scan
  #       uses: zaproxy/action-api-scan@v0.7.0
  #       with:
  #         target: https://adamf0.github.io/UnpakSiamidaV2/swagger/swagger.json
  #         format: openapi
  #         fail_action: false
  #         cmd_options: "-a -m 5 -l WARN"

  #     - name: Shutdown containers
  #       if: always()
  #       run: docker compose -f docker-compose.ci.yml down

# ==========================================================
# SECRET SCANNING
# ==========================================================
  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trufflehog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: edplato/trufflehog-actions-scan@master
