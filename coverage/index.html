
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Login: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">UnpakSiamida/modules/account/application/Login/LoginCommandHandler.go (0.0%)</option>
				
				<option value="file1">UnpakSiamida/modules/account/application/Login/LoginCommandValidation.go (0.0%)</option>
				
				<option value="file2">UnpakSiamida/modules/account/application/Whoami/WhoamiCommandHandler.go (0.0%)</option>
				
				<option value="file3">UnpakSiamida/modules/account/application/Whoami/WhoamiCommandValidation.go (0.0%)</option>
				
				<option value="file4">UnpakSiamida/modules/account/domain/Account.go (0.0%)</option>
				
				<option value="file5">UnpakSiamida/modules/account/domain/AccountErrors.go (0.0%)</option>
				
				<option value="file6">UnpakSiamida/modules/dokumentambahan/application/DeleteDokumenTambahan/DeleteDokumenTambahanCommandHandler.go (0.0%)</option>
				
				<option value="file7">UnpakSiamida/modules/dokumentambahan/application/DeleteDokumenTambahan/DeleteDokumenTambahanCommandValidation.go (0.0%)</option>
				
				<option value="file8">UnpakSiamida/modules/dokumentambahan/application/GetAllDokumenTambahans/GetAllDokumenTambahansQueryHandler.go (0.0%)</option>
				
				<option value="file9">UnpakSiamida/modules/dokumentambahan/application/GetDokumenTambahan/GetDokumenTambahanByUuidQueryHandler.go (0.0%)</option>
				
				<option value="file10">UnpakSiamida/modules/dokumentambahan/application/GetDokumenTambahanDefault/GetDokumenTambahanDefaultByUuidQueryHandler.go (0.0%)</option>
				
				<option value="file11">UnpakSiamida/modules/dokumentambahan/application/SetupUuidDokumenTambahan/SetupUuidDokumenTambahanCommandHandler.go (0.0%)</option>
				
				<option value="file12">UnpakSiamida/modules/dokumentambahan/application/UpdateDokumenTambahan/UpdateDokumenTambahanCommandHandler.go (0.0%)</option>
				
				<option value="file13">UnpakSiamida/modules/dokumentambahan/application/UpdateDokumenTambahan/UpdateDokumenTambahanCommandValidation.go (0.0%)</option>
				
				<option value="file14">UnpakSiamida/modules/dokumentambahan/domain/DokumenTambahan.go (0.0%)</option>
				
				<option value="file15">UnpakSiamida/modules/dokumentambahan/domain/DokumenTambahanErrors.go (0.0%)</option>
				
				<option value="file16">UnpakSiamida/modules/fakultasunit/application/GetAllFakultasUnits/GetAllFakultasUnitsQueryHandler.go (0.0%)</option>
				
				<option value="file17">UnpakSiamida/modules/fakultasunit/application/GetFakultasUnit/GetFakultasUnitByUuidQueryHandler.go (0.0%)</option>
				
				<option value="file18">UnpakSiamida/modules/fakultasunit/application/SetupUuidFakultasUnit/SetupUuidFakultasUnitCommandHandler.go (0.0%)</option>
				
				<option value="file19">UnpakSiamida/modules/fakultasunit/domain/FakultasUnit.go (0.0%)</option>
				
				<option value="file20">UnpakSiamida/modules/fakultasunit/domain/FakultasUnitErrors.go (0.0%)</option>
				
				<option value="file21">UnpakSiamida/modules/generaterenstra/domain/GenerateDokumenTambahan.go (0.0%)</option>
				
				<option value="file22">UnpakSiamida/modules/generaterenstra/domain/GenerateRenstra.go (0.0%)</option>
				
				<option value="file23">UnpakSiamida/modules/generaterenstra/domain/GenerateRenstraErrors.go (0.0%)</option>
				
				<option value="file24">UnpakSiamida/modules/indikatorrenstra/application/CreateIndikatorRenstra/CreateIndikatorRenstraCommandHandler.go (0.0%)</option>
				
				<option value="file25">UnpakSiamida/modules/indikatorrenstra/application/CreateIndikatorRenstra/CreateIndikatorRenstraCommandValidation.go (0.0%)</option>
				
				<option value="file26">UnpakSiamida/modules/indikatorrenstra/application/DeleteIndikatorRenstra/DeleteIndikatorRenstraCommandHandler.go (0.0%)</option>
				
				<option value="file27">UnpakSiamida/modules/indikatorrenstra/application/DeleteIndikatorRenstra/DeleteIndikatorRenstraCommandValidation.go (0.0%)</option>
				
				<option value="file28">UnpakSiamida/modules/indikatorrenstra/application/GetAllIndikatorRenstras/GetAllIndikatorRenstrasQueryHandler.go (0.0%)</option>
				
				<option value="file29">UnpakSiamida/modules/indikatorrenstra/application/GetIndikatorRenstra/GetIndikatorRenstraByUuidQueryHandler.go (0.0%)</option>
				
				<option value="file30">UnpakSiamida/modules/indikatorrenstra/application/GetIndikatorRenstraDefault/GetIndikatorRenstraDefaultByUuidQueryHandler.go (0.0%)</option>
				
				<option value="file31">UnpakSiamida/modules/indikatorrenstra/application/SetupUuidIndikatorRenstra/SetupUuidIndikatorRenstraCommandHandler.go (0.0%)</option>
				
				<option value="file32">UnpakSiamida/modules/indikatorrenstra/application/UpdateIndikatorRenstra/UpdateIndikatorRenstraCommandHandler.go (0.0%)</option>
				
				<option value="file33">UnpakSiamida/modules/indikatorrenstra/application/UpdateIndikatorRenstra/UpdateIndikatorRenstraCommandValidation.go (0.0%)</option>
				
				<option value="file34">UnpakSiamida/modules/indikatorrenstra/domain/IndikatorRenstra.go (0.0%)</option>
				
				<option value="file35">UnpakSiamida/modules/indikatorrenstra/domain/IndikatorRenstraErrors.go (0.0%)</option>
				
				<option value="file36">UnpakSiamida/modules/jenisfile/application/CreateJenisFile/CreateJenisFileCommandHandler.go (0.0%)</option>
				
				<option value="file37">UnpakSiamida/modules/jenisfile/application/CreateJenisFile/CreateJenisFileCommandValidation.go (0.0%)</option>
				
				<option value="file38">UnpakSiamida/modules/jenisfile/application/DeleteJenisFile/DeleteJenisFileCommandHandler.go (0.0%)</option>
				
				<option value="file39">UnpakSiamida/modules/jenisfile/application/DeleteJenisFile/DeleteJenisFileCommandValidation.go (0.0%)</option>
				
				<option value="file40">UnpakSiamida/modules/jenisfile/application/GetAllJenisFiles/GetAllJenisFilesQueryHandler.go (0.0%)</option>
				
				<option value="file41">UnpakSiamida/modules/jenisfile/application/GetJenisFile/GetJenisFileByUuidQueryHandler.go (0.0%)</option>
				
				<option value="file42">UnpakSiamida/modules/jenisfile/application/GetJenisFileDefault/GetJenisFileDefaultByUuidQueryHandler.go (0.0%)</option>
				
				<option value="file43">UnpakSiamida/modules/jenisfile/application/SetupUuidJenisFile/SetupUuidJenisFileCommandHandler.go (0.0%)</option>
				
				<option value="file44">UnpakSiamida/modules/jenisfile/application/UpdateJenisFile/UpdateJenisFileCommandHandler.go (0.0%)</option>
				
				<option value="file45">UnpakSiamida/modules/jenisfile/application/UpdateJenisFile/UpdateJenisFileCommandValidation.go (0.0%)</option>
				
				<option value="file46">UnpakSiamida/modules/jenisfile/domain/JenisFile.go (0.0%)</option>
				
				<option value="file47">UnpakSiamida/modules/jenisfile/domain/JenisFileErrors.go (0.0%)</option>
				
				<option value="file48">UnpakSiamida/modules/kts/domain/Kts.go (0.0%)</option>
				
				<option value="file49">UnpakSiamida/modules/kts/domain/KtsErrors.go (0.0%)</option>
				
				<option value="file50">UnpakSiamida/modules/previewtemplate/domain/PreviewTemplateErrors.go (0.0%)</option>
				
				<option value="file51">UnpakSiamida/modules/renstra/domain/Renstra.go (0.0%)</option>
				
				<option value="file52">UnpakSiamida/modules/renstra/domain/RenstraErrors.go (0.0%)</option>
				
				<option value="file53">UnpakSiamida/modules/renstranilai/domain/RenstraNilai.go (0.0%)</option>
				
				<option value="file54">UnpakSiamida/modules/renstranilai/domain/RenstraNilaiErrors.go (0.0%)</option>
				
				<option value="file55">UnpakSiamida/modules/standarrenstra/domain/StandarRenstra.go (0.0%)</option>
				
				<option value="file56">UnpakSiamida/modules/standarrenstra/domain/StandarRenstraErrors.go (0.0%)</option>
				
				<option value="file57">UnpakSiamida/modules/tahunrenstra/application/GetActiveTahunRenstra/GetActiveTahunRenstraQueryHandler.go (0.0%)</option>
				
				<option value="file58">UnpakSiamida/modules/tahunrenstra/application/GetAllTahunRenstras/GetAllTahunRenstrasQueryHandler.go (0.0%)</option>
				
				<option value="file59">UnpakSiamida/modules/tahunrenstra/domain/TahunRenstra.go (0.0%)</option>
				
				<option value="file60">UnpakSiamida/modules/tahunrenstra/domain/TahunRenstraErrors.go (0.0%)</option>
				
				<option value="file61">UnpakSiamida/modules/templatedokumentambahan/domain/TemplateDokumenTambahan.go (0.0%)</option>
				
				<option value="file62">UnpakSiamida/modules/templatedokumentambahan/domain/TemplateDokumenTambahanErrors.go (0.0%)</option>
				
				<option value="file63">UnpakSiamida/modules/templaterenstra/domain/TemplateRenstra.go (0.0%)</option>
				
				<option value="file64">UnpakSiamida/modules/templaterenstra/domain/TemplateRenstraErrors.go (0.0%)</option>
				
				<option value="file65">UnpakSiamida/modules/user/application/CreateUser/CreateUserCommandHandler.go (0.0%)</option>
				
				<option value="file66">UnpakSiamida/modules/user/application/CreateUser/CreateUserCommandValidation.go (0.0%)</option>
				
				<option value="file67">UnpakSiamida/modules/user/application/DeleteUser/DeleteUserCommandHandler.go (0.0%)</option>
				
				<option value="file68">UnpakSiamida/modules/user/application/DeleteUser/DeleteUserCommandValidation.go (0.0%)</option>
				
				<option value="file69">UnpakSiamida/modules/user/application/GetAllUsers/GetAllUsersQueryHandler.go (0.0%)</option>
				
				<option value="file70">UnpakSiamida/modules/user/application/GetUser/GetUserByUuidQueryHandler.go (0.0%)</option>
				
				<option value="file71">UnpakSiamida/modules/user/application/SetupUuidUser/SetupUuidUserCommandHandler.go (0.0%)</option>
				
				<option value="file72">UnpakSiamida/modules/user/application/UpdateUser/UpdateUserCommandHandler.go (0.0%)</option>
				
				<option value="file73">UnpakSiamida/modules/user/application/UpdateUser/UpdateUserCommandValidation.go (0.0%)</option>
				
				<option value="file74">UnpakSiamida/modules/user/domain/User.go (0.0%)</option>
				
				<option value="file75">UnpakSiamida/modules/user/domain/UserErrors.go (0.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package application

import (
        "context"
        "errors"

        helper "UnpakSiamida/common/helper"
        domainaccount "UnpakSiamida/modules/account/domain"
        "time"

        "gorm.io/gorm"
)

type LoginCommandHandler struct {
        Repo domainaccount.IAccountRepository
}

func (h *LoginCommandHandler) Handle(
        ctx context.Context,
        cmd LoginCommand,
) (*domainaccount.LoginResult, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        user, err := h.Repo.Auth(ctx, cmd.Username, cmd.Password)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domainaccount.InvalidCredential()
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

        <span class="cov0" title="0">sid := user.UUID
        accessToken, refreshToken, err := helper.GenerateToken(sid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return &amp;domainaccount.LoginResult{
                AccessToken:  accessToken,
                RefreshToken: refreshToken,
                UserID:       sid,
        }, nil</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func LoginCommandValidation(cmd LoginCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Username,
                        validation.Required.Error("Username cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Password,
                        validation.Required.Error("Password cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file2" style="display: none">package application

import (
        "context"
        "errors"

        domainaccount "UnpakSiamida/modules/account/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type WhoamiCommandHandler struct {
        Repo domainaccount.IAccountRepository
}

func (h *WhoamiCommandHandler) Handle(
        ctx context.Context,
        cmd WhoamiCommand,
) (*domainaccount.Account, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        _, err := uuid.Parse(cmd.SID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domainaccount.NotFound(cmd.SID)
        }</span>

        <span class="cov0" title="0">user, err := h.Repo.Get(ctx, cmd.SID)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domainaccount.InvalidCredential()
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }
        <span class="cov0" title="0">if user.ExtraRole == nil </span><span class="cov0" title="0">{
                user.ExtraRole = []domainaccount.ExtraRole{}
        }</span>

        <span class="cov0" title="0">return user, nil</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package application

import (
        helper "UnpakSiamida/common/helper"

        validation "github.com/go-ozzo/ozzo-validation/v4"
)

func WhoamiCommandValidation(cmd WhoamiCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.SID,
                        validation.Required.Error("Username cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</span>
</pre>
		
		<pre class="file" id="file4" style="display: none">package domain

type Account struct {
        ID           string       `json:"-"`
        UUID         string       `json:"UUID"`
        NidnUsername string       `json:"Username"`
        Password     string       `json:"-"`
        Level        string       `json:"Level"`
        Name         string       `json:"Name"`
        Email        string       `json:"Email"`
        FakultasUnit string       `json:"FakultasUnit"`
        ExtraRole    []ExtraRole  `gorm:"-"; json:"ExtraRole,omitempty"`
}

func (Account) TableName() string <span class="cov0" title="0">{
        return "users"
}</pre>
		
		<pre class="file" id="file5" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func InvalidCredential() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Account.InvalidCredential", "invalid credentials")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Account.NotFound", fmt.Sprintf("Account with identifier %s not found", id))
}</span>
</pre>
		
		<pre class="file" id="file6" style="display: none">package application

import (
        "context"

        domaindokumentambahan "UnpakSiamida/modules/dokumentambahan/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type DeleteDokumenTambahanCommandHandler struct {
        Repo domaindokumentambahan.IDokumenTambahanRepository
}

func (h *DeleteDokumenTambahanCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteDokumenTambahanCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        dokumentambahanUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaindokumentambahan.InvalidUuid()
        }</span>

        // Get existing dokumentambahan
        <span class="cov0" title="0">_, err = h.Repo.GetByUuid(ctx, dokumentambahanUUID)
        if err != nil </span><span class="cov0" title="0">{
                if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                        return "", domaindokumentambahan.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // Delete by UUID
        <span class="cov0" title="0">if err := h.Repo.Delete(ctx, dokumentambahanUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov0" title="0">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file7" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func DeleteDokumenTambahanCommandValidation(cmd DeleteDokumenTambahanCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file8" style="display: none">package application

import (
    "context"
    domaindokumentambahan "UnpakSiamida/modules/dokumentambahan/domain"
    "time"
)

type GetAllDokumenTambahansQueryHandler struct {
    Repo domaindokumentambahan.IDokumenTambahanRepository
}

func (h *GetAllDokumenTambahansQueryHandler) Handle(
    ctx context.Context,
    q GetAllDokumenTambahansQuery,
) (domaindokumentambahan.PagedDokumenTambahans, error) <span class="cov0" title="0">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    dokumentambahans, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domaindokumentambahan.PagedDokumenTambahans{}, err
    }</span>

    <span class="cov0" title="0">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov0" title="0">{
        currentPage = *q.Page
    }</span>
    <span class="cov0" title="0">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov0" title="0">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov0" title="0">return domaindokumentambahan.PagedDokumenTambahans{
        Data:  dokumentambahans,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file9" style="display: none">package application

import (
    "context"

    domaindokumentambahan "UnpakSiamida/modules/dokumentambahan/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetDokumenTambahanByUuidQueryHandler struct {
    Repo domaindokumentambahan.IDokumenTambahanRepository
}

func (h *GetDokumenTambahanByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetDokumenTambahanByUuidQuery,
) (*domaindokumentambahan.DokumenTambahan, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domaindokumentambahan.NotFound(q.Uuid)
        }</span>

    <span class="cov0" title="0">existingDokumenTambahan, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domaindokumentambahan.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov0" title="0">return existingDokumenTambahan, nil</span>
}
</pre>
		
		<pre class="file" id="file10" style="display: none">package application

import (
        "context"

        domaindokumentambahan "UnpakSiamida/modules/dokumentambahan/domain"
        "errors"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type GetDokumenTambahanDefaultByUuidQueryHandler struct {
        Repo domaindokumentambahan.IDokumenTambahanRepository
}

func (h *GetDokumenTambahanDefaultByUuidQueryHandler) Handle(
        ctx context.Context,
        q GetDokumenTambahanDefaultByUuidQuery,
) (*domaindokumentambahan.DokumenTambahanDefault, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

        parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domaindokumentambahan.NotFound(q.Uuid)
        }</span>

        <span class="cov0" title="0">existingDokumenTambahan, err := h.Repo.GetDefaultByUuid(ctx, parsed)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domaindokumentambahan.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

        <span class="cov0" title="0">return existingDokumenTambahan, nil</span>
}
</pre>
		
		<pre class="file" id="file11" style="display: none">package application

import (
        "context"

        domaindokumentambahan "UnpakSiamida/modules/dokumentambahan/domain"
)

type SetupUuidDokumenTambahanCommandHandler struct {
        Repo domaindokumentambahan.IDokumenTambahanRepository
}

func (h *SetupUuidDokumenTambahanCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidDokumenTambahanCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file12" style="display: none">package application

import (
        domaindokumentambahan "UnpakSiamida/modules/dokumentambahan/domain"
        domainrenstra "UnpakSiamida/modules/renstra/domain"
        "context"
        "time"

        "github.com/google/uuid"
        "golang.org/x/sync/errgroup"
        "gorm.io/gorm"
)

type UpdateDokumenTambahanCommandHandler struct {
        Repo        domaindokumentambahan.IDokumenTambahanRepository
        RepoRenstra domainrenstra.IRenstraRepository
}

func (h *UpdateDokumenTambahanCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateDokumenTambahanCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        dokumenTambahanUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaindokumentambahan.InvalidUuid()
        }</span>

        <span class="cov0" title="0">renstraUUID, err := uuid.Parse(cmd.UuidRenstra)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaindokumentambahan.InvalidRenstra()
        }</span>

        //paralel
        <span class="cov0" title="0">var (
                prev    *domaindokumentambahan.DokumenTambahan
                renstra *domainrenstra.Renstra
        )

        g, gctx := errgroup.WithContext(ctx)

        g.Go(func() error </span><span class="cov0" title="0">{
                var err error
                prev, err = h.Repo.GetByUuid(gctx, dokumenTambahanUUID)
                if err != nil </span><span class="cov0" title="0">{
                        if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                                return domaindokumentambahan.NotFound(cmd.Uuid)
                        }</span>
                        <span class="cov0" title="0">return err</span>
                }
                <span class="cov0" title="0">return nil</span>
        })

        <span class="cov0" title="0">g.Go(func() error </span><span class="cov0" title="0">{
                var err error
                renstra, err = h.RepoRenstra.GetByUuid(gctx, renstraUUID)
                if err != nil </span><span class="cov0" title="0">{
                        if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                                return domaindokumentambahan.NotFoundRenstra(cmd.Uuid)
                        }</span>
                        <span class="cov0" title="0">return err</span>
                }
                <span class="cov0" title="0">return nil</span>
        })

        <span class="cov0" title="0">if err := g.Wait(); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">result := domaindokumentambahan.UpdateDokumenTambahan(
                prev,
                renstra,
                dokumenTambahanUUID,
                renstraUUID,
                cmd.Tahun,
                cmd.Mode,
                cmd.Granted,
                cmd.Link,
                cmd.CapaianAuditor,
                cmd.CatatanAuditor,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov0" title="0">dokumenTambahan := result.Value

        if err := h.Repo.Update(ctx, dokumenTambahan); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return dokumenTambahan.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file13" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func UpdateDokumenTambahanCommandValidation(cmd UpdateDokumenTambahanCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,

                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID wajib diisi"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.UuidRenstra,
                        validation.Required.Error("UUID Renstra wajib diisi"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun wajib diisi"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Mode,
                        validation.Required.Error("Mode wajib diisi"),
                        validation.In("auditee", "auditor1", "auditor2").Error("Mode harus auditee, auditor1 atau auditor2"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                
                validation.Field(&amp;cmd.Granted,
                        validation.Required.Error("Granted wajib diisi"),
                ),

                /*
                [vuln] case jika link bukan google drive maupun unpak, serangan yg memungkinkan memasukkan link external yg dimana tujuannya mengambil token pengguna seperti admin maupun auditor 
                CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:L/A:N (8.1)
                | Metric                       | Value            | Alasan                           |
                | ---------------------------- | ---------------- | -------------------------------- |
                | Attack Vector (AV)                  | Network (N)      | Link via web                     |
                | Attack Complexity (AC)       | Low (L)          | Cukup klik link                  |
                | Privileges Required (PR)     | Low (L)          | Auditee bisa submit              |
                | User Interaction (UI)        | Required (R)     | Admin/Auditor harus klik         |
                | Scope (S)                    | Changed (C)      | Token dicuri â†’ akses sistem lain |
                | Confidentiality (C)          | High (H)         | Token auth                       |
                | Integrity (I)                | Low (L)          | Impersonation                    |
                | Availability (A)             | None (N)         | Tidak DoS                        |
                */
                validation.Field(&amp;cmd.Link, 
                        validation.When(cmd.Mode == "auditee",
                                validation.Required.Error("Link wajib diisi untuk auditee"),
                                validation.By(helper.NoXSSFullScanWithDecode()),
                        ),
                ),

                validation.Field(&amp;cmd.CapaianAuditor,
                        validation.When(cmd.Mode == "auditor1",
                                validation.Required.Error("CapaianAuditor wajib diisi untuk auditor1"),
                                validation.By(helper.NoXSSFullScanWithDecode()),
                        ),
                ),
        )
}</pre>
		
		<pre class="file" id="file14" style="display: none">package domain

import (
        "strings"
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/dokumentambahan/event"
        domainrenstra "UnpakSiamida/modules/renstra/domain"

        "github.com/google/uuid"
)

type DokumenTambahan struct {
        common.Entity

        ID                      uint      `gorm:"primaryKey;autoIncrement"`
        UUID                    uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Renstra                 uint      `gorm:"column:id_renstra;"`
        TemplateDokumenTambahan uint      `gorm:"column:id_template_dokumen_tambahan;"`
        Link                    *string   `gorm:"column:file"`
        CapaianAuditor          *string   `gorm:"column:capaian_auditor;"`
        CatatanAuditor          *string   `gorm:"column:catatan_auditor;"`
}

func (DokumenTambahan) TableName() string <span class="cov0" title="0">{
        return "dokumen_tambahan"
}</span>

func UpdateDokumenTambahan(
        prev *DokumenTambahan,
        renstra *domainrenstra.Renstra,
        Uuid uuid.UUID,
        UuidRenstra uuid.UUID,
        Tahun string,
        Mode string,
        Granted string,
        Link *string,
        CapaianAuditor *string,
        CatatanAuditor *string,
) common.ResultValue[*DokumenTambahan] <span class="cov0" title="0">{

        if renstra == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*DokumenTambahan](InvalidRenstra())
        }</span>

        <span class="cov0" title="0">if prev == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*DokumenTambahan](EmptyData())
        }</span>

        <span class="cov0" title="0">if prev.UUID != Uuid ||
                renstra.UUID != UuidRenstra ||
                renstra.Tahun != Tahun </span><span class="cov0" title="0">{
                return common.FailureValue[*DokumenTambahan](InvalidData())
        }</span>

        <span class="cov0" title="0">if !contains([]string{"auditee", "auditor2"}, Mode) </span><span class="cov0" title="0">{
                return common.FailureValue[*DokumenTambahan](RejectAction())
        }</span>

        <span class="cov0" title="0">if !IsGrantedAccess(Tahun, Mode, Granted) </span><span class="cov0" title="0">{
                return common.FailureValue[*DokumenTambahan](NotGranted())
        }</span>

        <span class="cov0" title="0">switch Mode </span>{
        case "auditee":<span class="cov0" title="0">
                prev.Link = Link</span>

        case "auditor2":<span class="cov0" title="0">
                prev.CapaianAuditor = CapaianAuditor
                prev.CatatanAuditor = CatatanAuditor</span>
        }

        <span class="cov0" title="0">prev.Raise(event.DokumenTambahanUpdatedEvent{ //[pr] ketika tersave maka buat kts
                EventID:             uuid.New(),
                OccurredOn:          time.Now().UTC(),
                DokumenTambahanUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}

func contains(list []string, value string) bool <span class="cov0" title="0">{
        for _, v := range list </span><span class="cov0" title="0">{
                if v == value </span><span class="cov0" title="0">{
                        return true
                }</span>
        }
        <span class="cov0" title="0">return false</span>
}

func IsGrantedAccess(tahun, mode, granted string) bool <span class="cov0" title="0">{
        requiredKey := tahun + "#" + mode

        grantedList := strings.Split(granted, ",")

        for _, g := range grantedList </span><span class="cov0" title="0">{
                if strings.TrimSpace(g) == requiredKey </span><span class="cov0" title="0">{
                        return true
                }</span>
        }

        <span class="cov0" title="0">return false</span>
}
</pre>
		
		<pre class="file" id="file15" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("DokumenTambahan.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("DokumenTambahan.InvalidUuid", "uuid is invalid")
}</span>

func InvalidRenstra() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("DokumenTambahan.InvalidRenstra", "renstra is invalid")
}</span>

func RejectAction() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("DokumenTambahan.RejectAction", "your action was rejected")
}</span>

func NotGranted() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("DokumenTambahan.NotGranted", "you are not granted permission in this action")
}</span>

func InvalidData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("DokumenTambahan.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("DokumenTambahan.NotFound", fmt.Sprintf("DokumenTambahan with identifier %s not found", id) )
}</span>
func NotFoundRenstra(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("DokumenTambahan.NotFoundRenstra", fmt.Sprintf("Renstra with identifier %s not found", id) )
}</span>
</pre>
		
		<pre class="file" id="file16" style="display: none">package application

import (
    "context"
    "time"
    domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
)

type GetAllFakultasUnitsQueryHandler struct {
    Repo domainfakultasunit.IFakultasUnitRepository
}

func (h *GetAllFakultasUnitsQueryHandler) Handle(
    ctx context.Context,
    q GetAllFakultasUnitsQuery,
) (domainfakultasunit.PagedFakultasUnits, error) <span class="cov0" title="0">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()
    
    fakultasunits, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domainfakultasunit.PagedFakultasUnits{}, err
    }</span>

    <span class="cov0" title="0">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov0" title="0">{
        currentPage = *q.Page
    }</span>
    <span class="cov0" title="0">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov0" title="0">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov0" title="0">return domainfakultasunit.PagedFakultasUnits{
        Data:  fakultasunits,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file17" style="display: none">package application

import (
    "context"

    domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetFakultasUnitByUuidQueryHandler struct {
    Repo domainfakultasunit.IFakultasUnitRepository
}

func (h *GetFakultasUnitByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetFakultasUnitByUuidQuery,
) (*domainfakultasunit.FakultasUnit, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domainfakultasunit.NotFound(q.Uuid)
        }</span>

    <span class="cov0" title="0">fakultasunit, err := h.Repo.GetDefaultByUuid(ctx, parsed)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domainfakultasunit.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov0" title="0">return fakultasunit, nil</span>
}
</pre>
		
		<pre class="file" id="file18" style="display: none">package application

import (
        "context"

        domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
)

type SetupUuidFakultasUnitCommandHandler struct {
        Repo domainfakultasunit.IFakultasUnitRepository
}

func (h *SetupUuidFakultasUnitCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidFakultasUnitCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file19" style="display: none">package domain

import (
        common "UnpakSiamida/common/domain"

        "github.com/google/uuid"
)

type FakultasUnit struct {
        common.Entity
        ID           uint       `gorm:""`
        UUID         uuid.UUID  `gorm:"type:char(36);"`
        Nama         string     `gorm:"column:nama_fak_prod_unit;"`
        KodeJenjang  string     `gorm:"column:kode_jenjang;"`
        Jenjang      string     `gorm:"column:jenjang;"`
        Type         string     `gorm:"column:type;"`
        Fakultas     string     `gorm:"column:fakultas;"`
}
func (FakultasUnit) TableName() string <span class="cov0" title="0">{
        return "v_fakultas_unit"
}</pre>
		
		<pre class="file" id="file20" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("FakultasUnit.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("FakultasUnit.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("FakultasUnit.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("FakultasUnit.NotFound", fmt.Sprintf("FakultasUnit with identifier %s not found", id))
}</span>
</pre>
		
		<pre class="file" id="file21" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        helper "UnpakSiamida/common/helper"
        event "UnpakSiamida/modules/generaterenstra/event"

        "github.com/google/uuid"
)

type GenerateDokumenTambahan struct {
        common.Entity

        ID                      uint      `gorm:"primaryKey;autoIncrement"`
        UUID                    uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        RenstraId               uint      `gorm:"column:id_renstra;"`
        TemplateDokumenTambahan uint      `gorm:"column:id_template_dokumen_tambahan;"`
        Tugas                   string    `gorm:""`
}

func (GenerateDokumenTambahan) TableName() string <span class="cov0" title="0">{
        return "dokumen_tambahan"
}</span>

func NewGenerateDokumenTambahan(
        tahun string, //tahun template
        renstraTahun string, //tahun renstra

        fakultasUnit uint, //fakunit template
        renstraFakultasUnit uint, //fakunit renstra

        renstraId uint,

        template uint,
        templateUuid string,
        jenisFile string,
        tugas string,
        operation string,
) common.ResultValue[*GenerateDokumenTambahan] <span class="cov0" title="0">{

        if renstraTahun != tahun </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateDokumenTambahan](InvalidTahunDokumenTambahan(templateUuid, jenisFile, tahun, renstraTahun, operation))
        }</span>
        <span class="cov0" title="0">if renstraFakultasUnit != fakultasUnit </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateDokumenTambahan](InvalidFakultasUnit())
        }</span>
        <span class="cov0" title="0">if template &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateDokumenTambahan](InvalidTemplate())
        }</span>
        <span class="cov0" title="0">if renstraId &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateDokumenTambahan](InvalidRenstra())
        }</span>
        <span class="cov0" title="0">if !helper.IsValidTugas(tugas) </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateDokumenTambahan](InvalidTugas())
        }</span>

        <span class="cov0" title="0">renstra := &amp;GenerateDokumenTambahan{
                UUID:                    uuid.New(),
                RenstraId:               renstraId,
                TemplateDokumenTambahan: template,
                Tugas:                   tugas,
        }

        renstra.Raise(event.GenerateDokumenTambahanCreatedEvent{
                EventID:                     uuid.New(),
                OccurredOn:                  time.Now().UTC(),
                GenerateDokumenTambahanUUID: renstra.UUID,
        })

        return common.SuccessValue(renstra)</span>
}
</pre>
		
		<pre class="file" id="file22" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        helper "UnpakSiamida/common/helper"
        event "UnpakSiamida/modules/generaterenstra/event"

        "github.com/google/uuid"
)

type GenerateRenstra struct {
        common.Entity

        ID              uint      `gorm:"primaryKey;autoIncrement"`
        UUID            uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        RenstraId       uint      `gorm:"column:id_renstra;"`
        TemplateRenstra uint      `gorm:"column:template_renstra;"`
        Tugas           string    `gorm:""`
}

func (GenerateRenstra) TableName() string <span class="cov0" title="0">{
        return "renstra_nilai"
}</span>

func NewGenerateRenstra(
        tahun string, //tahun template
        renstraTahun string, //tahun renstra

        fakultasUnit uint, //fakunit template
        renstraFakultasUnit uint, //fakunit renstra

        renstraId uint,

        template uint,
        templateUuid string,
        indikator string,
        tugas string,
        operation string,
) common.ResultValue[*GenerateRenstra] <span class="cov0" title="0">{

        if renstraTahun != tahun </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateRenstra](InvalidTahunRenstra(templateUuid, indikator, tahun, renstraTahun, operation))
        }</span>
        <span class="cov0" title="0">if renstraFakultasUnit != fakultasUnit </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateRenstra](InvalidFakultasUnit())
        }</span>
        <span class="cov0" title="0">if template &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateRenstra](InvalidTemplate())
        }</span>
        <span class="cov0" title="0">if renstraId &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateRenstra](InvalidRenstra())
        }</span>
        <span class="cov0" title="0">if !helper.IsValidTugas(tugas) </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateRenstra](InvalidTugas())
        }</span>

        <span class="cov0" title="0">renstra := &amp;GenerateRenstra{
                UUID:            uuid.New(),
                RenstraId:       renstraId,
                TemplateRenstra: template,
                Tugas:           tugas,
        }

        renstra.Raise(event.GenerateRenstraCreatedEvent{
                EventID:             uuid.New(),
                OccurredOn:          time.Now().UTC(),
                GenerateRenstraUUID: renstra.UUID,
        })

        return common.SuccessValue(renstra)</span>
}
</pre>
		
		<pre class="file" id="file23" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.NotFound", fmt.Sprintf("GenerateRenstra with identifier %s not found", id))
}</span>
func NotFoundFakultasUnit(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.NotFoundFakultasUnit", fmt.Sprintf("Fakultas unit with identifier %s not found", id))
}</span>
func NotFoundRenstra(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.NotFoundRenstra", fmt.Sprintf("renstra with identifier %s not found", id))
}</span>
func NotFoundTemplate(tahun string, fakultas string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.NotFoundTemplate", fmt.Sprintf("template not found with identifier tahun %s &amp; fakultas %s", tahun, fakultas))
}</span>
func NotFoundAudit(tahun string, fakultas string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.NotFoundAudit", fmt.Sprintf("previous audit not found with identifier tahun %s &amp; fakultas %s", tahun, fakultas))
}</span>

func InvalidFakultasUnit() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.InvalidFakultasUnit", "fakultas unit is invalid")
}</span>

func InvalidTahunRenstra(
        templateUuidExisting string,
        indikatorExisting string,
        tahunTemplateExisting string,
        tahun string,
        operation string,
) domain.Error <span class="cov0" title="0">{

        action := "rollback"
        if operation == "insert" </span><span class="cov0" title="0">{
                action = "generated"
        }</span>

        <span class="cov0" title="0">nextSugestion := "Please manually delete the problematic audit questions, then you can regenerate them."
        if operation == "insert" </span><span class="cov0" title="0">{
                nextSugestion = "Please check the year of the indicator question again, is it correct?"
        }</span>

        <span class="cov0" title="0">return domain.NotFoundError(
                "GenerateRenstra.InvalidTahunRenstra",
                fmt.Sprintf(
                        "template %s with indicator '%s (%s)' cannot be %s because the indicator year does not match the audit year (%s). %s",
                        templateUuidExisting,
                        indikatorExisting,
                        tahunTemplateExisting,
                        action,
                        tahun,
                        nextSugestion,
                ),
        )</span>
}

func InvalidTahunDokumenTambahan(
        templateUuidExisting string,
        jenisFileExisting string,
        tahunTemplateExisting string,
        tahun string,
        operation string,
) domain.Error <span class="cov0" title="0">{

        action := "rollback"
        if operation == "insert" </span><span class="cov0" title="0">{
                action = "generated"
        }</span>

        <span class="cov0" title="0">nextSugestion := "Please manually delete the problematic audit questions, then you can regenerate them."
        if operation == "insert" </span><span class="cov0" title="0">{
                nextSugestion = "Please check the year of the jenis file question again, is it correct?"
        }</span>

        <span class="cov0" title="0">return domain.NotFoundError(
                "GenerateRenstra.InvalidTahunDokumenTambahan",
                fmt.Sprintf(
                        "template %s with jenis file '%s (%s)' cannot be %s because the jenis file year does not match the audit year (%s). %s",
                        templateUuidExisting,
                        jenisFileExisting,
                        tahunTemplateExisting,
                        action,
                        tahun,
                        nextSugestion,
                ),
        )</span>
}

func InvalidTemplate() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.InvalidTemplate", "template is invalid")
}</span>

func InvalidRenstra() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.InvalidRenstra", "renstra is invalid")
}</span>

func InvalidType(tipe string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.InvalidType", fmt.Sprintf(
                "type %s is invalid",
                tipe,
        ))
}</span>

func InvalidTugas() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.InvalidTugas", "tugas is invalid")
}</span>

func InvalidParsing(target string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("GenerateRenstra.InvalidParsing", fmt.Sprintf("failed parsing %s to UUID", target))
}</span>
</pre>
		
		<pre class="file" id="file24" style="display: none">package application

import (
        "context"
        // "strconv"
        // "errors"
    // "gorm.io/gorm"
        "github.com/google/uuid"
        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
        domainstandarrenstra "UnpakSiamida/modules/standarrenstra/domain"
        // helper "UnpakSiamida/common/helper"
        "time"
)

type CreateIndikatorRenstraCommandHandler struct{
        Repo domainindikatorrenstra.IIndikatorRenstraRepository
        RepoStandarRenstra domainstandarrenstra.IStandarRenstraRepository
}

func (h *CreateIndikatorRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd CreateIndikatorRenstraCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        standarrenstraUUID, err := uuid.Parse(cmd.StandarRenstra)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainindikatorrenstra.InvalidParent()
        }</span>

        <span class="cov0" title="0">var standar *uint
        standarRenstra, err := h.RepoStandarRenstra.GetByUuid(ctx, standarrenstraUUID)
        if err != nil </span><span class="cov0" title="0">{
                standar = nil
        }</span> else<span class="cov0" title="0"> {
                standar = &amp;standarRenstra.ID
        }</span>

        <span class="cov0" title="0">var parentUUID uuid.UUID
        if cmd.Parent != nil &amp;&amp; *cmd.Parent != "" </span><span class="cov0" title="0">{
                parsed, err := uuid.Parse(*cmd.Parent)
                if err != nil </span><span class="cov0" title="0">{
                        parentUUID = uuid.Nil
                }</span> else<span class="cov0" title="0">{
                        parentUUID = parsed
                }</span>
        } else<span class="cov0" title="0"> {
                parentUUID = uuid.Nil
        }</span> 

        <span class="cov0" title="0">var parent *uint
        parentIndikator, err := h.Repo.GetDefaultByUuid(ctx, parentUUID)
        if err != nil </span><span class="cov0" title="0">{
                parent = nil
        }</span> else<span class="cov0" title="0"> {
                parent = &amp;parentIndikator.Id
        }</span>

        <span class="cov0" title="0">operator := cmd.Operator

        isUnique, err := h.Repo.IsUniqueIndikator(ctx, cmd.Indikator, cmd.Tahun)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">result := domainindikatorrenstra.NewIndikatorRenstra(
                cmd.Indikator,
                standar,
                parent,
                cmd.Tahun,
                cmd.TipeTarget,
                operator,
                isUnique,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov0" title="0">indikatorRenstra := result.Value

        if err := h.Repo.Create(ctx, indikatorRenstra); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return indikatorRenstra.UUID.String(), nil</span>
}</pre>
		
		<pre class="file" id="file25" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func CreateIndikatorRenstraCommandValidation(cmd CreateIndikatorRenstraCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,

                validation.Field(&amp;cmd.StandarRenstra,
                        validation.Required.Error("Standar Renstra wajib diisi"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Indikator,
                        validation.Required.Error("Indikator wajib diisi"),
                        validation.By(helper.ValidateUUIDv4),
                ),

                validation.Field(&amp;cmd.Parent,
                        validation.By(helper.ValidateParent),
                        validation.By(helper.ValidateUUIDv4),
                ),

                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun wajib diisi"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.TipeTarget,
                        validation.Required.Error("Tipe Target wajib diisi"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</span>
</pre>
		
		<pre class="file" id="file26" style="display: none">package application

import (
        "context"

        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
        "github.com/google/uuid"
        "time"
)

type DeleteIndikatorRenstraCommandHandler struct {
        Repo domainindikatorrenstra.IIndikatorRenstraRepository
}

func (h *DeleteIndikatorRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteIndikatorRenstraCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        indikatorrenstraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainindikatorrenstra.InvalidUuid()
        }</span>

        // Get existing indikatorrenstra
        <span class="cov0" title="0">existingIndikatorRenstra, err := h.Repo.GetByUuid(ctx, indikatorrenstraUUID)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>
        <span class="cov0" title="0">if existingIndikatorRenstra == nil </span><span class="cov0" title="0">{
                return "", domainindikatorrenstra.NotFound(cmd.Uuid)
        }</span>

        // Delete by UUID
        <span class="cov0" title="0">if err := h.Repo.Delete(ctx, indikatorrenstraUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov0" title="0">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file27" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func DeleteIndikatorRenstraCommandValidation(cmd DeleteIndikatorRenstraCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file28" style="display: none">package application

import (
    "context"
    domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
    "time"
)

type GetAllIndikatorRenstrasQueryHandler struct {
    Repo domainindikatorrenstra.IIndikatorRenstraRepository
}

func (h *GetAllIndikatorRenstrasQueryHandler) Handle(
    ctx context.Context,
    q GetAllIndikatorRenstrasQuery,
) (domainindikatorrenstra.PagedIndikatorRenstras, error) <span class="cov0" title="0">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    indikatorrenstras, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domainindikatorrenstra.PagedIndikatorRenstras{}, err
    }</span>

    <span class="cov0" title="0">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov0" title="0">{
        currentPage = *q.Page
    }</span>
    <span class="cov0" title="0">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov0" title="0">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov0" title="0">return domainindikatorrenstra.PagedIndikatorRenstras{
        Data:  indikatorrenstras,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file29" style="display: none">package application

import (
    "context"

    domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetIndikatorRenstraByUuidQueryHandler struct {
    Repo domainindikatorrenstra.IIndikatorRenstraRepository
}

func (h *GetIndikatorRenstraByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetIndikatorRenstraByUuidQuery,
) (*domainindikatorrenstra.IndikatorRenstra, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domainindikatorrenstra.NotFound(q.Uuid)
        }</span>

    <span class="cov0" title="0">inindikatorrenstra, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domainindikatorrenstra.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov0" title="0">return inindikatorrenstra, nil</span>
}
</pre>
		
		<pre class="file" id="file30" style="display: none">package application

import (
        "context"

        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
        "errors"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type GetIndikatorRenstraDefaultByUuidQueryHandler struct {
        Repo domainindikatorrenstra.IIndikatorRenstraRepository
}

func (h *GetIndikatorRenstraDefaultByUuidQueryHandler) Handle(
        ctx context.Context,
        q GetIndikatorRenstraDefaultByUuidQuery,
) (*domainindikatorrenstra.IndikatorRenstraDefault, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

        parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domainindikatorrenstra.NotFound(q.Uuid)
        }</span>

        <span class="cov0" title="0">inindikatorrenstra, err := h.Repo.GetDefaultByUuid(ctx, parsed)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domainindikatorrenstra.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

        <span class="cov0" title="0">return inindikatorrenstra, nil</span>
}
</pre>
		
		<pre class="file" id="file31" style="display: none">package application

import (
        "context"

        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
)

type SetupUuidIndikatorRenstraCommandHandler struct {
        Repo domainindikatorrenstra.IIndikatorRenstraRepository
}

func (h *SetupUuidIndikatorRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidIndikatorRenstraCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file32" style="display: none">package application

import (
        "context"
        // "strconv"
        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
        domainstandarrenstra "UnpakSiamida/modules/standarrenstra/domain"
        // helper "UnpakSiamida/common/helper"
        "github.com/google/uuid"
        // "errors"
    // "gorm.io/gorm"
        "time"
)

type UpdateIndikatorRenstraCommandHandler struct {
        Repo domainindikatorrenstra.IIndikatorRenstraRepository
        RepoStandarRenstra domainstandarrenstra.IStandarRenstraRepository
}

func (h *UpdateIndikatorRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateIndikatorRenstraCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        indikatorrenstraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainindikatorrenstra.InvalidUuid()
        }</span>

        <span class="cov0" title="0">existingIndikatorRenstra, err := h.Repo.GetByUuid(ctx, indikatorrenstraUUID) // â† memastikan pakai nama interface yg benar
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>
        <span class="cov0" title="0">if existingIndikatorRenstra == nil </span><span class="cov0" title="0">{
                return "", domainindikatorrenstra.NotFound(cmd.Uuid)
        }</span>

        <span class="cov0" title="0">standarrenstraUUID, err := uuid.Parse(cmd.StandarRenstra)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainindikatorrenstra.InvalidParent()
        }</span>

        <span class="cov0" title="0">var standar *uint
        standarRenstra, err := h.RepoStandarRenstra.GetByUuid(ctx, standarrenstraUUID)
        if err != nil </span><span class="cov0" title="0">{
                standar = nil
        }</span> else<span class="cov0" title="0"> {
                standar = &amp;standarRenstra.ID
        }</span>

        <span class="cov0" title="0">var parentUUID uuid.UUID
        if cmd.Parent != nil &amp;&amp; *cmd.Parent != "" </span><span class="cov0" title="0">{
                parsed, err := uuid.Parse(*cmd.Parent)
                if err != nil </span><span class="cov0" title="0">{
                        parentUUID = uuid.Nil
                }</span> else<span class="cov0" title="0">{
                        parentUUID = parsed
                }</span>
        } else<span class="cov0" title="0"> {
                parentUUID = uuid.Nil
        }</span> 

        <span class="cov0" title="0">var parent *uint
        parentIndikator, err := h.Repo.GetDefaultByUuid(ctx, parentUUID)
        if err != nil </span><span class="cov0" title="0">{
                parent = nil
        }</span> else<span class="cov0" title="0"> {
                parent = &amp;parentIndikator.Id
        }</span>

        // -------------------------
        // AGGREGATE ROOT LOGIC
        // -------------------------
        <span class="cov0" title="0">result := domainindikatorrenstra.UpdateIndikatorRenstra(
                existingIndikatorRenstra,
                indikatorrenstraUUID,
                cmd.Indikator,
                standar,
                parent,
                cmd.Tahun,
                cmd.TipeTarget,
                cmd.Operator,
                // isUnique,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov0" title="0">updatedIndikatorRenstra := result.Value

        // -------------------------
        // SAVE TO REPOSITORY
        // -------------------------
        if err := h.Repo.Update(ctx, updatedIndikatorRenstra); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return updatedIndikatorRenstra.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file33" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func UpdateIndikatorRenstraCommandValidation(cmd UpdateIndikatorRenstraCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.StandarRenstra,
                        validation.Required.Error("Standar Renstra wajib diisi"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Indikator,
                        validation.Required.Error("Indikator wajib diisi"),
                        validation.By(helper.ValidateUUIDv4),
                ),

                validation.Field(&amp;cmd.Parent,
                        validation.By(helper.ValidateParent),
                        validation.By(helper.ValidateUUIDv4),
                ),

                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun wajib diisi"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.TipeTarget,
                        validation.Required.Error("Tipe Target wajib diisi"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file34" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/indikatorrenstra/event"

        "github.com/google/uuid"
)

type IndikatorRenstra struct {
        common.Entity

        ID             uint      `gorm:"primaryKey;autoIncrement"`
        UUID           uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        StandarRenstra *uint     `gorm:"column:id_master_standar;"`
        Indikator      string    `gorm:"type:longtext;not null"`
        Parent         *uint     `gorm:""`
        Tahun          string    `gorm:"size:255;not null"`
        TipeTarget     string    `gorm:"size:255;not null"`
        Operator       *string   `gorm:""`
}

func (IndikatorRenstra) TableName() string <span class="cov0" title="0">{
        return "master_indikator_renstra"
}</span>

func NewIndikatorRenstra(
        indikator string,
        standar *uint,
        parent *uint,
        tahun string,
        tipeTarget string,
        operator *string,
        isUniqueIndikator bool,
) common.ResultValue[*IndikatorRenstra] <span class="cov0" title="0">{

        if standar == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*IndikatorRenstra](InvalidStandar())
        }</span>

        <span class="cov0" title="0">if !isUniqueIndikator </span><span class="cov0" title="0">{
                return common.FailureValue[*IndikatorRenstra](NotUniqueIndikator())
        }</span>

        <span class="cov0" title="0">ir := &amp;IndikatorRenstra{
                UUID:           uuid.New(),
                Indikator:      indikator,
                StandarRenstra: standar,
                Parent:         parent,
                Tahun:          tahun,
                TipeTarget:     tipeTarget,
                Operator:       operator,
        }

        ir.Raise(event.IndikatorRenstraCreatedEvent{
                EventID:              uuid.New(),
                OccurredOn:           time.Now().UTC(),
                IndikatorRenstraUUID: ir.UUID,
        })

        return common.SuccessValue(ir)</span>
}

func UpdateIndikatorRenstra(
        prev *IndikatorRenstra,
        uid uuid.UUID,
        indikator string,
        standar *uint,
        parent *uint,
        tahun string,
        tipeTarget string,
        operator *string,
        // isUniqueIndikator bool,
) common.ResultValue[*IndikatorRenstra] <span class="cov0" title="0">{

        if standar == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*IndikatorRenstra](InvalidStandar())
        }</span>

        // if !isUniqueIndikator {
        //         return common.FailureValue[*IndikatorRenstra](NotUniqueIndikator())
        // }

        <span class="cov0" title="0">if prev == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*IndikatorRenstra](EmptyData())
        }</span>

        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*IndikatorRenstra](InvalidData())
        }</span>

        // always overwrite (required field)
        <span class="cov0" title="0">prev.Indikator = indikator
        prev.Tahun = tahun
        prev.TipeTarget = tipeTarget

        // optional pointer fields updated only if not nil
        prev.StandarRenstra = standar

        if parent != nil </span><span class="cov0" title="0">{
                prev.Parent = parent
        }</span>

        <span class="cov0" title="0">if operator != nil </span><span class="cov0" title="0">{
                prev.Operator = operator
        }</span>

        <span class="cov0" title="0">prev.Raise(event.IndikatorRenstraUpdatedEvent{
                EventID:              uuid.New(),
                OccurredOn:           time.Now().UTC(),
                IndikatorRenstraUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file35" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("IndikatorRenstra.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("IndikatorRenstra.InvalidUuid", "uuid is invalid")
}</span>

func InvalidStandar() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("IndikatorRenstra.InvalidStandar", "standar renstra is invalid")
}</span>

func InvalidParent() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("IndikatorRenstra.InvalidParent", "parent is invalid")
}</span>

func NotFoundParent(parent string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("IndikatorRenstra.InvalidParent", fmt.Sprintf("Parent with identifier %s not found", parent))
}</span>

func NotUniqueIndikator() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("IndikatorRenstra.NotUniqueIndikator", "indikator is not unique")
}</span>

func InvalidData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("IndikatorRenstra.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("IndikatorRenstra.NotFound", fmt.Sprintf("IndikatorRenstra with identifier %s not found", id) )
}</span>
</pre>
		
		<pre class="file" id="file36" style="display: none">package application

import (
        "context"
        
        domainjenisfile "UnpakSiamida/modules/jenisfile/domain"
        "time"
)

type CreateJenisFileCommandHandler struct{
        Repo domainjenisfile.IJenisFileRepository
}

func (h *CreateJenisFileCommandHandler) Handle(
        ctx context.Context,
        cmd CreateJenisFileCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        result := domainjenisfile.NewJenisFile(
                cmd.Nama,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov0" title="0">createJenisFile := result.Value
        if err := h.Repo.Create(ctx, createJenisFile); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return result.Value.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file37" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func CreateJenisFileCommandValidation(cmd CreateJenisFileCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Nama,
                        validation.Required.Error("Nama cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file38" style="display: none">package application

import (
        "context"

        domainjenisfile "UnpakSiamida/modules/jenisfile/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type DeleteJenisFileCommandHandler struct {
        Repo domainjenisfile.IJenisFileRepository
}

func (h *DeleteJenisFileCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteJenisFileCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        jenisfileUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainjenisfile.InvalidUuid()
        }</span>

        // Get existing jenisfile
        <span class="cov0" title="0">_, err = h.Repo.GetByUuid(ctx, jenisfileUUID)
        if err != nil </span><span class="cov0" title="0">{
                if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                        return "", domainjenisfile.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // Delete by UUID
        <span class="cov0" title="0">if err := h.Repo.Delete(ctx, jenisfileUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov0" title="0">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file39" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func DeleteJenisFileCommandValidation(cmd DeleteJenisFileCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file40" style="display: none">package application

import (
    "context"
    domainJenisFile "UnpakSiamida/modules/jenisfile/domain"
    "time"
)

type GetAllJenisFilesQueryHandler struct {
    Repo domainJenisFile.IJenisFileRepository
}

func (h *GetAllJenisFilesQueryHandler) Handle(
    ctx context.Context,
    q GetAllJenisFilesQuery,
) (domainJenisFile.PagedJenisFiles, error) <span class="cov0" title="0">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    JenisFiles, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domainJenisFile.PagedJenisFiles{}, err
    }</span>

    <span class="cov0" title="0">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov0" title="0">{
        currentPage = *q.Page
    }</span>
    <span class="cov0" title="0">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov0" title="0">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov0" title="0">return domainJenisFile.PagedJenisFiles{
        Data:  JenisFiles,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file41" style="display: none">package application

import (
    "context"

    domainJenisFile "UnpakSiamida/modules/jenisfile/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetJenisFileByUuidQueryHandler struct {
    Repo domainJenisFile.IJenisFileRepository
}

func (h *GetJenisFileByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetJenisFileByUuidQuery,
) (*domainJenisFile.JenisFile, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domainJenisFile.NotFound(q.Uuid)
        }</span>

    <span class="cov0" title="0">inJenisFile, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domainJenisFile.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov0" title="0">return inJenisFile, nil</span>
}
</pre>
		
		<pre class="file" id="file42" style="display: none">package application

import (
    "context"

    domainJenisFile "UnpakSiamida/modules/jenisfile/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetJenisFileDefaultByUuidQueryHandler struct {
    Repo domainJenisFile.IJenisFileRepository
}

func (h *GetJenisFileDefaultByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetJenisFileDefaultByUuidQuery,
) (*domainJenisFile.JenisFileDefault, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domainJenisFile.NotFound(q.Uuid)
        }</span>

    <span class="cov0" title="0">JenisFile, err := h.Repo.GetDefaultByUuid(ctx, parsed)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domainJenisFile.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov0" title="0">return JenisFile, nil</span>
}
</pre>
		
		<pre class="file" id="file43" style="display: none">package application

import (
        "context"

        domainjenisfile "UnpakSiamida/modules/jenisfile/domain"
)

type SetupUuidJenisFileCommandHandler struct {
        Repo domainjenisfile.IJenisFileRepository
}

func (h *SetupUuidJenisFileCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidJenisFileCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file44" style="display: none">package application

import (
        "context"

        domainjenisfile "UnpakSiamida/modules/jenisfile/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type UpdateJenisFileCommandHandler struct {
        Repo domainjenisfile.IJenisFileRepository
}

func (h *UpdateJenisFileCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateJenisFileCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // -------------------------
        // VALIDATE UUID
        // -------------------------
        jenisfileUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainjenisfile.InvalidUuid()
        }</span>

        // -------------------------
        // GET EXISTING jenisfile
        // -------------------------
        <span class="cov0" title="0">existingJenisFile, err := h.Repo.GetByUuid(ctx, jenisfileUUID) // â† memastikan pakai nama interface yg benar
        if err != nil </span><span class="cov0" title="0">{
                if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                        return "", domainjenisfile.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // -------------------------
        // AGGREGATE ROOT LOGIC
        // -------------------------
        <span class="cov0" title="0">result := domainjenisfile.UpdateJenisFile(
                existingJenisFile,
                jenisfileUUID,
                cmd.Nama,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov0" title="0">updatedJenisFile := result.Value

        // -------------------------
        // SAVE TO REPOSITORY
        // -------------------------
        if err := h.Repo.Update(ctx, updatedJenisFile); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return updatedJenisFile.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file45" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func UpdateJenisFileCommandValidation(cmd UpdateJenisFileCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Nama,
                        validation.Required.Error("Nama cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file46" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/jenisfile/event"

        "github.com/google/uuid"
)

type JenisFile struct {
        common.Entity

        ID   uint      `gorm:"primaryKey;autoIncrement"`
        UUID uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Nama string    `gorm:"type:longtext;not null"`
}

func (JenisFile) TableName() string <span class="cov0" title="0">{
        return "jenis_file_renstra"
}</span>

// === CREATE ===
func NewJenisFile(nama string) common.ResultValue[*JenisFile] <span class="cov0" title="0">{

        jenisfile := &amp;JenisFile{
                UUID: uuid.New(),
                Nama: nama,
        }

        jenisfile.Raise(event.JenisFileCreatedEvent{
                EventID:       uuid.New(),
                OccurredOn:    time.Now().UTC(),
                JenisFileUUID: jenisfile.UUID,
        })

        return common.SuccessValue(jenisfile)
}</span>

// === UPDATE ===
func UpdateJenisFile(
        prev *JenisFile,
        uid uuid.UUID,
        nama string,
) common.ResultValue[*JenisFile] <span class="cov0" title="0">{

        if prev == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*JenisFile](EmptyData())
        }</span>

        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*JenisFile](InvalidData())
        }</span>

        <span class="cov0" title="0">prev.Nama = nama

        prev.Raise(event.JenisFileUpdatedEvent{
                EventID:       uuid.New(),
                OccurredOn:    time.Now().UTC(),
                JenisFileUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file47" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("JenisFile.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("JenisFile.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("JenisFile.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("JenisFile.NotFound", fmt.Sprintf("JenisFile with identifier %s not found", id) )
}</pre>
		
		<pre class="file" id="file48" style="display: none">package domain

import (
        "errors"
        "strconv"
        "strings"
        "time"

        // "github.com/goforj/godump"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/kts/event"

        "github.com/google/uuid"
)

type Kts struct {
        common.Entity

        ID   uint      `gorm:"primaryKey;autoIncrement"`
        UUID uuid.UUID `gorm:"type:char(36);uniqueIndex"`

        RenstraNilai    *uint  `gorm:"column:id_renstra_nilai"`
        DokumenTambahan *uint  `gorm:"column:id_dokumen_tambahan"`
        Status          string `gorm:"column:status"`

        // auditor
        NomorLaporan     *string    `gorm:"column:nomor_laporan"`
        TanggalLaporan   *time.Time `gorm:"column:tanggal_laporan;type:date"`
        Auditor          *string    `gorm:"column:auditor"`
        KetidaksesuaianP *string    `gorm:"column:uraian_ketidaksesuaian_p"`
        KetidaksesuaianL *string    `gorm:"column:uraian_ketidaksesuaian_l"`
        KetidaksesuaianO *string    `gorm:"column:uraian_ketidaksesuaian_o"`
        KetidaksesuaianR *string    `gorm:"column:uraian_ketidaksesuaian_r"`
        AkarMasalah      *string    `gorm:"column:akar_masalah"`
        TindakanKoreksi  *string    `gorm:"column:tindakan_koreksi"`
        AccAuditor       *uint      `gorm:"column:acc_auditor"`

        // auditee
        StatusAccAuditee  *uint   `gorm:"column:status_acc_auditee"`
        AccAuditee        *uint   `gorm:"column:acc_auditee"`
        KeteranganTolak   *string `gorm:"column:keterangan_tolak_auditee"`
        TindakanPerbaikan *string `gorm:"column:tindakan_perbaikan"`

        // auditor
        TanggalPenyelesaian *time.Time `gorm:"column:tanggal_penyelesaian;type:date"`

        // auditee
        TinjauanTindakanPerbaikan *string    `gorm:"column:tinjauan_tindakan_perbaikan"`
        TanggalClosing            *time.Time `gorm:"column:tanggal_closing_auditee;type:date"`
        AccFinal                  *uint      `gorm:"column:acc_auditor_final"`

        // auditor
        TanggalClosingFinal *time.Time `gorm:"column:tanggal_closing;type:date"`
        WmmUpmfUpmps        *string    `gorm:"column:wmm_upmf_upmps"`
        ClosingBy           *uint      `gorm:"column:closingBy"`
}

func (Kts) TableName() string <span class="cov0" title="0">{
        return "kts_renstra"
}</span>

// === CREATE ===
// [pr] belum dipakai
func NewKtsRenstra(
        auditor *string,
        renstraNilai *uint,
        templateRenstra *uint,
        standar *string,
        indikator *string,
        tahun string,
        idTarget uint,
        target string,
        isDataExist bool,
) common.ResultValue[*Kts] <span class="cov0" title="0">{
        if isDataExist </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](ExistData())
        }</span>

        <span class="cov0" title="0">kts := &amp;Kts{
                UUID:         uuid.New(),
                RenstraNilai: renstraNilai,
                Auditor:      auditor,
                Status:       "draf",
        }

        kts.Raise(event.KtsCreatedEvent{
                EventID:         uuid.New(),
                OccurredOn:      time.Now().UTC(),
                KtsUUID:         kts.UUID,
                TemplateRenstra: templateRenstra,
                Standar:         standar,
                Indikator:       indikator,
                Tahun:           tahun,
                IdTarget:        idTarget,
                Target:          target,
        })

        return common.SuccessValue(kts)</span>
}

// [pr] belum dipakai
func NewKtsDokumen(
        auditor *string,
        dokumenTambahan *uint,
        templateDokumen *uint,
        pertanyaan *string,
        jenisFile *string,
        tahun string,
        idTarget uint,
        target string,
        isDataExist bool,
) common.ResultValue[*Kts] <span class="cov0" title="0">{
        if isDataExist </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](ExistData())
        }</span>

        <span class="cov0" title="0">kts := &amp;Kts{
                UUID:            uuid.New(),
                DokumenTambahan: dokumenTambahan,
                Auditor:         auditor,
                Status:          "draf",
        }

        kts.Raise(event.KtsCreatedEvent{
                EventID:         uuid.New(),
                OccurredOn:      time.Now().UTC(),
                KtsUUID:         kts.UUID,
                TemplateDokumen: templateDokumen,
                Pertanyaan:      pertanyaan,
                JenisFile:       jenisFile,
                Tahun:           tahun,
                IdTarget:        idTarget,
                Target:          target,
                Status:          "draf",
        })

        return common.SuccessValue(kts)</span>
}

//
// ======================= UPDATE STEP 1 =======================
//

func UpdateKtsStep1(
        prev *Kts,
        prevKts *KtsDefault,
        uid uuid.UUID,
        nomorLaporan string,
        tanggalLaporan string,
        ketidaksesuaianP string,
        ketidaksesuaianL string,
        ketidaksesuaianO string,
        ketidaksesuaianR string,
        akarMasalah string,
        tindakanKoreksi string,
        accAuditor uint,
        tahun string,
) common.ResultValue[*Kts] <span class="cov0" title="0">{

        if prev == nil || prevKts == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](EmptyData())
        }</span>
        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidData())
        }</span>
        <span class="cov0" title="0">if prevKts.Tahun == nil || *prevKts.Tahun != tahun </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidTahun())
        }</span>
        <span class="cov0" title="0">if accAuditor == 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidAuditor())
        }</span>
        <span class="cov0" title="0">if strings.TrimSpace(nomorLaporan) == "" </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](RequiredNomorLaporan())
        }</span>

        <span class="cov0" title="0">tgl, err := ParseDatePtr(tanggalLaporan)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidTanggal())
        }</span>

        <span class="cov0" title="0">prev.NomorLaporan = StringPtr(nomorLaporan)
        prev.TanggalLaporan = tgl
        prev.KetidaksesuaianP = StringPtr(ketidaksesuaianP)
        prev.KetidaksesuaianL = StringPtr(ketidaksesuaianL)
        prev.KetidaksesuaianO = StringPtr(ketidaksesuaianO)
        prev.KetidaksesuaianR = StringPtr(ketidaksesuaianR)
        prev.AkarMasalah = StringPtr(akarMasalah)
        prev.TindakanKoreksi = StringPtr(tindakanKoreksi)
        prev.AccAuditor = UintPtr(accAuditor)
        prev.Status = "menunggu_verif_auditee"

        if prev.DokumenTambahan != nil </span><span class="cov0" title="0">{
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prev.UUID,
                        TemplateDokumen: prevKts.DokumenTambahan,
                        Pertanyaan:      prevKts.Pertanyaan,
                        JenisFileId:     prevKts.JenisFileId,
                        JenisFile:       prevKts.JenisFile,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     StringPtr(nomorLaporan),
                        TanggalLaporan:   TimeToStringPtr(prev.TanggalLaporan),
                        KetidaksesuaianP: StringPtr(ketidaksesuaianP),
                        KetidaksesuaianL: StringPtr(ketidaksesuaianL),
                        KetidaksesuaianO: StringPtr(ketidaksesuaianO),
                        KetidaksesuaianR: StringPtr(ketidaksesuaianR),
                        AkarMasalah:      StringPtr(akarMasalah),
                        TindakanKoreksi:  StringPtr(tindakanKoreksi),
                        Status:           StringPtr("menunggu_verif_auditee"),
                })
        }</span> else<span class="cov0" title="0"> {
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prevKts.UUID,
                        TemplateRenstra: prevKts.TemplateRenstra,
                        StandarId:       prevKts.StandarId,
                        Standar:         prevKts.Standar,
                        IndikatorId:     prevKts.IndikatorId,
                        Indikator:       prevKts.Indikator,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     StringPtr(nomorLaporan),
                        TanggalLaporan:   TimeToStringPtr(prev.TanggalLaporan),
                        KetidaksesuaianP: StringPtr(ketidaksesuaianP),
                        KetidaksesuaianL: StringPtr(ketidaksesuaianL),
                        KetidaksesuaianO: StringPtr(ketidaksesuaianO),
                        KetidaksesuaianR: StringPtr(ketidaksesuaianR),
                        AkarMasalah:      StringPtr(akarMasalah),
                        TindakanKoreksi:  StringPtr(tindakanKoreksi),
                        Status:           StringPtr("menunggu_verif_auditee"),
                })
        }</span>

        <span class="cov0" title="0">return common.SuccessValue(prev)</span>
}

//
// ======================= UPDATE STEP 2 =======================
//

func UpdateKtsStep2(
        prev *Kts,
        prevKts *KtsDefault,
        uid uuid.UUID,
        statusAccAuditee uint,
        accAuditee uint,
        keteranganTolak *string,
        tindakanPerbaikan *string,
        tahun string,
) common.ResultValue[*Kts] <span class="cov0" title="0">{

        if prev == nil || prevKts == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](EmptyData())
        }</span>
        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidData())
        }</span>
        <span class="cov0" title="0">if prevKts.Tahun == nil || *prevKts.Tahun != tahun </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidTahun())
        }</span>
        <span class="cov0" title="0">if accAuditee == 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidAuditee())
        }</span>
        <span class="cov0" title="0">if statusAccAuditee &gt; 1 </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidStatusAcc())
        }</span>
        <span class="cov0" title="0">if statusAccAuditee == 0 &amp;&amp; (keteranganTolak == nil || strings.TrimSpace(*keteranganTolak) == "") </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](RequiredKeteranganTolak())
        }</span>

        <span class="cov0" title="0">prev.StatusAccAuditee = UintPtr(statusAccAuditee)
        prev.AccAuditee = UintPtr(accAuditee)
        prev.KeteranganTolak = keteranganTolak
        prev.TindakanPerbaikan = tindakanPerbaikan
        if statusAccAuditee == 1 </span><span class="cov0" title="0">{
                prev.Status = "terima_auditee"
        }</span> else<span class="cov0" title="0"> {
                prev.Status = "tolak_auditee"
        }</span>

        <span class="cov0" title="0">if prev.DokumenTambahan != nil </span><span class="cov0" title="0">{
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prev.UUID,
                        TemplateDokumen: prevKts.DokumenTambahan,
                        Pertanyaan:      prevKts.Pertanyaan,
                        JenisFile:       prevKts.JenisFile,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        Status: StringPtr(prev.Status),
                })
        }</span> else<span class="cov0" title="0"> {
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prevKts.UUID,
                        TemplateRenstra: prevKts.TemplateRenstra,
                        StandarId:       prevKts.StandarId,
                        Standar:         prevKts.Standar,
                        IndikatorId:     prevKts.IndikatorId,
                        Indikator:       prevKts.Indikator,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        Status: StringPtr(prev.Status),
                })
        }</span>

        <span class="cov0" title="0">return common.SuccessValue(prev)</span>
}

func UpdateKtsTindakan(
        prev *Kts,
        prevKts *KtsDefault,
        uid uuid.UUID,
        tindakanPerbaikan string,
        tahun string,
) common.ResultValue[*Kts] <span class="cov0" title="0">{

        if prev == nil || prevKts == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](EmptyData())
        }</span>
        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidData())
        }</span>
        <span class="cov0" title="0">if prevKts.Tahun == nil || *prevKts.Tahun != tahun </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidTahun())
        }</span>

        <span class="cov0" title="0">prev.TindakanPerbaikan = StringPtr(tindakanPerbaikan)

        if prev.DokumenTambahan != nil </span><span class="cov0" title="0">{
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prev.UUID,
                        TemplateDokumen: prevKts.DokumenTambahan,
                        Pertanyaan:      prevKts.Pertanyaan,
                        JenisFile:       prevKts.JenisFile,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: StringPtr(tindakanPerbaikan),
                        Status:            StringPtr(prevKts.Status),
                })
        }</span> else<span class="cov0" title="0"> {
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prevKts.UUID,
                        TemplateRenstra: prevKts.TemplateRenstra,
                        StandarId:       prevKts.StandarId,
                        Standar:         prevKts.Standar,
                        IndikatorId:     prevKts.IndikatorId,
                        Indikator:       prevKts.Indikator,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: StringPtr(tindakanPerbaikan),
                        Status:            StringPtr(prevKts.Status),
                })
        }</span>

        <span class="cov0" title="0">return common.SuccessValue(prev)</span>
}

//
// ======================= UPDATE STEP 3 =======================
//

func UpdateKtsStep3(
        prev *Kts,
        prevKts *KtsDefault,
        uid uuid.UUID,
        accAuditor uint,
        tanggalPenyelesaian string,
        tahun string,
) common.ResultValue[*Kts] <span class="cov0" title="0">{

        if prev == nil || prevKts == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](EmptyData())
        }</span>
        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidData())
        }</span>
        <span class="cov0" title="0">if prevKts.Tahun == nil || *prevKts.Tahun != tahun </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidTahun())
        }</span>
        <span class="cov0" title="0">if accAuditor == 0 || prevKts.Auditor == nil || *prevKts.Auditor != strconv.FormatUint(uint64(accAuditor), 10) </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidAuditor())
        }</span>

        <span class="cov0" title="0">tgl, err := ParseDatePtr(tanggalPenyelesaian)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidTanggal())
        }</span>

        <span class="cov0" title="0">prev.TanggalPenyelesaian = tgl
        prev.Status = "menunggu_closing_auditor"

        if prev.DokumenTambahan != nil </span><span class="cov0" title="0">{
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prev.UUID,
                        TemplateDokumen: prevKts.DokumenTambahan,
                        Pertanyaan:      prevKts.Pertanyaan,
                        JenisFile:       prevKts.JenisFile,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        TanggalPenyelesaian: TimeToStringPtr(prev.TanggalPenyelesaian),
                        Status:              StringPtr("menunggu_closing_auditor"),
                })
        }</span> else<span class="cov0" title="0"> {
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prevKts.UUID,
                        TemplateRenstra: prevKts.TemplateRenstra,
                        StandarId:       prevKts.StandarId,
                        Standar:         prevKts.Standar,
                        IndikatorId:     prevKts.IndikatorId,
                        Indikator:       prevKts.Indikator,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        TanggalPenyelesaian: TimeToStringPtr(prev.TanggalPenyelesaian),
                        Status:              StringPtr("menunggu_closing_auditor"),
                })
        }</span>

        <span class="cov0" title="0">return common.SuccessValue(prev)</span>
}

//
// ======================= UPDATE STEP 4 =======================
//

func UpdateKtsStep4(
        prev *Kts,
        prevKts *KtsDefault,
        uid uuid.UUID,
        tinjauan string,
        tanggalClosing string,
        accFinal uint,
        tahun string,
) common.ResultValue[*Kts] <span class="cov0" title="0">{

        if prev == nil || prevKts == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](EmptyData())
        }</span>
        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidData())
        }</span>
        <span class="cov0" title="0">if prevKts.Tahun == nil || *prevKts.Tahun != tahun </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidTahun())
        }</span>
        <span class="cov0" title="0">if accFinal == 0 || prevKts.Auditee == nil || *prevKts.Auditee != strconv.FormatUint(uint64(accFinal), 10) </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidAuditee())
        }</span>

        <span class="cov0" title="0">tgl, err := ParseDatePtr(tanggalClosing)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidTanggal())
        }</span>

        <span class="cov0" title="0">prev.TinjauanTindakanPerbaikan = StringPtr(tinjauan)
        prev.TanggalClosing = tgl
        prev.AccFinal = UintPtr(accFinal)
        prev.Status = "closing_auditor"

        if prev.DokumenTambahan != nil </span><span class="cov0" title="0">{
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prev.UUID,
                        TemplateDokumen: prevKts.DokumenTambahan,
                        Pertanyaan:      prevKts.Pertanyaan,
                        JenisFile:       prevKts.JenisFile,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        TanggalPenyelesaian: TimeToStringPtr(prev.TanggalPenyelesaian),

                        TanggalClosing: TimeToStringPtr(prev.TanggalClosing),
                        Status:         StringPtr("closing_auditor"),
                })
        }</span> else<span class="cov0" title="0"> {
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prevKts.UUID,
                        TemplateRenstra: prevKts.TemplateRenstra,
                        StandarId:       prevKts.StandarId,
                        Standar:         prevKts.Standar,
                        IndikatorId:     prevKts.IndikatorId,
                        Indikator:       prevKts.Indikator,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        TanggalPenyelesaian: TimeToStringPtr(prev.TanggalPenyelesaian),

                        TanggalClosing: TimeToStringPtr(prev.TanggalClosing),
                        Status:         StringPtr("closing_auditor"),
                })
        }</span>

        <span class="cov0" title="0">return common.SuccessValue(prev)</span>
}

//
// ======================= UPDATE STEP 5 =======================
//

func UpdateKtsStep5(
        prev *Kts,
        prevKts *KtsDefault,
        uid uuid.UUID,
        tanggalClosingFinal string,
        wmmUpmfUpmps string,
        closingBy uint,
        tahun string,
) common.ResultValue[*Kts] <span class="cov0" title="0">{
        if prev == nil || prevKts == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](EmptyData())
        }</span>
        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidData())
        }</span>
        <span class="cov0" title="0">if prevKts.Tahun == nil || *prevKts.Tahun != tahun </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidTahun())
        }</span>
        <span class="cov0" title="0">if closingBy == 0 || prevKts.Auditor == nil || *prevKts.Auditor != strconv.FormatUint(uint64(closingBy), 10) </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidAuditor())
        }</span>

        <span class="cov0" title="0">tgl, err := ParseDatePtr(tanggalClosingFinal)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Kts](InvalidTanggal())
        }</span>

        <span class="cov0" title="0">prev.TanggalClosingFinal = tgl
        prev.WmmUpmfUpmps = StringPtr(wmmUpmfUpmps)
        prev.ClosingBy = UintPtr(closingBy)
        prev.Status = "tutup_kts"

        if prev.DokumenTambahan != nil </span><span class="cov0" title="0">{
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prev.UUID,
                        TemplateDokumen: prevKts.DokumenTambahan,
                        Pertanyaan:      prevKts.Pertanyaan,
                        JenisFile:       prevKts.JenisFile,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        TanggalPenyelesaian: TimeToStringPtr(prev.TanggalPenyelesaian),

                        TanggalClosing: TimeToStringPtr(prev.TanggalClosing),

                        TanggalClosingFinal: TimeToStringPtr(prev.TanggalClosingFinal),
                        WmmUpmfUpmps:        StringPtr(wmmUpmfUpmps),
                        Status:              StringPtr("tutup_kts"),
                })
        }</span> else<span class="cov0" title="0"> {
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prevKts.UUID,
                        TemplateRenstra: prevKts.TemplateRenstra,
                        StandarId:       prevKts.StandarId,
                        Standar:         prevKts.Standar,
                        IndikatorId:     prevKts.IndikatorId,
                        Indikator:       prevKts.Indikator,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        TanggalPenyelesaian: TimeToStringPtr(prev.TanggalPenyelesaian),

                        TanggalClosing: TimeToStringPtr(prev.TanggalClosing),

                        TanggalClosingFinal: TimeToStringPtr(prev.TanggalClosingFinal),
                        WmmUpmfUpmps:        StringPtr(wmmUpmfUpmps),
                        Status:              StringPtr("tutup_kts"),
                })
        }</span>

        <span class="cov0" title="0">return common.SuccessValue(prev)</span>
}

//
// ======================= HELPERS =======================
//

func StringPtr(v string) *string <span class="cov0" title="0">{ return &amp;v }</span>
func UintPtr(v uint) *uint       <span class="cov0" title="0">{ return &amp;v }</span>

func ParseDatePtr(input string) (*time.Time, error) <span class="cov0" title="0">{
        if strings.TrimSpace(input) == "" </span><span class="cov0" title="0">{
                return nil, nil
        }</span>
        <span class="cov0" title="0">layouts := []string{
                "2006-01-02",
                time.RFC3339,
                "2006-01-02T15:04:05-07:00",
        }
        for _, l := range layouts </span><span class="cov0" title="0">{
                if t, err := time.Parse(l, input); err == nil </span><span class="cov0" title="0">{
                        tt := t.Truncate(24 * time.Hour)
                        return &amp;tt, nil
                }</span>
        }
        <span class="cov0" title="0">return nil, errors.New("invalid date format")</span>
}

func TimeToStringPtr(t *time.Time) *string <span class="cov0" title="0">{
        if t == nil </span><span class="cov0" title="0">{
                return nil
        }</span>
        <span class="cov0" title="0">s := t.Format("2006-01-02")
        return &amp;s</span>
}
</pre>
		
		<pre class="file" id="file49" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.EmptyData", "data is not found")
}</span>

func ExistData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.ExistData", "data is exist")
}</span>

func InvalidUuid() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.InvalidData", "data is invalid")
}</span>

func InvalidTahun() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.InvalidTahun", "tahun is invalid")
}</span>

func InvalidAuditor() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.InvalidAuditor", "auditor is invalid")
}</span>

func InvalidAuditee() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.InvalidAuditee", "auditee is invalid")
}</span>

func InvalidStatusAcc() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.InvalidStatusAcc", "auditor is invalid")
}</span>

func InvalidTanggal() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.InvalidTanggal", "tanggal is invalid")
}</span>

func InvalidStep() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.InvalidStep", "tanggal is invalid")
}</span>

func RequiredNomorLaporan() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.RequiredNomorLaporan", "nomor laporan is required")
}</span>

func RequiredKeteranganTolak() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.RequiredKeteranganTolak", "keterangan tolak is required")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Kts.NotFound", fmt.Sprintf("Kts with identifier %s not found", id) )
}</pre>
		
		<pre class="file" id="file50" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("PreviewTemplate.EmptyData", "data is not found")
}</span>

func NotFoundTreeIndikator() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("PreviewTemplate.NotFoundTreeIndikator", "Tree Indikator not found")
}</span>

func NotFound() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("PreviewTemplate.NotFound", "Preview Template not found")
}</span>

func NotFoundFakultasUnit(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("PreviewTemplate.NotFoundFakultasUnit", fmt.Sprintf("FakultasUnit with identifier %s not found", id) )
}</span>
</pre>
		
		<pre class="file" id="file51" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/renstra/event"

        "github.com/google/uuid"
)

type Renstra struct {
        common.Entity

        ID                            uint      `gorm:"primaryKey;autoIncrement"`
        UUID                          uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Tahun                         string    `gorm:"size:255;not null"`
        FakultasUnit                  uint      `gorm:"column:fakultas_unit;"`
        PeriodeUploadMulai            string    `gorm:"column:periode_upload_mulai;"`
        PeriodeUploadAkhir            string    `gorm:"column:periode_upload_akhir;"`
        PeriodeAssesmentDokumenMulai  string    `gorm:"column:periode_assesment_dokumen_mulai;"`
        PeriodeAssesmentDokumenAkhir  string    `gorm:"column:periode_assesment_dokumen_akhir;"`
        PeriodeAssesmentLapanganMulai string    `gorm:"column:periode_assesment_lapangan_mulai;"`
        PeriodeAssesmentLapanganAkhir string    `gorm:"column:periode_assesment_lapangan_akhir;"`
        KodeAkses                     *string   `gorm:"column:kodeAkses;"`
        Auditee                       uint      `gorm:""`
        Auditor1                      uint      `gorm:""`
        Auditor2                      uint      `gorm:""`
        Catatan1                      *string   `gorm:"column:catatan;"`
        Catatan2                      *string   `gorm:"column:catatan2;"`
}

func (Renstra) TableName() string <span class="cov0" title="0">{
        return "renstra"
}</span>

// ------------------------
// Helper: check overlap
// ------------------------
func isOverlap(start1, end1, start2, end2 time.Time) bool <span class="cov0" title="0">{
        return !end1.Before(start2) &amp;&amp; !end2.Before(start1)
}</span>

// ------------------------
// Create New Renstra
// ------------------------
func NewRenstra(
        tahun string,
        fakultasUnit uint,
        periodeUploadMulai, periodeUploadAkhir string,
        periodeDokumenMulai, periodeDokumenAkhir string,
        periodeLapanganMulai, periodeLapanganAkhir string,
        auditee, auditor1, auditor2 uint,
        isUniqueData bool,
) common.ResultValue[*Renstra] <span class="cov0" title="0">{

        if fakultasUnit &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidFakultasUnit())
        }</span>

        <span class="cov0" title="0">if !isUniqueData </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](DataExisting())
        }</span>

        <span class="cov0" title="0">if auditee &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](MissingAuditee())
        }</span>
        <span class="cov0" title="0">if auditor1 &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](MissingAuditor1())
        }</span>
        <span class="cov0" title="0">if auditor2 &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](MissingAuditor2())
        }</span>

        <span class="cov0" title="0">if auditee == auditor1 || auditee == auditor2 || auditor1 == auditor2 </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](DuplicateAssigment())
        }</span>

        <span class="cov0" title="0">format := "2006-01-02"

        // Periode Upload
        startUpload, err := time.Parse(format, periodeUploadMulai)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidDate("upload"))
        }</span>
        <span class="cov0" title="0">endUpload, err := time.Parse(format, periodeUploadAkhir)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidDate("upload"))
        }</span>

        // Periode Assessment Dokumen
        <span class="cov0" title="0">startDokumen, err := time.Parse(format, periodeDokumenMulai)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidDate("assessment dokumen"))
        }</span>
        <span class="cov0" title="0">endDokumen, err := time.Parse(format, periodeDokumenAkhir)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidDate("assessment dokumen"))
        }</span>

        // Periode Assessment Lapangan
        <span class="cov0" title="0">startLapangan, err := time.Parse(format, periodeLapanganMulai)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidDate("assessment lapangan"))
        }</span>
        <span class="cov0" title="0">endLapangan, err := time.Parse(format, periodeLapanganAkhir)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidDate("assessment lapangan"))
        }</span>

        // Cek overlap
        <span class="cov0" title="0">if isOverlap(startUpload, endUpload, startDokumen, endDokumen) </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](PeriodOverlapUploadDokumen())
        }</span>

        <span class="cov0" title="0">if isOverlap(startUpload, endUpload, startLapangan, endLapangan) </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](PeriodOverlapUploadLapangan())
        }</span>

        <span class="cov0" title="0">if isOverlap(startDokumen, endDokumen, startLapangan, endLapangan) </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](PeriodOverlapDokumenLapangan())
        }</span>

        <span class="cov0" title="0">renstra := &amp;Renstra{
                UUID:                          uuid.New(),
                Tahun:                         tahun,
                FakultasUnit:                  fakultasUnit,
                PeriodeUploadMulai:            periodeUploadMulai,
                PeriodeUploadAkhir:            periodeUploadAkhir,
                PeriodeAssesmentDokumenMulai:  periodeDokumenMulai,
                PeriodeAssesmentDokumenAkhir:  periodeDokumenAkhir,
                PeriodeAssesmentLapanganMulai: periodeLapanganMulai,
                PeriodeAssesmentLapanganAkhir: periodeLapanganAkhir,
                Auditee:                       auditee,
                Auditor1:                      auditor1,
                Auditor2:                      auditor2,
        }

        renstra.Raise(event.RenstraCreatedEvent{
                EventID:     uuid.New(),
                OccurredOn:  time.Now().UTC(),
                RenstraUUID: renstra.UUID,
        })

        return common.SuccessValue(renstra)</span>
}

func GiveCodeAccessRenstra(
        prev *Renstra,
        uid uuid.UUID,
        kodeAkses string,
) common.ResultValue[*Renstra] <span class="cov0" title="0">{

        if prev == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](EmptyData())
        }</span>

        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidData())
        }</span>

        <span class="cov0" title="0">prev.KodeAkses = &amp;kodeAkses

        prev.Raise(event.RenstraGiveCodeAccessEvent{
                EventID:     uuid.New(),
                OccurredOn:  time.Now().UTC(),
                RenstraUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}

func UpdateRenstra(
        prev *Renstra,
        uid uuid.UUID,
        tahun string,
        fakultasUnit uint,
        periodeUploadMulai, periodeUploadAkhir string,
        periodeDokumenMulai, periodeDokumenAkhir string,
        periodeLapanganMulai, periodeLapanganAkhir string,
        auditee, auditor1, auditor2 uint,
) common.ResultValue[*Renstra] <span class="cov0" title="0">{

        if prev == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](EmptyData())
        }</span>

        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidData())
        }</span>

        <span class="cov0" title="0">if fakultasUnit &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidFakultasUnit())
        }</span>

        <span class="cov0" title="0">if auditee &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](MissingAuditee())
        }</span>
        <span class="cov0" title="0">if auditor1 &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](MissingAuditor1())
        }</span>
        <span class="cov0" title="0">if auditor2 &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](MissingAuditor2())
        }</span>

        <span class="cov0" title="0">if auditee == auditor1 || auditee == auditor2 || auditor1 == auditor2 </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](DuplicateAssigment())
        }</span>

        <span class="cov0" title="0">format := "2006-01-02"

        // Periode Upload
        startUpload, err := time.Parse(format, periodeUploadMulai)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidDate("upload"))
        }</span>
        <span class="cov0" title="0">endUpload, err := time.Parse(format, periodeUploadAkhir)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidDate("upload"))
        }</span>

        // Periode Assessment Dokumen
        <span class="cov0" title="0">startDokumen, err := time.Parse(format, periodeDokumenMulai)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidDate("assessment dokumen"))
        }</span>
        <span class="cov0" title="0">endDokumen, err := time.Parse(format, periodeDokumenAkhir)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidDate("assessment dokumen"))
        }</span>

        // Periode Assessment Lapangan
        <span class="cov0" title="0">startLapangan, err := time.Parse(format, periodeLapanganMulai)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidDate("assessment lapangan"))
        }</span>
        <span class="cov0" title="0">endLapangan, err := time.Parse(format, periodeLapanganAkhir)
        if err != nil </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](InvalidDate("assessment lapangan"))
        }</span>

        // Cek overlap
        <span class="cov0" title="0">if isOverlap(startUpload, endUpload, startDokumen, endDokumen) </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](PeriodOverlapUploadDokumen())
        }</span>

        <span class="cov0" title="0">if isOverlap(startUpload, endUpload, startLapangan, endLapangan) </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](PeriodOverlapUploadLapangan())
        }</span>

        <span class="cov0" title="0">if isOverlap(startDokumen, endDokumen, startLapangan, endLapangan) </span><span class="cov0" title="0">{
                return common.FailureValue[*Renstra](PeriodOverlapDokumenLapangan())
        }</span>

        // always overwrite (required field)
        <span class="cov0" title="0">prev.Tahun = tahun
        prev.FakultasUnit = fakultasUnit
        prev.PeriodeUploadMulai = periodeUploadMulai
        prev.PeriodeUploadAkhir = periodeUploadAkhir
        prev.PeriodeAssesmentDokumenMulai = periodeDokumenMulai
        prev.PeriodeAssesmentDokumenAkhir = periodeDokumenAkhir
        prev.PeriodeAssesmentLapanganMulai = periodeLapanganMulai
        prev.PeriodeAssesmentLapanganAkhir = periodeLapanganAkhir
        prev.Auditee = auditee
        prev.Auditor1 = auditor1
        prev.Auditor2 = auditor2

        prev.Raise(event.RenstraUpdatedEvent{
                EventID:     uuid.New(),
                OccurredOn:  time.Now().UTC(),
                RenstraUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file52" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.NotFound", fmt.Sprintf("Renstra with identifier %s not found", id))
}</span>

func InvalidFakultasUnit() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.InvalidFakultasUnit", "fakultas unit is invalid")
}</span>

func DataExisting() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.DataExisting", "the audit data form already existed before")
}</span>

func MissingAuditee() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.MissingAuditee", "auditee have not been assigned")
}</span>

func MissingAuditor1() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.MissingAuditor1", "auditor1 have not been assigned")
}</span>

func MissingAuditor2() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.MissingAuditor2", "auditor2 have not been assigned")
}</span>

func InvalidParsing(target string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.InvalidParsing", fmt.Sprintf("failed parsing %s to UUID", target))
}</span>

func DuplicateAssigment() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.DuplicateAssigment", "auditee, auditee 1, and auditor 2 must not have the same target")
}</span>

func InvalidDate(target string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.InvalidDate", fmt.Sprintf("%s period have wrong date format", target))
}</span>

func PeriodOverlapUploadDokumen() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.PeriodOverlapUploadDokumen", "upload period overlaps with document period")
}</span>

func PeriodOverlapUploadLapangan() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.PeriodOverlapUploadLapangan", "upload period overlaps with AL period")
}</span>

func PeriodOverlapDokumenLapangan() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("Renstra.PeriodOverlapDokumenLapangan", "document period overlaps with AL period")
}</span>
</pre>
		
		<pre class="file" id="file53" style="display: none">package domain

import (
        "slices"
        "strings"
        "time"

        common "UnpakSiamida/common/domain"
        domainrenstra "UnpakSiamida/modules/renstra/domain"
        event "UnpakSiamida/modules/renstranilai/event"

        "github.com/google/uuid"
)

type RenstraNilai struct {
        common.Entity

        ID              uint      `gorm:"primaryKey;autoIncrement"`
        UUID            uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Renstra         uint      `gorm:"column:id_renstra;"`
        TemplateRenstra uint      `gorm:""`
        Tugas           string    `gorm:""`
        Capaian         *string   `gorm:""`
        Catatan         *string   `gorm:""`
        LinkBukti       *string   `gorm:"column:link_bukti;"`
        CapaianAuditor  *string   `gorm:"column:capaian_auditor;"`
        CatatanAuditor  *string   `gorm:"column:catatan_auditor;"`
}

func (RenstraNilai) TableName() string <span class="cov0" title="0">{
        return "renstra_nilai"
}</span>

func UpdateRenstraNilai(
        prev *RenstraNilai,
        renstra *domainrenstra.Renstra,
        Uuid uuid.UUID,
        UuidRenstra uuid.UUID,
        Tahun string,
        Mode string,
        Granted string,
        Capaian *string,
        Catatan *string,
        LinkBukti *string,
        CapaianAuditor *string,
        CatatanAuditor *string,
) common.ResultValue[*RenstraNilai] <span class="cov0" title="0">{

        if renstra == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*RenstraNilai](InvalidRenstra())
        }</span>

        <span class="cov0" title="0">if prev == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*RenstraNilai](EmptyData())
        }</span>

        <span class="cov0" title="0">if prev.UUID != Uuid ||
                renstra.UUID != UuidRenstra ||
                renstra.Tahun != Tahun </span><span class="cov0" title="0">{
                return common.FailureValue[*RenstraNilai](InvalidData())
        }</span>

        <span class="cov0" title="0">if !contains([]string{"auditee", "auditor1", "auditor2"}, Mode) </span><span class="cov0" title="0">{
                return common.FailureValue[*RenstraNilai](RejectAction())
        }</span>

        <span class="cov0" title="0">if !IsGrantedAccess(Tahun, Mode, Granted) </span><span class="cov0" title="0">{
                return common.FailureValue[*RenstraNilai](NotGranted())
        }</span>

        <span class="cov0" title="0">switch Mode </span>{
        case "auditee":<span class="cov0" title="0">
                prev.Capaian = Capaian
                prev.Catatan = Catatan
                prev.LinkBukti = LinkBukti</span>

        case "auditor1":<span class="cov0" title="0">
                prev.CapaianAuditor = CapaianAuditor
                prev.CatatanAuditor = CatatanAuditor</span>
        }

        <span class="cov0" title="0">prev.Raise(event.RenstraNilaiUpdatedEvent{ //[pr] ketika tersave maka buat kts
                EventID:          uuid.New(),
                OccurredOn:       time.Now().UTC(),
                RenstraNilaiUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}

func contains(list []string, value string) bool <span class="cov0" title="0">{
        return slices.Contains(list, value)
}</span>

func IsGrantedAccess(tahun, mode, granted string) bool <span class="cov0" title="0">{
        requiredKey := tahun + "#" + mode

        grantedList := strings.SplitSeq(granted, ",")

        for g := range grantedList </span><span class="cov0" title="0">{
                if strings.TrimSpace(g) == requiredKey </span><span class="cov0" title="0">{
                        return true
                }</span>
        }

        <span class="cov0" title="0">return false</span>
}
</pre>
		
		<pre class="file" id="file54" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("RenstraNilai.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("RenstraNilai.InvalidUuid", "uuid is invalid")
}</span>

func InvalidRenstra() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("RenstraNilai.InvalidRenstra", "renstra is invalid")
}</span>

func RejectAction() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("RenstraNilai.RejectAction", "your action was rejected")
}</span>

func NotGranted() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("RenstraNilai.NotGranted", "you are not granted permission in this action")
}</span>

func InvalidData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("RenstraNilai.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("RenstraNilai.NotFound", fmt.Sprintf("RenstraNilai with identifier %s not found", id) )
}</span>
func NotFoundRenstra(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("RenstraNilai.NotFoundRenstra", fmt.Sprintf("Renstra with identifier %s not found", id) )
}</span>
</pre>
		
		<pre class="file" id="file55" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/standarrenstra/event"

        "github.com/google/uuid"
)

type StandarRenstra struct {
        common.Entity
        ID   uint      `gorm:"primaryKey;autoIncrement"`
        UUID uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Nama string    `gorm:"type:longtext;not null"`
}

func (StandarRenstra) TableName() string <span class="cov0" title="0">{
        return "master_standar_renstra"
}</span>

// === CREATE ===
func NewStandarRenstra(nama string) common.ResultValue[*StandarRenstra] <span class="cov0" title="0">{

        standarrenstra := &amp;StandarRenstra{
                UUID: uuid.New(),
                Nama: nama,
        }

        standarrenstra.Raise(event.StandarRenstraCreatedEvent{
                EventID:            uuid.New(),
                OccurredOn:         time.Now().UTC(),
                StandarRenstraUUID: standarrenstra.UUID,
        })

        return common.SuccessValue(standarrenstra)
}</span>

// === UPDATE ===
func UpdateStandarRenstra(
        prev *StandarRenstra,
        uid uuid.UUID,
        nama string,
) common.ResultValue[*StandarRenstra] <span class="cov0" title="0">{

        if prev == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*StandarRenstra](EmptyData())
        }</span>

        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*StandarRenstra](InvalidData())
        }</span>

        <span class="cov0" title="0">prev.Nama = nama

        prev.Raise(event.StandarRenstraUpdatedEvent{
                EventID:            uuid.New(),
                OccurredOn:         time.Now().UTC(),
                StandarRenstraUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file56" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("StandarRenstra.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("StandarRenstra.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("StandarRenstra.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("StandarRenstra.NotFound", fmt.Sprintf("StandarRenstra with identifier %s not found", id) )
}</span>
</pre>
		
		<pre class="file" id="file57" style="display: none">package application

import (
    "context"

    domainTahunRenstra "UnpakSiamida/modules/tahunrenstra/domain"
    "errors"
    "gorm.io/gorm"
    "time"
)

type GetActiveTahunRenstraQueryHandler struct {
    Repo domainTahunRenstra.ITahunRenstraRepository
}

func (h *GetActiveTahunRenstraQueryHandler) Handle(
    ctx context.Context,
    q GetActiveTahunRenstraQuery,
) (*domainTahunRenstra.TahunRenstra, error) <span class="cov0" title="0">{
    ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    tahunrenstra, err := h.Repo.GetActive(ctx)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domainTahunRenstra.EmptyData()
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov0" title="0">return tahunrenstra, nil</span>
}
</pre>
		
		<pre class="file" id="file58" style="display: none">package application

import (
    "context"
    domainTahunRenstra "UnpakSiamida/modules/tahunrenstra/domain"
    "time"
)

type GetAllTahunRenstrasQueryHandler struct {
    Repo domainTahunRenstra.ITahunRenstraRepository
}

func (h *GetAllTahunRenstrasQueryHandler) Handle(
    ctx context.Context,
    q GetAllTahunRenstrasQuery,
) (domainTahunRenstra.PagedTahunRenstras, error) <span class="cov0" title="0">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    TahunRenstras, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domainTahunRenstra.PagedTahunRenstras{}, err
    }</span>

    <span class="cov0" title="0">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov0" title="0">{
        currentPage = *q.Page
    }</span>
    <span class="cov0" title="0">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov0" title="0">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov0" title="0">return domainTahunRenstra.PagedTahunRenstras{
        Data:  TahunRenstras,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file59" style="display: none">package domain

import (
        common "UnpakSiamida/common/domain"
)

type TahunRenstra struct {
        common.Entity
        Tahun        string     `gorm:""`
        Status       string     `gorm:""`
}
func (TahunRenstra) TableName() string <span class="cov0" title="0">{
        return "v_tahun_renstra"
}</pre>
		
		<pre class="file" id="file60" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TahunRenstra.EmptyData", "data is not found")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TahunRenstra.NotFound", fmt.Sprintf("TahunRenstra with identifier %s not found", id) )
}</span>
</pre>
		
		<pre class="file" id="file61" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/templatedokumentambahan/event"

        "github.com/google/uuid"
)

type TemplateDokumenTambahan struct {
        common.Entity
        ID          uint      `gorm:"primaryKey;autoIncrement"`
        UUID        uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Tahun       string
        JenisFileID uint   `gorm:"column:jenis_file"`
        Pertanyaan  string `gorm:"type:longtext"`
        Klasifikasi string
        Kategori    string `gorm:"column:fakultas_prodi_unit"`
        Tugas       string
}

func (TemplateDokumenTambahan) TableName() string <span class="cov0" title="0">{
        return "template_dokumen_tambahan"
}</span>

// === CREATE ===
func NewTemplateDokumenTambahan(
        tahun string,
        jenisFileID uint,
        pertanyaan string,
        klasifikasi string,
        kategori string,
        tugas string,
) common.ResultValue[*TemplateDokumenTambahan] <span class="cov0" title="0">{
        if jenisFileID &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*TemplateDokumenTambahan](JenisFileNotFound())
        }</span>

        <span class="cov0" title="0">templatedokumentambahan := &amp;TemplateDokumenTambahan{
                UUID:        uuid.New(),
                Tahun:       tahun,
                JenisFileID: jenisFileID,
                Pertanyaan:  pertanyaan,
                Klasifikasi: klasifikasi,
                Kategori:    kategori,
                Tugas:       tugas,
        }

        templatedokumentambahan.Raise(event.TemplateDokumenTambahanCreatedEvent{
                EventID:                     uuid.New(),
                OccurredOn:                  time.Now().UTC(),
                TemplateDokumenTambahanUUID: templatedokumentambahan.UUID,
        })

        return common.SuccessValue(templatedokumentambahan)</span>
}

// === UPDATE ===
func UpdateTemplateDokumenTambahan(
        prev *TemplateDokumenTambahan,
        uid uuid.UUID,
        tahun string,
        jenisFileID uint,
        pertanyaan string,
        klasifikasi string,
        kategori string,
        tugas string,
) common.ResultValue[*TemplateDokumenTambahan] <span class="cov0" title="0">{

        if prev == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*TemplateDokumenTambahan](EmptyData())
        }</span>
        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*TemplateDokumenTambahan](InvalidData())
        }</span>
        <span class="cov0" title="0">if jenisFileID &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*TemplateDokumenTambahan](JenisFileNotFound())
        }</span>

        <span class="cov0" title="0">prev.Tahun = tahun
        prev.JenisFileID = jenisFileID
        prev.Pertanyaan = pertanyaan
        prev.Klasifikasi = klasifikasi
        prev.Kategori = kategori
        prev.Tugas = tugas

        prev.Raise(event.TemplateDokumenTambahanUpdatedEvent{
                EventID:                     uuid.New(),
                OccurredOn:                  time.Now().UTC(),
                TemplateDokumenTambahanUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file62" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TemplateDokumenTambahan.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TemplateDokumenTambahan.InvalidUuid", "uuid is invalid")
}</span>

func JenisFileNotFound() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TemplateDokumenTambahan.JenisFileNotFound", "fakultas unit not found")
}</span>

func InvalidData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TemplateDokumenTambahan.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TemplateDokumenTambahan.NotFound", fmt.Sprintf("TemplateDokumenTambahan with identifier %s not found", id) )
}</span>
</pre>
		
		<pre class="file" id="file63" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/templaterenstra/event"

        "github.com/google/uuid"
)

type TemplateRenstra struct {
        common.Entity
        ID                 uint      `gorm:"primaryKey;autoIncrement"`
        UUID               uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Tahun              string    `gorm:""`
        IndikatorRenstraID uint      `gorm:"column:indikator;"`
        IsPertanyaan       bool      `gorm:"column:pertanyaan;"`
        FakultasUnit       uint      `gorm:"column:fakultas_unit;"`
        Kategori           string    `gorm:""`
        Klasifikasi        string    `gorm:""`
        Satuan             *string   `gorm:""`
        Target             *string   `gorm:""`
        TargetMin          *string   `gorm:"column:target_min;"`
        TargetMax          *string   `gorm:"column:target_max;"`
        Tugas              string    `gorm:""`
}

func (TemplateRenstra) TableName() string <span class="cov0" title="0">{
        return "template_renstra"
}</span>

// === CREATE ===
func NewTemplateRenstra(
        tahun string,
        indikatorRenstraID uint,
        isPertanyaan bool,
        fakultasUnit uint,
        kategori string,
        klasifikasi string,
        satuan *string,
        target *string,
        targetMin *string,
        targetMax *string,
        tugas string,
) common.ResultValue[*TemplateRenstra] <span class="cov0" title="0">{
        hasTarget := target != nil &amp;&amp; *target != ""
        hasTargetMin := targetMin != nil &amp;&amp; *targetMin != ""
        hasTargetMax := targetMax != nil &amp;&amp; *targetMax != ""

        // Valid hanya jika:
        // - Mode A: hasTarget == true AND hasTargetMin == false AND hasTargetMax == false
        // - Mode B: hasTarget == false AND hasTargetMin == true AND hasTargetMax == true
        if !((hasTarget &amp;&amp; !hasTargetMin &amp;&amp; !hasTargetMax) ||
                (!hasTarget &amp;&amp; hasTargetMin &amp;&amp; hasTargetMax)) </span><span class="cov0" title="0">{
                return common.FailureValue[*TemplateRenstra](InvalidValueTarget())
        }</span>
        <span class="cov0" title="0">if indikatorRenstraID &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*TemplateRenstra](IndikatorNotFound())
        }</span>
        <span class="cov0" title="0">if fakultasUnit &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*TemplateRenstra](FakultasUnitNotFound())
        }</span>

        <span class="cov0" title="0">templaterenstra := &amp;TemplateRenstra{
                UUID:               uuid.New(),
                Tahun:              tahun,
                IndikatorRenstraID: indikatorRenstraID,
                IsPertanyaan:       isPertanyaan,
                FakultasUnit:       fakultasUnit,
                Kategori:           kategori,
                Klasifikasi:        klasifikasi,
                Satuan:             satuan,
                Target:             target,
                TargetMin:          targetMin,
                TargetMax:          targetMax,
                Tugas:              tugas,
        }

        templaterenstra.Raise(event.TemplateRenstraCreatedEvent{
                EventID:             uuid.New(),
                OccurredOn:          time.Now().UTC(),
                TemplateRenstraUUID: templaterenstra.UUID,
        })

        return common.SuccessValue(templaterenstra)</span>
}

// === UPDATE ===
func UpdateTemplateRenstra(
        prev *TemplateRenstra,
        uid uuid.UUID,
        tahun string,
        indikatorRenstraID uint,
        isPertanyaan bool,
        fakultasUnit uint,
        kategori string,
        klasifikasi string,
        satuan *string,
        target *string,
        targetMin *string,
        targetMax *string,
        tugas string,
) common.ResultValue[*TemplateRenstra] <span class="cov0" title="0">{

        hasTarget := target != nil &amp;&amp; *target != ""
        hasTargetMin := targetMin != nil &amp;&amp; *targetMin != ""
        hasTargetMax := targetMax != nil &amp;&amp; *targetMax != ""

        if prev == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*TemplateRenstra](EmptyData())
        }</span>
        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*TemplateRenstra](InvalidData())
        }</span>
        // Valid hanya jika:
        // - Mode A: hasTarget == true AND hasTargetMin == false AND hasTargetMax == false
        // - Mode B: hasTarget == false AND hasTargetMin == true AND hasTargetMax == true
        <span class="cov0" title="0">if !((hasTarget &amp;&amp; !hasTargetMin &amp;&amp; !hasTargetMax) ||
                (!hasTarget &amp;&amp; hasTargetMin &amp;&amp; hasTargetMax)) </span><span class="cov0" title="0">{
                return common.FailureValue[*TemplateRenstra](InvalidValueTarget())
        }</span>
        <span class="cov0" title="0">if indikatorRenstraID &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*TemplateRenstra](IndikatorNotFound())
        }</span>
        <span class="cov0" title="0">if fakultasUnit &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*TemplateRenstra](FakultasUnitNotFound())
        }</span>

        <span class="cov0" title="0">prev.Tahun = tahun
        prev.IndikatorRenstraID = indikatorRenstraID
        prev.IsPertanyaan = isPertanyaan
        prev.FakultasUnit = fakultasUnit
        prev.Kategori = kategori
        prev.Klasifikasi = klasifikasi
        prev.Satuan = satuan
        prev.Target = target
        prev.TargetMin = targetMin
        prev.TargetMax = targetMax
        prev.Tugas = tugas

        prev.Raise(event.TemplateRenstraUpdatedEvent{
                EventID:             uuid.New(),
                OccurredOn:          time.Now().UTC(),
                TemplateRenstraUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file64" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TemplateRenstra.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TemplateRenstra.InvalidUuid", "uuid is invalid")
}</span>

func IndikatorNotFound() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TemplateRenstra.IndikatorNotFound", "indikator not found")
}</span>

func FakultasUnitNotFound() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TemplateRenstra.FakultasUnitNotFound", "fakultas unit not found")
}</span>

func InvalidValueTarget() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TemplateRenstra.InvalidValueTarget", "invalid target combination, either provide Target only or provide both TargetMin and TargetMax")
}</span>

func InvalidData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TemplateRenstra.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("TemplateRenstra.NotFound", fmt.Sprintf("TemplateRenstra with identifier %s not found", id) )
}</span>
</pre>
		
		<pre class="file" id="file65" style="display: none">package application

import (
        "context"
        "encoding/json"
        "errors"
        "reflect"

        commoninfra "UnpakSiamida/common/infrastructure"
        domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
        domainuser "UnpakSiamida/modules/user/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type CreateUserCommandHandler struct {
        Repo             domainuser.IUserRepository
        RepoFakultasUnit domainfakultasunit.IFakultasUnitRepository
}

func (h *CreateUserCommandHandler) Handle(
        ctx context.Context,
        cmd CreateUserCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        fakultasUnitUUID := uuid.New()
        if cmd.UuidFakultasUnit != nil </span><span class="cov0" title="0">{
                parsed, err := uuid.Parse(*cmd.UuidFakultasUnit)
                if err != nil </span><span class="cov0" title="0">{
                        return "", domainuser.InvalidParsing("Fakultas Unit")
                }</span>
                <span class="cov0" title="0">fakultasUnitUUID = parsed</span>
        }

        <span class="cov0" title="0">var fu *int
        target, err := h.RepoFakultasUnit.GetDefaultByUuid(ctx, fakultasUnitUUID)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return "", domainuser.NotFoundFakultasUnit(*cmd.UuidFakultasUnit)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }
        <span class="cov0" title="0">fuId := int(target.ID)
        fu = &amp;fuId

        // if cmd.FakultasUnit != nil {
        //         raw := strings.TrimSpace(*cmd.FakultasUnit)

        //         if raw != "" {
        //                 parsed, err := strconv.ParseInt(raw, 10, 64)
        //                 if err != nil {
        //                         return "", err
        //                 }

        //                 v := int(parsed)
        //                 fu = &amp;v
        //         }
        // }

        result := domainuser.NewUser(
                cmd.Username,
                cmd.Password,
                cmd.Name,
                cmd.Email,
                cmd.Level,
                fu,
                &amp;target.Nama,
                &amp;target.Type,
        )

        //[pr] event dispatch

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov0" title="0">createUser := result.Value

        err = h.Repo.WithTx(ctx, func(txRepo domainuser.IUserRepositoryTx) error </span><span class="cov0" title="0">{

                if err := txRepo.Create(ctx, createUser); err != nil </span><span class="cov0" title="0">{
                        return err
                }</span>

                <span class="cov0" title="0">for _, event := range createUser.DomainEvents() </span><span class="cov0" title="0">{
                        payload, err := json.Marshal(event)
                        if err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>

                        <span class="cov0" title="0">outbox := commoninfra.OutboxMessage{
                                ID:            event.ID(),
                                Type:          reflect.TypeOf(event).String(),
                                Payload:       string(payload),
                                OccurredOnUTC: event.OccurredOnUTC(),
                        }

                        if err := txRepo.InsertOutbox(ctx, &amp;outbox); err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>
                }

                <span class="cov0" title="0">return nil</span>
        })

        <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        // ðŸ§¹ CLEAR AFTER COMMIT
        <span class="cov0" title="0">createUser.ClearDomainEvents()

        // if err := h.Repo.Create(ctx, createUser); err != nil {
        //         return "", err
        // }

        return result.Value.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file66" style="display: none">package application

import (
        helper "UnpakSiamida/common/helper"

        validation "github.com/go-ozzo/ozzo-validation/v4"
)

func CreateUserCommandValidation(cmd CreateUserCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Username,
                        validation.Required.Error("Username cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Password,
                        validation.Required.Error("Password cannot be blank"),
                ),

                validation.Field(&amp;cmd.Name,
                        validation.Required.Error("Name cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Email,
                        validation.Required.Error("Email cannot be blank"),
                        validation.By(helper.ValidateUnpakEmail),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Level,
                        validation.Required.Error("Level cannot be blank"),
                        validation.By(helper.ValidateLevel),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.UuidFakultasUnit,
                        validation.By(func(value interface{}) error </span><span class="cov0" title="0">{
                                return helper.ValidateFakultasUnit(value, cmd.Level)
                        }</span>),
                ),
        )
}
</pre>
		
		<pre class="file" id="file67" style="display: none">package application

import (
        "context"

        domainuser "UnpakSiamida/modules/user/domain"
        "github.com/google/uuid"
        "time"
)

type DeleteUserCommandHandler struct {
        Repo domainuser.IUserRepository
}

func (h *DeleteUserCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteUserCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        userUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainuser.InvalidUuid()
        }</span>

        // Get existing user
        <span class="cov0" title="0">existingUser, err := h.Repo.GetByUuid(ctx, userUUID)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>
        <span class="cov0" title="0">if existingUser == nil </span><span class="cov0" title="0">{
                return "", domainuser.NotFound(cmd.Uuid)
        }</span>

        // Delete by UUID
        <span class="cov0" title="0">if err := h.Repo.Delete(ctx, userUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov0" title="0">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file68" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func DeleteUserCommandValidation(cmd DeleteUserCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                ),
        )
}</pre>
		
		<pre class="file" id="file69" style="display: none">package application

import (
    "context"
    domainuser "UnpakSiamida/modules/user/domain"
    "time"
)

type GetAllUsersQueryHandler struct {
    Repo domainuser.IUserRepository
}

func (h *GetAllUsersQueryHandler) Handle(
    ctx context.Context,
    q GetAllUsersQuery,
) (domainuser.PagedUsers, error) <span class="cov0" title="0">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    users, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domainuser.PagedUsers{}, err
    }</span>

    <span class="cov0" title="0">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov0" title="0">{
        currentPage = *q.Page
    }</span>
    <span class="cov0" title="0">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov0" title="0">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov0" title="0">return domainuser.PagedUsers{
        Data:  users,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file70" style="display: none">package application

import (
    "context"

    domainuser "UnpakSiamida/modules/user/domain"
    "github.com/google/uuid"
    "errors"
    "gorm.io/gorm"
    "time"
)

type GetUserByUuidQueryHandler struct {
    Repo domainuser.IUserRepository
}

func (h *GetUserByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetUserByUuidQuery,
) (*domainuser.User, error) <span class="cov0" title="0">{
    ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domainuser.NotFound(q.Uuid)
        }</span>

    <span class="cov0" title="0">user, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domainuser.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov0" title="0">return user, nil</span>
}
</pre>
		
		<pre class="file" id="file71" style="display: none">package application

import (
        "context"

        domainuser "UnpakSiamida/modules/user/domain"
)

type SetupUuidUserCommandHandler struct {
        Repo domainuser.IUserRepository
}

func (h *SetupUuidUserCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidUserCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file72" style="display: none">package application

import (
        "context"
        "encoding/json"
        "errors"
        "reflect"
        "strings"

        commoninfra "UnpakSiamida/common/infrastructure"
        domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
        domainuser "UnpakSiamida/modules/user/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type UpdateUserCommandHandler struct {
        Repo             domainuser.IUserRepository
        RepoFakultasUnit domainfakultasunit.IFakultasUnitRepository
}

func (h *UpdateUserCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateUserCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // -------------------------
        // VALIDATE UUID
        // -------------------------
        userUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainuser.InvalidUuid()
        }</span>

        // -------------------------
        // GET EXISTING USER
        // -------------------------
        <span class="cov0" title="0">existingUser, err := h.Repo.GetByUuid(ctx, userUUID) // â† memastikan pakai nama interface yg benar
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>
        <span class="cov0" title="0">if existingUser == nil </span><span class="cov0" title="0">{
                return "", domainuser.NotFound(cmd.Uuid)
        }</span>

        // -------------------------
        // HANDLE PASSWORD
        // -------------------------
        <span class="cov0" title="0">var password *string = nil

        if cmd.Password != nil </span><span class="cov0" title="0">{ // â† FIX: sebelumnya cmd.password (typo)
                raw := strings.TrimSpace(*cmd.Password)
                if raw != "" </span><span class="cov0" title="0">{
                        password = &amp;raw
                }</span>
        }

        // -------------------------
        // HANDLE FakultasUnit (string â†’ int pointer)
        // -------------------------
        <span class="cov0" title="0">fakultasUnitUUID := uuid.New()
        if cmd.UuidFakultasUnit != nil </span><span class="cov0" title="0">{
                parsed, err := uuid.Parse(*cmd.UuidFakultasUnit)
                if err != nil </span><span class="cov0" title="0">{
                        return "", domainuser.InvalidParsing("Fakultas Unit")
                }</span>
                <span class="cov0" title="0">fakultasUnitUUID = parsed</span>
        }

        <span class="cov0" title="0">var fu *int = nil
        target, err := h.RepoFakultasUnit.GetDefaultByUuid(ctx, fakultasUnitUUID)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return "", domainuser.NotFoundFakultasUnit(*cmd.UuidFakultasUnit)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }
        <span class="cov0" title="0">fuId := int(target.ID)
        fu = &amp;fuId

        // -------------------------
        // AGGREGATE ROOT LOGIC
        // -------------------------
        result := domainuser.UpdateUser(
                existingUser,
                userUUID,
                cmd.Username,
                password,
                cmd.Name,
                cmd.Email,
                cmd.Level,
                fu,
                &amp;target.Nama,
                &amp;target.Type,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov0" title="0">updatedUser := result.Value

        err = h.Repo.WithTx(ctx, func(txRepo domainuser.IUserRepositoryTx) error </span><span class="cov0" title="0">{

                if err := txRepo.Update(ctx, updatedUser); err != nil </span><span class="cov0" title="0">{
                        return err
                }</span>

                <span class="cov0" title="0">for _, event := range updatedUser.DomainEvents() </span><span class="cov0" title="0">{
                        payload, err := json.Marshal(event)
                        if err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>

                        <span class="cov0" title="0">outbox := commoninfra.OutboxMessage{
                                ID:            event.ID(),
                                Type:          reflect.TypeOf(event).String(),
                                Payload:       string(payload),
                                OccurredOnUTC: event.OccurredOnUTC(),
                        }

                        if err := txRepo.InsertOutbox(ctx, &amp;outbox); err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>
                }

                <span class="cov0" title="0">return nil</span>
        })

        <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        // ðŸ§¹ CLEAR AFTER COMMIT
        <span class="cov0" title="0">updatedUser.ClearDomainEvents()

        // -------------------------
        // SAVE TO REPOSITORY
        // -------------------------
        // if err := h.Repo.Update(ctx, updatedUser); err != nil {
        //         return "", err
        // }

        return updatedUser.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file73" style="display: none">package application

import (
        helper "UnpakSiamida/common/helper"

        validation "github.com/go-ozzo/ozzo-validation/v4"
)

func UpdateUserCommandValidation(cmd UpdateUserCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                ),

                validation.Field(&amp;cmd.Username,
                        validation.Required.Error("Username cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                // validation.Field(&amp;cmd.Password,
                //         validation.Required.Error("Password cannot be blank"),
                // ),

                validation.Field(&amp;cmd.Name,
                        validation.Required.Error("Name cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Email,
                        validation.Required.Error("Email cannot be blank"),
                        validation.By(helper.ValidateUnpakEmail),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Level,
                        validation.Required.Error("Level cannot be blank"),
                        validation.By(helper.ValidateLevel),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.UuidFakultasUnit,
                        validation.By(func(value interface{}) error </span><span class="cov0" title="0">{
                                return helper.ValidateFakultasUnit(value, cmd.Level)
                        }</span>),
                ),
        )
}
</pre>
		
		<pre class="file" id="file74" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        helper "UnpakSiamida/common/helper"
        event "UnpakSiamida/modules/user/event"

        "github.com/google/uuid"
)

type User struct {
        common.Entity
        ID           uint      `gorm:"primaryKey;autoIncrement"`
        UUID         uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Username     string    `gorm:"column:nidn_username;size:100;not null"`
        Password     string    `gorm:"type:longtext;not null"`
        Name         string    `gorm:"size:255;not null"`
        Email        string    `gorm:"size:255;"`
        Level        string    `gorm:"size:255;"`
        FakultasUnit *int      `gorm:"column:fakultas_unit;"`
}

func (User) TableName() string <span class="cov0" title="0">{
        return "users"
}</span>

// === CREATE ===
func NewUser(username string, password string, name string, email string, level string, fakultasunit *int, target *string, tipe *string) common.ResultValue[*User] <span class="cov0" title="0">{

        if !helper.IsValidUnpakEmail(email) </span><span class="cov0" title="0">{
                return common.FailureValue[*User](InvalidEmail())
        }</span>

        <span class="cov0" title="0">if fakultasunit != nil &amp;&amp; *fakultasunit &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*User](InvalidFakultasUnit())
        }</span>

        <span class="cov0" title="0">if !helper.IsValidUnpakEmail(email) </span><span class="cov0" title="0">{
                return common.FailureValue[*User](InvalidEmail())
        }</span>

        <span class="cov0" title="0">user := &amp;User{
                UUID:         uuid.New(),
                Username:     username,
                Password:     password,
                Name:         name,
                Email:        email,
                Level:        level,
                FakultasUnit: fakultasunit,
        }

        user.Raise(event.UserCreatedEvent{
                EventID:      uuid.New(),
                OccurredOn:   time.Now().UTC(),
                UserUUID:     user.UUID,
                Username:     username,
                Password:     password,
                Name:         name,
                Email:        email,
                Level:        level,
                FakultasUnit: target,
                Tipe:         tipe,
        })

        return common.SuccessValue(user)</span>
}

// === UPDATE ===
func UpdateUser(
        prev *User,
        uid uuid.UUID,
        username string,
        password *string,
        name string,
        email string,
        level string,
        fakultasunit *int,
        target *string,
        tipe *string,
) common.ResultValue[*User] <span class="cov0" title="0">{

        if prev == nil </span><span class="cov0" title="0">{
                return common.FailureValue[*User](EmptyData())
        }</span>

        <span class="cov0" title="0">if prev.UUID != uid </span><span class="cov0" title="0">{
                return common.FailureValue[*User](InvalidData())
        }</span>

        <span class="cov0" title="0">if fakultasunit != nil &amp;&amp; *fakultasunit &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*User](InvalidFakultasUnit())
        }</span>

        <span class="cov0" title="0">if !helper.IsValidUnpakEmail(email) </span><span class="cov0" title="0">{
                return common.FailureValue[*User](InvalidEmail())
        }</span>

        // update opsional
        <span class="cov0" title="0">updatedPassword := prev.Password
        if password != nil </span><span class="cov0" title="0">{
                updatedPassword = *password
                prev.Password = *password
        }</span>

        <span class="cov0" title="0">prev.Name = name
        prev.Email = email
        prev.Level = level

        if fakultasunit != nil </span><span class="cov0" title="0">{
                prev.FakultasUnit = fakultasunit
        }</span>

        <span class="cov0" title="0">prev.Raise(event.UserUpdatedEvent{
                EventID:      uuid.New(),
                OccurredOn:   time.Now().UTC(),
                UserUUID:     prev.UUID,
                Username:     username,
                Password:     updatedPassword,
                Name:         name,
                Email:        email,
                Level:        level,
                FakultasUnit: target,
                Tipe:         tipe,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file75" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("User.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("User.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("User.InvalidData", "data is invalid")
}</span>

func InvalidEmail() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("User.InvalidEmail", "email tidak valid atau tidak diperbolehkan")
}</span>

func InvalidFakultasUnit() domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("User.InvalidFakultasUnit", "fakultas unit tidak valid")
}</span>

func NotFound(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("User.NotFound", fmt.Sprintf("user with identifier %s not found", id))
}</span>

func InvalidParsing(target string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("User.InvalidParsing", fmt.Sprintf("failed parsing %s to UUID", target))
}</span>

func NotFoundFakultasUnit(id string) domain.Error <span class="cov0" title="0">{
        return domain.NotFoundError("User.NotFoundFakultasUnit", fmt.Sprintf("fakultas unit with identifier %s not found", id))
}</span>
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
