
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Login: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">UnpakSiamida/modules/account/application/Login/LoginCommandHandler.go (91.7%)</option>
				
				<option value="file1">UnpakSiamida/modules/account/application/Login/LoginCommandValidation.go (100.0%)</option>
				
				<option value="file2">UnpakSiamida/modules/account/application/Whoami/WhoamiCommandHandler.go (84.6%)</option>
				
				<option value="file3">UnpakSiamida/modules/account/application/Whoami/WhoamiCommandValidation.go (100.0%)</option>
				
				<option value="file4">UnpakSiamida/modules/account/domain/Account.go (0.0%)</option>
				
				<option value="file5">UnpakSiamida/modules/account/domain/AccountErrors.go (100.0%)</option>
				
				<option value="file6">UnpakSiamida/modules/beritaacara/application/CreateBeritaAcara/CreateBeritaAcaraCommandHandler.go (75.0%)</option>
				
				<option value="file7">UnpakSiamida/modules/beritaacara/application/CreateBeritaAcara/CreateBeritaAcaraCommandValidation.go (100.0%)</option>
				
				<option value="file8">UnpakSiamida/modules/beritaacara/application/DeleteBeritaAcara/DeleteBeritaAcaraCommandHandler.go (76.9%)</option>
				
				<option value="file9">UnpakSiamida/modules/beritaacara/application/DeleteBeritaAcara/DeleteBeritaAcaraCommandValidation.go (100.0%)</option>
				
				<option value="file10">UnpakSiamida/modules/beritaacara/application/GetAllBeritaAcaras/GetAllBeritaAcarasQueryHandler.go (91.7%)</option>
				
				<option value="file11">UnpakSiamida/modules/beritaacara/application/GetBeritaAcara/GetBeritaAcaraByUuidQueryHandler.go (90.9%)</option>
				
				<option value="file12">UnpakSiamida/modules/beritaacara/application/GetBeritaAcaraDefault/GetBeritaAcaraDefaultByUuidQueryHandler.go (90.9%)</option>
				
				<option value="file13">UnpakSiamida/modules/beritaacara/application/SetupUuidBeritaAcara/SetupUuidBeritaAcaraCommandHandler.go (0.0%)</option>
				
				<option value="file14">UnpakSiamida/modules/beritaacara/application/UpdateBeritaAcara/UpdateBeritaAcaraCommandHandler.go (65.0%)</option>
				
				<option value="file15">UnpakSiamida/modules/beritaacara/application/UpdateBeritaAcara/UpdateBeritaAcaraCommandValidation.go (100.0%)</option>
				
				<option value="file16">UnpakSiamida/modules/beritaacara/domain/BeritaAcara.go (93.8%)</option>
				
				<option value="file17">UnpakSiamida/modules/beritaacara/domain/BeritaAcaraErrors.go (100.0%)</option>
				
				<option value="file18">UnpakSiamida/modules/dokumentambahan/application/DeleteDokumenTambahan/DeleteDokumenTambahanCommandHandler.go (76.9%)</option>
				
				<option value="file19">UnpakSiamida/modules/dokumentambahan/application/DeleteDokumenTambahan/DeleteDokumenTambahanCommandValidation.go (100.0%)</option>
				
				<option value="file20">UnpakSiamida/modules/dokumentambahan/application/GetAllDokumenTambahans/GetAllDokumenTambahansQueryHandler.go (91.7%)</option>
				
				<option value="file21">UnpakSiamida/modules/dokumentambahan/application/GetDokumenTambahan/GetDokumenTambahanByUuidQueryHandler.go (81.8%)</option>
				
				<option value="file22">UnpakSiamida/modules/dokumentambahan/application/GetDokumenTambahanDefault/GetDokumenTambahanDefaultByUuidQueryHandler.go (81.8%)</option>
				
				<option value="file23">UnpakSiamida/modules/dokumentambahan/application/SetupUuidDokumenTambahan/SetupUuidDokumenTambahanCommandHandler.go (0.0%)</option>
				
				<option value="file24">UnpakSiamida/modules/dokumentambahan/application/UpdateDokumenTambahan/UpdateDokumenTambahanCommandHandler.go (0.0%)</option>
				
				<option value="file25">UnpakSiamida/modules/dokumentambahan/application/UpdateDokumenTambahan/UpdateDokumenTambahanCommandValidation.go (0.0%)</option>
				
				<option value="file26">UnpakSiamida/modules/dokumentambahan/domain/DokumenTambahan.go (96.3%)</option>
				
				<option value="file27">UnpakSiamida/modules/dokumentambahan/domain/DokumenTambahanErrors.go (100.0%)</option>
				
				<option value="file28">UnpakSiamida/modules/fakultasunit/application/GetAllFakultasUnits/GetAllFakultasUnitsQueryHandler.go (91.7%)</option>
				
				<option value="file29">UnpakSiamida/modules/fakultasunit/application/GetFakultasUnit/GetFakultasUnitByUuidQueryHandler.go (90.9%)</option>
				
				<option value="file30">UnpakSiamida/modules/fakultasunit/application/SetupUuidFakultasUnit/SetupUuidFakultasUnitCommandHandler.go (0.0%)</option>
				
				<option value="file31">UnpakSiamida/modules/fakultasunit/domain/FakultasUnit.go (0.0%)</option>
				
				<option value="file32">UnpakSiamida/modules/fakultasunit/domain/FakultasUnitErrors.go (100.0%)</option>
				
				<option value="file33">UnpakSiamida/modules/generaterenstra/domain/GenerateDokumenTambahan.go (0.0%)</option>
				
				<option value="file34">UnpakSiamida/modules/generaterenstra/domain/GenerateRenstra.go (92.9%)</option>
				
				<option value="file35">UnpakSiamida/modules/generaterenstra/domain/GenerateRenstraErrors.go (100.0%)</option>
				
				<option value="file36">UnpakSiamida/modules/indikatorrenstra/application/CreateIndikatorRenstra/CreateIndikatorRenstraCommandHandler.go (78.8%)</option>
				
				<option value="file37">UnpakSiamida/modules/indikatorrenstra/application/CreateIndikatorRenstra/CreateIndikatorRenstraCommandValidation.go (100.0%)</option>
				
				<option value="file38">UnpakSiamida/modules/indikatorrenstra/application/DeleteIndikatorRenstra/DeleteIndikatorRenstraCommandHandler.go (76.9%)</option>
				
				<option value="file39">UnpakSiamida/modules/indikatorrenstra/application/DeleteIndikatorRenstra/DeleteIndikatorRenstraCommandValidation.go (100.0%)</option>
				
				<option value="file40">UnpakSiamida/modules/indikatorrenstra/application/GetAllIndikatorRenstras/GetAllIndikatorRenstrasQueryHandler.go (91.7%)</option>
				
				<option value="file41">UnpakSiamida/modules/indikatorrenstra/application/GetIndikatorRenstra/GetIndikatorRenstraByUuidQueryHandler.go (90.9%)</option>
				
				<option value="file42">UnpakSiamida/modules/indikatorrenstra/application/GetIndikatorRenstraDefault/GetIndikatorRenstraDefaultByUuidQueryHandler.go (90.9%)</option>
				
				<option value="file43">UnpakSiamida/modules/indikatorrenstra/application/SetupUuidIndikatorRenstra/SetupUuidIndikatorRenstraCommandHandler.go (0.0%)</option>
				
				<option value="file44">UnpakSiamida/modules/indikatorrenstra/application/UpdateIndikatorRenstra/UpdateIndikatorRenstraCommandHandler.go (75.7%)</option>
				
				<option value="file45">UnpakSiamida/modules/indikatorrenstra/application/UpdateIndikatorRenstra/UpdateIndikatorRenstraCommandValidation.go (100.0%)</option>
				
				<option value="file46">UnpakSiamida/modules/indikatorrenstra/domain/IndikatorRenstra.go (95.8%)</option>
				
				<option value="file47">UnpakSiamida/modules/indikatorrenstra/domain/IndikatorRenstraErrors.go (100.0%)</option>
				
				<option value="file48">UnpakSiamida/modules/jenisfile/application/CreateJenisFile/CreateJenisFileCommandHandler.go (77.8%)</option>
				
				<option value="file49">UnpakSiamida/modules/jenisfile/application/CreateJenisFile/CreateJenisFileCommandValidation.go (100.0%)</option>
				
				<option value="file50">UnpakSiamida/modules/jenisfile/application/DeleteJenisFile/DeleteJenisFileCommandHandler.go (76.9%)</option>
				
				<option value="file51">UnpakSiamida/modules/jenisfile/application/DeleteJenisFile/DeleteJenisFileCommandValidation.go (100.0%)</option>
				
				<option value="file52">UnpakSiamida/modules/jenisfile/application/GetAllJenisFiles/GetAllJenisFilesQueryHandler.go (91.7%)</option>
				
				<option value="file53">UnpakSiamida/modules/jenisfile/application/GetJenisFile/GetJenisFileByUuidQueryHandler.go (90.9%)</option>
				
				<option value="file54">UnpakSiamida/modules/jenisfile/application/GetJenisFileDefault/GetJenisFileDefaultByUuidQueryHandler.go (90.9%)</option>
				
				<option value="file55">UnpakSiamida/modules/jenisfile/application/SetupUuidJenisFile/SetupUuidJenisFileCommandHandler.go (0.0%)</option>
				
				<option value="file56">UnpakSiamida/modules/jenisfile/application/UpdateJenisFile/UpdateJenisFileCommandHandler.go (76.5%)</option>
				
				<option value="file57">UnpakSiamida/modules/jenisfile/application/UpdateJenisFile/UpdateJenisFileCommandValidation.go (100.0%)</option>
				
				<option value="file58">UnpakSiamida/modules/jenisfile/domain/JenisFile.go (90.9%)</option>
				
				<option value="file59">UnpakSiamida/modules/jenisfile/domain/JenisFileErrors.go (100.0%)</option>
				
				<option value="file60">UnpakSiamida/modules/kts/domain/Kts.go (94.3%)</option>
				
				<option value="file61">UnpakSiamida/modules/kts/domain/KtsErrors.go (100.0%)</option>
				
				<option value="file62">UnpakSiamida/modules/previewtemplate/application/GetPreviewTemplate/GetPreviewTemplateByTahunFakultasUnitQueryHandler.go (85.0%)</option>
				
				<option value="file63">UnpakSiamida/modules/previewtemplate/domain/PreviewTemplateErrors.go (100.0%)</option>
				
				<option value="file64">UnpakSiamida/modules/renstra/application/CreateRenstra/CreateRenstraCommandHandler.go (61.4%)</option>
				
				<option value="file65">UnpakSiamida/modules/renstra/application/CreateRenstra/CreateRenstraCommandValidation.go (100.0%)</option>
				
				<option value="file66">UnpakSiamida/modules/renstra/application/DeleteRenstra/DeleteRenstraCommandHandler.go (76.9%)</option>
				
				<option value="file67">UnpakSiamida/modules/renstra/application/DeleteRenstra/DeleteRenstraCommandValidation.go (100.0%)</option>
				
				<option value="file68">UnpakSiamida/modules/renstra/application/GetAllRenstras/GetAllRenstrasQueryHandler.go (91.7%)</option>
				
				<option value="file69">UnpakSiamida/modules/renstra/application/GetRenstra/GetRenstraByUuidQueryHandler.go (0.0%)</option>
				
				<option value="file70">UnpakSiamida/modules/renstra/application/GetRenstraDefault/GetRenstraDefaultByUuidQueryHandler.go (90.9%)</option>
				
				<option value="file71">UnpakSiamida/modules/renstra/application/GiveCodeAccessRenstra/GiveCodeAccessRenstraCommandHandler.go (0.0%)</option>
				
				<option value="file72">UnpakSiamida/modules/renstra/application/GiveCodeAccessRenstra/GiveCodeAccessRenstraCommandValidation.go (0.0%)</option>
				
				<option value="file73">UnpakSiamida/modules/renstra/application/SetupUuidRenstra/SetupUuidRenstraCommandHandler.go (0.0%)</option>
				
				<option value="file74">UnpakSiamida/modules/renstra/application/UpdateRenstra/UpdateRenstraCommandHandler.go (75.5%)</option>
				
				<option value="file75">UnpakSiamida/modules/renstra/application/UpdateRenstra/UpdateRenstraCommandValidation.go (100.0%)</option>
				
				<option value="file76">UnpakSiamida/modules/renstra/domain/Renstra.go (99.0%)</option>
				
				<option value="file77">UnpakSiamida/modules/renstra/domain/RenstraErrors.go (100.0%)</option>
				
				<option value="file78">UnpakSiamida/modules/renstranilai/application/DeleteRenstraNilai/DeleteRenstraNilaiCommandHandler.go (76.9%)</option>
				
				<option value="file79">UnpakSiamida/modules/renstranilai/application/DeleteRenstraNilai/DeleteRenstraNilaiCommandValidation.go (100.0%)</option>
				
				<option value="file80">UnpakSiamida/modules/renstranilai/application/GetAllRenstraNilais/GetAllRenstraNilaisQueryHandler.go (0.0%)</option>
				
				<option value="file81">UnpakSiamida/modules/renstranilai/application/GetRenstraNilai/GetRenstraNilaiByUuidQueryHandler.go (0.0%)</option>
				
				<option value="file82">UnpakSiamida/modules/renstranilai/application/SetupUuidRenstraNilai/SetupUuidRenstraNilaiCommandHandler.go (0.0%)</option>
				
				<option value="file83">UnpakSiamida/modules/renstranilai/application/UpdateRenstraNilai/UpdateRenstraNilaiCommandHandler.go (0.0%)</option>
				
				<option value="file84">UnpakSiamida/modules/renstranilai/application/UpdateRenstraNilai/UpdateRenstraNilaiCommandValidation.go (0.0%)</option>
				
				<option value="file85">UnpakSiamida/modules/renstranilai/domain/RenstraNilai.go (96.2%)</option>
				
				<option value="file86">UnpakSiamida/modules/renstranilai/domain/RenstraNilaiErrors.go (100.0%)</option>
				
				<option value="file87">UnpakSiamida/modules/standarrenstra/application/CreateStandarRenstra/CreateStandarRenstraCommandHandler.go (77.8%)</option>
				
				<option value="file88">UnpakSiamida/modules/standarrenstra/application/CreateStandarRenstra/CreateStandarRenstraCommandValidation.go (100.0%)</option>
				
				<option value="file89">UnpakSiamida/modules/standarrenstra/application/DeleteStandarRenstra/DeleteStandarRenstraCommandHandler.go (76.9%)</option>
				
				<option value="file90">UnpakSiamida/modules/standarrenstra/application/DeleteStandarRenstra/DeleteStandarRenstraCommandValidation.go (100.0%)</option>
				
				<option value="file91">UnpakSiamida/modules/standarrenstra/application/GetAllStandarRenstras/GetAllStandarRenstrasQueryHandler.go (91.7%)</option>
				
				<option value="file92">UnpakSiamida/modules/standarrenstra/application/GetStandarRenstra/GetStandarRenstraByUuidQueryHandler.go (90.9%)</option>
				
				<option value="file93">UnpakSiamida/modules/standarrenstra/application/SetupUuidStandarRenstra/SetupUuidStandarRenstraCommandHandler.go (0.0%)</option>
				
				<option value="file94">UnpakSiamida/modules/standarrenstra/application/UpdateStandarRenstra/UpdateStandarRenstraCommandHandler.go (76.5%)</option>
				
				<option value="file95">UnpakSiamida/modules/standarrenstra/application/UpdateStandarRenstra/UpdateStandarRenstraCommandValidation.go (100.0%)</option>
				
				<option value="file96">UnpakSiamida/modules/standarrenstra/domain/StandarRenstra.go (90.9%)</option>
				
				<option value="file97">UnpakSiamida/modules/standarrenstra/domain/StandarRenstraErrors.go (100.0%)</option>
				
				<option value="file98">UnpakSiamida/modules/tahunrenstra/application/GetActiveTahunRenstra/GetActiveTahunRenstraQueryHandler.go (87.5%)</option>
				
				<option value="file99">UnpakSiamida/modules/tahunrenstra/application/GetAllTahunRenstras/GetAllTahunRenstrasQueryHandler.go (91.7%)</option>
				
				<option value="file100">UnpakSiamida/modules/tahunrenstra/domain/TahunRenstra.go (0.0%)</option>
				
				<option value="file101">UnpakSiamida/modules/tahunrenstra/domain/TahunRenstraErrors.go (100.0%)</option>
				
				<option value="file102">UnpakSiamida/modules/templatedokumentambahan/application/CreateTemplateDokumenTambahan/CreateTemplateDokumenTambahanCommandHandler.go (76.5%)</option>
				
				<option value="file103">UnpakSiamida/modules/templatedokumentambahan/application/CreateTemplateDokumenTambahan/CreateTemplateDokumenTambahanCommandValidation.go (100.0%)</option>
				
				<option value="file104">UnpakSiamida/modules/templatedokumentambahan/application/DeleteTemplateDokumenTambahan/DeleteTemplateDokumenTambahanCommandHandler.go (84.6%)</option>
				
				<option value="file105">UnpakSiamida/modules/templatedokumentambahan/application/DeleteTemplateDokumenTambahan/DeleteTemplateDokumenTambahanCommandValidation.go (100.0%)</option>
				
				<option value="file106">UnpakSiamida/modules/templatedokumentambahan/application/GetAllTemplateDokumenTambahans/GetAllTemplateDokumenTambahansQueryHandler.go (91.7%)</option>
				
				<option value="file107">UnpakSiamida/modules/templatedokumentambahan/application/GetTemplateDokumenTambahan/GetTemplateDokumenTambahanByUuidQueryHandler.go (90.9%)</option>
				
				<option value="file108">UnpakSiamida/modules/templatedokumentambahan/application/SetupUuidTemplateDokumenTambahan/SetupUuidTemplateDokumenTambahanCommandHandler.go (0.0%)</option>
				
				<option value="file109">UnpakSiamida/modules/templatedokumentambahan/application/UpdateTemplateDokumenTambahan/UpdateTemplateDokumenTambahanCommandHandler.go (73.2%)</option>
				
				<option value="file110">UnpakSiamida/modules/templatedokumentambahan/application/UpdateTemplateDokumenTambahan/UpdateTemplateDokumenTambahanCommandValidation.go (100.0%)</option>
				
				<option value="file111">UnpakSiamida/modules/templatedokumentambahan/domain/TemplateDokumenTambahan.go (95.0%)</option>
				
				<option value="file112">UnpakSiamida/modules/templatedokumentambahan/domain/TemplateDokumenTambahanErrors.go (100.0%)</option>
				
				<option value="file113">UnpakSiamida/modules/templaterenstra/application/CreateTemplateRenstra/CreateTemplateRenstraCommandHandler.go (85.4%)</option>
				
				<option value="file114">UnpakSiamida/modules/templaterenstra/application/CreateTemplateRenstra/CreateTemplateRenstraCommandValidation.go (100.0%)</option>
				
				<option value="file115">UnpakSiamida/modules/templaterenstra/application/DeleteTemplateRenstra/DeleteTemplateRenstraCommandHandler.go (84.6%)</option>
				
				<option value="file116">UnpakSiamida/modules/templaterenstra/application/DeleteTemplateRenstra/DeleteTemplateRenstraCommandValidation.go (100.0%)</option>
				
				<option value="file117">UnpakSiamida/modules/templaterenstra/application/GetAllTemplateRenstras/GetAllTemplateRenstrasQueryHandler.go (91.7%)</option>
				
				<option value="file118">UnpakSiamida/modules/templaterenstra/application/GetTemplateRenstra/GetTemplateRenstraByUuidQueryHandler.go (90.9%)</option>
				
				<option value="file119">UnpakSiamida/modules/templaterenstra/application/SetupUuidTemplateRenstra/SetupUuidTemplateRenstraCommandHandler.go (0.0%)</option>
				
				<option value="file120">UnpakSiamida/modules/templaterenstra/application/UpdateTemplateRenstra/UpdateTemplateRenstraCommandHandler.go (78.8%)</option>
				
				<option value="file121">UnpakSiamida/modules/templaterenstra/application/UpdateTemplateRenstra/UpdateTemplateRenstraCommandValidation.go (100.0%)</option>
				
				<option value="file122">UnpakSiamida/modules/templaterenstra/domain/TemplateRenstra.go (84.6%)</option>
				
				<option value="file123">UnpakSiamida/modules/templaterenstra/domain/TemplateRenstraErrors.go (100.0%)</option>
				
				<option value="file124">UnpakSiamida/modules/user/domain/User.go (92.6%)</option>
				
				<option value="file125">UnpakSiamida/modules/user/domain/UserErrors.go (100.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package application

import (
        "context"
        "errors"

        helper "UnpakSiamida/common/helper"
        domainaccount "UnpakSiamida/modules/account/domain"
        "time"

        "gorm.io/gorm"
)

type LoginCommandHandler struct {
        Repo domainaccount.IAccountRepository
}

func (h *LoginCommandHandler) Handle(
        ctx context.Context,
        cmd LoginCommand,
) (*domainaccount.LoginResult, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        user, err := h.Repo.Auth(ctx, cmd.Username, cmd.Password)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainaccount.InvalidCredential()
                }</span>
                <span class="cov8" title="1">return nil, err</span>
        }

        <span class="cov8" title="1">sid := user.UUID
        accessToken, refreshToken, err := helper.GenerateToken(sid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return &amp;domainaccount.LoginResult{
                AccessToken:  accessToken,
                RefreshToken: refreshToken,
                UserID:       sid,
        }, nil</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func LoginCommandValidation(cmd LoginCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Username,
                        validation.Required.Error("Username cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Password,
                        validation.Required.Error("Password cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file2" style="display: none">package application

import (
        "context"
        "errors"

        domainaccount "UnpakSiamida/modules/account/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type WhoamiCommandHandler struct {
        Repo domainaccount.IAccountRepository
}

func (h *WhoamiCommandHandler) Handle(
        ctx context.Context,
        cmd WhoamiCommand,
) (*domainaccount.Account, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        _, err := uuid.Parse(cmd.SID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domainaccount.NotFound(cmd.SID)
        }</span>

        <span class="cov8" title="1">user, err := h.Repo.Get(ctx, cmd.SID)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainaccount.InvalidCredential()
                }</span>
                <span class="cov8" title="1">return nil, err</span>
        }
        <span class="cov8" title="1">if user.ExtraRole == nil </span><span class="cov0" title="0">{
                user.ExtraRole = []domainaccount.ExtraRole{}
        }</span>

        <span class="cov8" title="1">return user, nil</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package application

import (
        helper "UnpakSiamida/common/helper"

        validation "github.com/go-ozzo/ozzo-validation/v4"
)

func WhoamiCommandValidation(cmd WhoamiCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.SID,
                        validation.Required.Error("SID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</span>
</pre>
		
		<pre class="file" id="file4" style="display: none">package domain

type Account struct {
        ID           string       `json:"-"`
        UUID         string       `json:"UUID"`
        NidnUsername string       `json:"Username"`
        Password     string       `json:"-"`
        Level        string       `json:"Level"`
        Name         string       `json:"Name"`
        Email        string       `json:"Email"`
        FakultasUnit string       `json:"FakultasUnit"`
        ExtraRole    []ExtraRole  `gorm:"-"; json:"ExtraRole,omitempty"`
}

func (Account) TableName() string <span class="cov0" title="0">{
        return "users"
}</pre>
		
		<pre class="file" id="file5" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func InvalidCredential() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Account.InvalidCredential", "invalid credentials")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Account.NotFound", fmt.Sprintf("Account with identifier %s not found", id))
}</span>
</pre>
		
		<pre class="file" id="file6" style="display: none">package application

import (
        "context"

        domainberitaacara "UnpakSiamida/modules/beritaacara/domain"
        "time"
)

type CreateBeritaAcaraCommandHandler struct {
        Repo domainberitaacara.IBeritaAcaraRepository
}

func (h *CreateBeritaAcaraCommandHandler) Handle(
        ctx context.Context,
        cmd CreateBeritaAcaraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        tanggal, err := time.Parse("2006-01-02", cmd.Tanggal)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainberitaacara.InvalidTanggal()
        }</span>

        //[pr] bagian auditee, auditor masih dalam bentuk int harusnya uuid
        <span class="cov8" title="1">result := domainberitaacara.NewBeritaAcara(
                cmd.Tahun,
                cmd.FakultasUnit,
                tanggal,
                cmd.Auditee,
                cmd.Auditor1,
                cmd.Auditor2,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">createBeritaAcara := result.Value
        if err := h.Repo.Create(ctx, createBeritaAcara); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">return result.Value.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file7" style="display: none">package application

import (
        helper "UnpakSiamida/common/helper"

        validation "github.com/go-ozzo/ozzo-validation/v4"
)

func CreateBeritaAcaraCommandValidation(cmd CreateBeritaAcaraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.FakultasUnit,
                        validation.Required.Error("FakultasUnit cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Tanggal,
                        validation.Required.Error("Tanggal cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</span>
</pre>
		
		<pre class="file" id="file8" style="display: none">package application

import (
        "context"

        domainberitaacara "UnpakSiamida/modules/beritaacara/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type DeleteBeritaAcaraCommandHandler struct {
        Repo domainberitaacara.IBeritaAcaraRepository
}

func (h *DeleteBeritaAcaraCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteBeritaAcaraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        BeritaAcaraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainberitaacara.InvalidUuid()
        }</span>

        // Get existing BeritaAcara
        <span class="cov8" title="1">_, err = h.Repo.GetByUuid(ctx, BeritaAcaraUUID)
        if err != nil </span><span class="cov8" title="1">{
                if err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                        return "", domainberitaacara.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // Delete by UUID
        <span class="cov8" title="1">if err := h.Repo.Delete(ctx, BeritaAcaraUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov8" title="1">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file9" style="display: none">package application

import (
        helper "UnpakSiamida/common/helper"

        validation "github.com/go-ozzo/ozzo-validation/v4"
)

func DeleteBeritaAcaraCommandValidation(cmd DeleteBeritaAcaraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</span>
</pre>
		
		<pre class="file" id="file10" style="display: none">package application

import (
        domainberitaacara "UnpakSiamida/modules/beritaacara/domain"
        "context"
        "time"
)

type GetAllBeritaAcarasQueryHandler struct {
        Repo domainberitaacara.IBeritaAcaraRepository
}

func (h *GetAllBeritaAcarasQueryHandler) Handle(
        ctx context.Context,
        q GetAllBeritaAcarasQuery,
) (domainberitaacara.PagedBeritaAcaras, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

        BeritaAcaras, total, err := h.Repo.GetAll(
                ctx,
                q.Search,
                q.SearchFilters,
                q.Page,
                q.Limit,
        )
        if err != nil </span><span class="cov0" title="0">{
                return domainberitaacara.PagedBeritaAcaras{}, err
        }</span>

        <span class="cov8" title="1">currentPage := 1
        totalPages := 1

        if q.Page != nil </span><span class="cov8" title="1">{
                currentPage = *q.Page
        }</span>
        <span class="cov8" title="1">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov8" title="1">{
                totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
        }</span>

        <span class="cov8" title="1">return domainberitaacara.PagedBeritaAcaras{
                Data:        BeritaAcaras,
                Total:       total,
                CurrentPage: currentPage,
                TotalPages:  totalPages,
        }, nil</span>
}
</pre>
		
		<pre class="file" id="file11" style="display: none">package application

import (
        "context"

        domainberitaacara "UnpakSiamida/modules/beritaacara/domain"
        "errors"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type GetBeritaAcaraByUuidQueryHandler struct {
        Repo domainberitaacara.IBeritaAcaraRepository
}

func (h *GetBeritaAcaraByUuidQueryHandler) Handle(
        ctx context.Context,
        q GetBeritaAcaraByUuidQuery,
) (*domainberitaacara.BeritaAcara, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

        parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov8" title="1">{
                return nil, domainberitaacara.NotFound(q.Uuid)
        }</span>

        <span class="cov8" title="1">inBeritaAcara, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainberitaacara.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

        <span class="cov8" title="1">return inBeritaAcara, nil</span>
}
</pre>
		
		<pre class="file" id="file12" style="display: none">package application

import (
        "context"

        domainberitaacara "UnpakSiamida/modules/beritaacara/domain"
        "errors"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type GetBeritaAcaraDefaultByUuidQueryHandler struct {
        Repo domainberitaacara.IBeritaAcaraRepository
}

func (h *GetBeritaAcaraDefaultByUuidQueryHandler) Handle(
        ctx context.Context,
        q GetBeritaAcaraDefaultByUuidQuery,
) (*domainberitaacara.BeritaAcaraDefault, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

        parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov8" title="1">{
                return nil, domainberitaacara.NotFound(q.Uuid)
        }</span>

        <span class="cov8" title="1">BeritaAcara, err := h.Repo.GetDefaultByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainberitaacara.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

        <span class="cov8" title="1">return BeritaAcara, nil</span>
}
</pre>
		
		<pre class="file" id="file13" style="display: none">package application

import (
        "context"

        domainberitaacara "UnpakSiamida/modules/beritaacara/domain"
)

type SetupUuidBeritaAcaraCommandHandler struct {
        Repo domainberitaacara.IBeritaAcaraRepository
}

func (h *SetupUuidBeritaAcaraCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidBeritaAcaraCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file14" style="display: none">package application

import (
        "context"

        domainberitaacara "UnpakSiamida/modules/beritaacara/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type UpdateBeritaAcaraCommandHandler struct {
        Repo domainberitaacara.IBeritaAcaraRepository
}

func (h *UpdateBeritaAcaraCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateBeritaAcaraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // -------------------------
        // VALIDATE UUID
        // -------------------------
        BeritaAcaraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainberitaacara.InvalidUuid()
        }</span>

        // -------------------------
        // GET EXISTING BeritaAcara
        // -------------------------
        <span class="cov8" title="1">existingBeritaAcara, err := h.Repo.GetByUuid(ctx, BeritaAcaraUUID) // ‚Üê memastikan pakai nama interface yg benar
        if err != nil </span><span class="cov0" title="0">{
                if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                        return "", domainberitaacara.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // -------------------------
        // AGGREGATE ROOT LOGIC
        // -------------------------

        <span class="cov8" title="1">tanggal, err := time.Parse("2006-01-02", cmd.Tanggal)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainberitaacara.InvalidTanggal()
        }</span>

        <span class="cov8" title="1">result := domainberitaacara.UpdateBeritaAcara(
                existingBeritaAcara,
                BeritaAcaraUUID,
                cmd.Tahun,
                cmd.FakultasUnit,
                tanggal,
                cmd.Auditee,
                cmd.Auditor1,
                cmd.Auditor2,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">updatedBeritaAcara := result.Value

        // -------------------------
        // SAVE TO REPOSITORY
        // -------------------------
        if err := h.Repo.Update(ctx, updatedBeritaAcara); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">return updatedBeritaAcara.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file15" style="display: none">package application

import (
        helper "UnpakSiamida/common/helper"

        validation "github.com/go-ozzo/ozzo-validation/v4"
)

func UpdateBeritaAcaraCommandValidation(cmd UpdateBeritaAcaraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.FakultasUnit,
                        validation.Required.Error("FakultasUnit cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Tanggal,
                        validation.Required.Error("Tanggal cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</span>
</pre>
		
		<pre class="file" id="file16" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/beritaacara/event"

        "github.com/google/uuid"
)

type BeritaAcara struct {
        common.Entity

        ID           uint      `gorm:"primaryKey;autoIncrement"`
        UUID         uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Tahun        string    `gorm:"column:tahun"`
        FakultasUnit int       `gorm:"column:fakultas_unit"`
        Tanggal      time.Time `gorm:"column:tanggal;type:date"`
        Auditee      *int      `gorm:"column:auditee"`
        Auditor1     *int      `gorm:"column:auditor1"`
        Auditor2     *int      `gorm:"column:auditor2"`
}

func (BeritaAcara) TableName() string <span class="cov0" title="0">{
        return "berita_acara"
}</span>

// === CREATE ===
func NewBeritaAcara(
        tahun string,
        fakultasUnit int,
        tanggal time.Time,
        auditee *int,
        auditor1 *int,
        auditor2 *int,
) common.ResultValue[*BeritaAcara] <span class="cov8" title="1">{

        BeritaAcara := &amp;BeritaAcara{
                UUID:         uuid.New(),
                Tahun:        tahun,
                FakultasUnit: fakultasUnit,
                Tanggal:      tanggal,
                Auditee:      auditee,
                Auditor1:     auditor1,
                Auditor2:     auditor2,
        }

        BeritaAcara.Raise(event.BeritaAcaraCreatedEvent{
                EventID:         uuid.New(),
                OccurredOn:      time.Now().UTC(),
                BeritaAcaraUUID: BeritaAcara.UUID,
        })

        return common.SuccessValue(BeritaAcara)
}</span>

// === UPDATE ===
func UpdateBeritaAcara(
        prev *BeritaAcara,
        uid uuid.UUID,
        tahun string,
        fakultasUnit int,
        tanggal time.Time,
        auditee *int,
        auditor1 *int,
        auditor2 *int,
) common.ResultValue[*BeritaAcara] <span class="cov8" title="1">{

        if prev == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*BeritaAcara](EmptyData())
        }</span>

        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*BeritaAcara](InvalidData())
        }</span>

        <span class="cov8" title="1">prev.Tahun = tahun
        prev.FakultasUnit = fakultasUnit
        prev.Tanggal = tanggal
        prev.Auditee = auditee
        prev.Auditor1 = auditor1
        prev.Auditor2 = auditor2

        prev.Raise(event.BeritaAcaraUpdatedEvent{
                EventID:         uuid.New(),
                OccurredOn:      time.Now().UTC(),
                BeritaAcaraUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file17" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("BeritaAcara.EmptyData", "data is not found")
}</span>

func InvalidTanggal() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("BeritaAcara.InvalidTanggal", "tanggal is invalid")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("BeritaAcara.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("BeritaAcara.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("BeritaAcara.NotFound", fmt.Sprintf("BeritaAcara with identifier %s not found", id))
}</span>
</pre>
		
		<pre class="file" id="file18" style="display: none">package application

import (
        "context"

        domaindokumentambahan "UnpakSiamida/modules/dokumentambahan/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type DeleteDokumenTambahanCommandHandler struct {
        Repo domaindokumentambahan.IDokumenTambahanRepository
}

func (h *DeleteDokumenTambahanCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteDokumenTambahanCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        dokumentambahanUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaindokumentambahan.InvalidUuid()
        }</span>

        // Get existing dokumentambahan
        <span class="cov8" title="1">_, err = h.Repo.GetByUuid(ctx, dokumentambahanUUID)
        if err != nil </span><span class="cov8" title="1">{
                if err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                        return "", domaindokumentambahan.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // Delete by UUID
        <span class="cov8" title="1">if err := h.Repo.Delete(ctx, dokumentambahanUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov8" title="1">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file19" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func DeleteDokumenTambahanCommandValidation(cmd DeleteDokumenTambahanCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file20" style="display: none">package application

import (
    "context"
    domaindokumentambahan "UnpakSiamida/modules/dokumentambahan/domain"
    "time"
)

type GetAllDokumenTambahansQueryHandler struct {
    Repo domaindokumentambahan.IDokumenTambahanRepository
}

func (h *GetAllDokumenTambahansQueryHandler) Handle(
    ctx context.Context,
    q GetAllDokumenTambahansQuery,
) (domaindokumentambahan.PagedDokumenTambahans, error) <span class="cov8" title="1">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    dokumentambahans, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domaindokumentambahan.PagedDokumenTambahans{}, err
    }</span>

    <span class="cov8" title="1">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov8" title="1">{
        currentPage = *q.Page
    }</span>
    <span class="cov8" title="1">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov8" title="1">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov8" title="1">return domaindokumentambahan.PagedDokumenTambahans{
        Data:  dokumentambahans,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file21" style="display: none">package application

import (
    "context"

    domaindokumentambahan "UnpakSiamida/modules/dokumentambahan/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetDokumenTambahanByUuidQueryHandler struct {
    Repo domaindokumentambahan.IDokumenTambahanRepository
}

func (h *GetDokumenTambahanByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetDokumenTambahanByUuidQuery,
) (*domaindokumentambahan.DokumenTambahan, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domaindokumentambahan.NotFound(q.Uuid)
        }</span>

    <span class="cov8" title="1">existingDokumenTambahan, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domaindokumentambahan.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov8" title="1">return existingDokumenTambahan, nil</span>
}
</pre>
		
		<pre class="file" id="file22" style="display: none">package application

import (
        "context"

        domaindokumentambahan "UnpakSiamida/modules/dokumentambahan/domain"
        "errors"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type GetDokumenTambahanDefaultByUuidQueryHandler struct {
        Repo domaindokumentambahan.IDokumenTambahanRepository
}

func (h *GetDokumenTambahanDefaultByUuidQueryHandler) Handle(
        ctx context.Context,
        q GetDokumenTambahanDefaultByUuidQuery,
) (*domaindokumentambahan.DokumenTambahanDefault, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

        parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domaindokumentambahan.NotFound(q.Uuid)
        }</span>

        <span class="cov8" title="1">existingDokumenTambahan, err := h.Repo.GetDefaultByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domaindokumentambahan.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

        <span class="cov8" title="1">return existingDokumenTambahan, nil</span>
}
</pre>
		
		<pre class="file" id="file23" style="display: none">package application

import (
        "context"

        domaindokumentambahan "UnpakSiamida/modules/dokumentambahan/domain"
)

type SetupUuidDokumenTambahanCommandHandler struct {
        Repo domaindokumentambahan.IDokumenTambahanRepository
}

func (h *SetupUuidDokumenTambahanCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidDokumenTambahanCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file24" style="display: none">package application

import (
        domaindokumentambahan "UnpakSiamida/modules/dokumentambahan/domain"
        domainrenstra "UnpakSiamida/modules/renstra/domain"
        "context"
        "time"

        "github.com/google/uuid"
        "golang.org/x/sync/errgroup"
        "gorm.io/gorm"
)

type UpdateDokumenTambahanCommandHandler struct {
        Repo        domaindokumentambahan.IDokumenTambahanRepository
        RepoRenstra domainrenstra.IRenstraRepository
}

func (h *UpdateDokumenTambahanCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateDokumenTambahanCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        dokumenTambahanUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaindokumentambahan.InvalidUuid()
        }</span>

        <span class="cov0" title="0">renstraUUID, err := uuid.Parse(cmd.UuidRenstra)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaindokumentambahan.InvalidRenstra()
        }</span>

        //paralel
        <span class="cov0" title="0">var (
                prev    *domaindokumentambahan.DokumenTambahan
                renstra *domainrenstra.Renstra
        )

        g, gctx := errgroup.WithContext(ctx)

        g.Go(func() error </span><span class="cov0" title="0">{
                var err error
                prev, err = h.Repo.GetByUuid(gctx, dokumenTambahanUUID)
                if err != nil </span><span class="cov0" title="0">{
                        if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                                return domaindokumentambahan.NotFound(cmd.Uuid)
                        }</span>
                        <span class="cov0" title="0">return err</span>
                }
                <span class="cov0" title="0">return nil</span>
        })

        <span class="cov0" title="0">g.Go(func() error </span><span class="cov0" title="0">{
                var err error
                renstra, err = h.RepoRenstra.GetByUuid(gctx, renstraUUID)
                if err != nil </span><span class="cov0" title="0">{
                        if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                                return domaindokumentambahan.NotFoundRenstra(cmd.Uuid)
                        }</span>
                        <span class="cov0" title="0">return err</span>
                }
                <span class="cov0" title="0">return nil</span>
        })

        <span class="cov0" title="0">if err := g.Wait(); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">result := domaindokumentambahan.UpdateDokumenTambahan(
                prev,
                renstra,
                dokumenTambahanUUID,
                renstraUUID,
                cmd.Tahun,
                cmd.Mode,
                cmd.Granted,
                cmd.Link,
                cmd.CapaianAuditor,
                cmd.CatatanAuditor,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov0" title="0">dokumenTambahan := result.Value

        if err := h.Repo.Update(ctx, dokumenTambahan); err != nil </span><span class="cov0" title="0">{
                //[note] ini harusnya ada di generate renstra bagian create + update
                //ini rule mustahil masuk, tapi memungkinan jika datanya hardcode oleh developer untuk duplicate lalu di update baru kena ini
                //ini tidak dapat di tes karena di domainnya ada rule pengecekan prev data
                // var mysqlErr *mysql.MySQLError
                // if errors.As(err, &amp;mysqlErr) {
                //         if mysqlErr.Number == 1062 {
                //                 return "", domaindokumentambahan.DuplicateData()
                //         }
                // }
                // if strings.Contains(err.Error(), "Duplicate entry") {
                //         return "", domaindokumentambahan.DuplicateData()
                // }

                return "", err
        }</span>

        <span class="cov0" title="0">return dokumenTambahan.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file25" style="display: none">package application

import (
        helper "UnpakSiamida/common/helper"

        validation "github.com/go-ozzo/ozzo-validation/v4"
)

func UpdateDokumenTambahanCommandValidation(cmd UpdateDokumenTambahanCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,

                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.UuidRenstra,
                        validation.Required.Error("UUID Renstra cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Mode,
                        validation.Required.Error("Mode cannot be blank"),
                        validation.In("auditee", "auditor1", "auditor2").Error("Mode must be auditee, auditor1 or auditor2"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Granted,
                        validation.Required.Error("Granted cannot be blank"),
                ),

                /*
                        [vuln] case jika link bukan google drive maupun unpak, serangan yg memungkinkan memasukkan link external yg dimana tujuannya mengambil token pengguna seperti admin maupun auditor
                        CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:L/A:N (8.1)
                        | Metric                       | Value            | Alasan                           |
                        | ---------------------------- | ---------------- | -------------------------------- |
                        | Attack Vector (AV)                  | Network (N)      | Link via web                     |
                        | Attack Complexity (AC)       | Low (L)          | Cukup klik link                  |
                        | Privileges Required (PR)     | Low (L)          | Auditee bisa submit              |
                        | User Interaction (UI)        | Required (R)     | Admin/Auditor harus klik         |
                        | Scope (S)                    | Changed (C)      | Token dicuri ‚Üí akses sistem lain |
                        | Confidentiality (C)          | High (H)         | Token auth                       |
                        | Integrity (I)                | Low (L)          | Impersonation                    |
                        | Availability (A)             | None (N)         | Tidak DoS                        |
                */
                validation.Field(&amp;cmd.Link,
                        validation.When(cmd.Mode == "auditee",
                                validation.Required.Error("Link cannot be blank for auditee"),
                                validation.By(helper.NoXSSFullScanWithDecode()),
                        ),
                ),

                validation.Field(&amp;cmd.CapaianAuditor,
                        validation.When(cmd.Mode == "auditor1",
                                validation.Required.Error("CapaianAuditor cannot be blank for auditor1"),
                                validation.By(helper.NoXSSFullScanWithDecode()),
                        ),
                ),
        )
}</span>
</pre>
		
		<pre class="file" id="file26" style="display: none">package domain

import (
        "strings"
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/dokumentambahan/event"
        domainrenstra "UnpakSiamida/modules/renstra/domain"

        "github.com/google/uuid"
)

type DokumenTambahan struct {
        common.Entity

        ID                      uint      `gorm:"primaryKey;autoIncrement"`
        UUID                    uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Renstra                 uint      `gorm:"column:id_renstra;"`
        TemplateDokumenTambahan uint      `gorm:"column:id_template_dokumen_tambahan;"`
        Link                    *string   `gorm:"column:file"`
        CapaianAuditor          *string   `gorm:"column:capaian_auditor;"`
        CatatanAuditor          *string   `gorm:"column:catatan_auditor;"`
}

func (DokumenTambahan) TableName() string <span class="cov0" title="0">{
        return "dokumen_tambahan"
}</span>

func UpdateDokumenTambahan(
        prev *DokumenTambahan,
        renstra *domainrenstra.Renstra,
        Uuid uuid.UUID,
        UuidRenstra uuid.UUID,
        Tahun string,
        Mode string,
        Granted string,
        Link *string,
        CapaianAuditor *string,
        CatatanAuditor *string,
) common.ResultValue[*DokumenTambahan] <span class="cov8" title="1">{

        if renstra == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*DokumenTambahan](InvalidRenstra())
        }</span>

        <span class="cov8" title="1">if prev == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*DokumenTambahan](EmptyData())
        }</span>

        <span class="cov8" title="1">if prev.UUID != Uuid ||
                renstra.UUID != UuidRenstra ||
                renstra.Tahun != Tahun </span><span class="cov8" title="1">{
                return common.FailureValue[*DokumenTambahan](InvalidData())
        }</span>

        <span class="cov8" title="1">if !contains([]string{"auditee", "auditor2"}, Mode) </span><span class="cov8" title="1">{
                return common.FailureValue[*DokumenTambahan](RejectAction())
        }</span>

        <span class="cov8" title="1">if !IsGrantedAccess(Tahun, Mode, Granted) </span><span class="cov8" title="1">{
                return common.FailureValue[*DokumenTambahan](NotGranted())
        }</span>

        <span class="cov8" title="1">switch Mode </span>{
        case "auditee":<span class="cov8" title="1">
                prev.Link = Link</span>

        case "auditor2":<span class="cov8" title="1">
                prev.CapaianAuditor = CapaianAuditor
                prev.CatatanAuditor = CatatanAuditor</span>
        }

        <span class="cov8" title="1">prev.Raise(event.DokumenTambahanUpdatedEvent{ //[pr] ketika tersave maka buat kts
                EventID:             uuid.New(),
                OccurredOn:          time.Now().UTC(),
                DokumenTambahanUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}

func contains(list []string, value string) bool <span class="cov8" title="1">{
        for _, v := range list </span><span class="cov8" title="1">{
                if v == value </span><span class="cov8" title="1">{
                        return true
                }</span>
        }
        <span class="cov8" title="1">return false</span>
}

func IsGrantedAccess(tahun, mode, granted string) bool <span class="cov8" title="1">{
        requiredKey := tahun + "#" + mode

        grantedList := strings.Split(granted, ",")

        for _, g := range grantedList </span><span class="cov8" title="1">{
                if strings.TrimSpace(g) == requiredKey </span><span class="cov8" title="1">{
                        return true
                }</span>
        }

        <span class="cov8" title="1">return false</span>
}
</pre>
		
		<pre class="file" id="file27" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("DokumenTambahan.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("DokumenTambahan.InvalidUuid", "uuid is invalid")
}</span>

func InvalidRenstra() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("DokumenTambahan.InvalidRenstra", "renstra is invalid")
}</span>

func RejectAction() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("DokumenTambahan.RejectAction", "your action was rejected")
}</span>

func NotGranted() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("DokumenTambahan.NotGranted", "you are not granted permission in this action")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("DokumenTambahan.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("DokumenTambahan.NotFound", fmt.Sprintf("DokumenTambahan with identifier %s not found", id))
}</span>
func NotFoundRenstra(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("DokumenTambahan.NotFoundRenstra", fmt.Sprintf("Renstra with identifier %s not found", id))
}</span>

func DuplicateData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("DokumenTambahan.DuplicateData", "data not allowed duplicate")
}</span>
</pre>
		
		<pre class="file" id="file28" style="display: none">package application

import (
    "context"
    "time"
    domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
)

type GetAllFakultasUnitsQueryHandler struct {
    Repo domainfakultasunit.IFakultasUnitRepository
}

func (h *GetAllFakultasUnitsQueryHandler) Handle(
    ctx context.Context,
    q GetAllFakultasUnitsQuery,
) (domainfakultasunit.PagedFakultasUnits, error) <span class="cov8" title="1">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()
    
    fakultasunits, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domainfakultasunit.PagedFakultasUnits{}, err
    }</span>

    <span class="cov8" title="1">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov8" title="1">{
        currentPage = *q.Page
    }</span>
    <span class="cov8" title="1">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov8" title="1">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov8" title="1">return domainfakultasunit.PagedFakultasUnits{
        Data:  fakultasunits,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file29" style="display: none">package application

import (
    "context"

    domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetFakultasUnitByUuidQueryHandler struct {
    Repo domainfakultasunit.IFakultasUnitRepository
}

func (h *GetFakultasUnitByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetFakultasUnitByUuidQuery,
) (*domainfakultasunit.FakultasUnit, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov8" title="1">{
                return nil, domainfakultasunit.NotFound(q.Uuid)
        }</span>

    <span class="cov8" title="1">fakultasunit, err := h.Repo.GetDefaultByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainfakultasunit.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov8" title="1">return fakultasunit, nil</span>
}
</pre>
		
		<pre class="file" id="file30" style="display: none">package application

import (
        "context"

        domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
)

type SetupUuidFakultasUnitCommandHandler struct {
        Repo domainfakultasunit.IFakultasUnitRepository
}

func (h *SetupUuidFakultasUnitCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidFakultasUnitCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file31" style="display: none">package domain

import (
        common "UnpakSiamida/common/domain"

        "github.com/google/uuid"
)

type FakultasUnit struct {
        common.Entity
        ID           uint       `gorm:""`
        UUID         uuid.UUID  `gorm:"type:char(36);"`
        Nama         string     `gorm:"column:nama_fak_prod_unit;"`
        KodeJenjang  string     `gorm:"column:kode_jenjang;"`
        Jenjang      string     `gorm:"column:jenjang;"`
        Type         string     `gorm:"column:type;"`
        Fakultas     string     `gorm:"column:fakultas;"`
}
func (FakultasUnit) TableName() string <span class="cov0" title="0">{
        return "v_fakultas_unit"
}</pre>
		
		<pre class="file" id="file32" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("FakultasUnit.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("FakultasUnit.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("FakultasUnit.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("FakultasUnit.NotFound", fmt.Sprintf("FakultasUnit with identifier %s not found", id))
}</span>
</pre>
		
		<pre class="file" id="file33" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        helper "UnpakSiamida/common/helper"
        event "UnpakSiamida/modules/generaterenstra/event"

        "github.com/google/uuid"
)

type GenerateDokumenTambahan struct {
        common.Entity

        ID                      uint      `gorm:"primaryKey;autoIncrement"`
        UUID                    uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        RenstraId               uint      `gorm:"column:id_renstra;"`
        TemplateDokumenTambahan uint      `gorm:"column:id_template_dokumen_tambahan;"`
        Tugas                   string    `gorm:""`
}

func (GenerateDokumenTambahan) TableName() string <span class="cov0" title="0">{
        return "dokumen_tambahan"
}</span>

func NewGenerateDokumenTambahan(
        tahun string, //tahun template
        renstraTahun string, //tahun renstra

        fakultasUnit uint, //fakunit template
        renstraFakultasUnit uint, //fakunit renstra

        renstraId uint,

        template uint,
        templateUuid string,
        jenisFile string,
        tugas string,
        operation string,
) common.ResultValue[*GenerateDokumenTambahan] <span class="cov0" title="0">{

        if renstraTahun != tahun </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateDokumenTambahan](InvalidTahunDokumenTambahan(templateUuid, jenisFile, tahun, renstraTahun, operation))
        }</span>
        <span class="cov0" title="0">if renstraFakultasUnit != fakultasUnit </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateDokumenTambahan](InvalidFakultasUnit())
        }</span>
        <span class="cov0" title="0">if template &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateDokumenTambahan](InvalidTemplate())
        }</span>
        <span class="cov0" title="0">if renstraId &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateDokumenTambahan](InvalidRenstra())
        }</span>
        <span class="cov0" title="0">if !helper.IsValidTugas(tugas) </span><span class="cov0" title="0">{
                return common.FailureValue[*GenerateDokumenTambahan](InvalidTugas())
        }</span>

        <span class="cov0" title="0">renstra := &amp;GenerateDokumenTambahan{
                UUID:                    uuid.New(),
                RenstraId:               renstraId,
                TemplateDokumenTambahan: template,
                Tugas:                   tugas,
        }

        renstra.Raise(event.GenerateDokumenTambahanCreatedEvent{
                EventID:                     uuid.New(),
                OccurredOn:                  time.Now().UTC(),
                GenerateDokumenTambahanUUID: renstra.UUID,
        })

        return common.SuccessValue(renstra)</span>
}
</pre>
		
		<pre class="file" id="file34" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        helper "UnpakSiamida/common/helper"
        event "UnpakSiamida/modules/generaterenstra/event"

        "github.com/google/uuid"
)

type GenerateRenstra struct {
        common.Entity

        ID              uint      `gorm:"primaryKey;autoIncrement"`
        UUID            uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        RenstraId       uint      `gorm:"column:id_renstra;"`
        TemplateRenstra uint      `gorm:"column:template_renstra;"`
        Tugas           string    `gorm:""`
}

func (GenerateRenstra) TableName() string <span class="cov0" title="0">{
        return "renstra_nilai"
}</span>

func NewGenerateRenstra(
        tahun string, //tahun template
        renstraTahun string, //tahun renstra

        fakultasUnit uint, //fakunit template
        renstraFakultasUnit uint, //fakunit renstra

        renstraId uint,

        template uint,
        templateUuid string,
        indikator string,
        tugas string,
        operation string,
) common.ResultValue[*GenerateRenstra] <span class="cov8" title="1">{

        if renstraTahun != tahun </span><span class="cov8" title="1">{
                return common.FailureValue[*GenerateRenstra](InvalidTahunRenstra(templateUuid, indikator, tahun, renstraTahun, operation))
        }</span>
        <span class="cov8" title="1">if renstraFakultasUnit != fakultasUnit </span><span class="cov8" title="1">{
                return common.FailureValue[*GenerateRenstra](InvalidFakultasUnit())
        }</span>
        <span class="cov8" title="1">if template &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*GenerateRenstra](InvalidTemplate())
        }</span>
        <span class="cov8" title="1">if renstraId &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*GenerateRenstra](InvalidRenstra())
        }</span>
        <span class="cov8" title="1">if !helper.IsValidTugas(tugas) </span><span class="cov8" title="1">{
                return common.FailureValue[*GenerateRenstra](InvalidTugas())
        }</span>

        <span class="cov8" title="1">renstra := &amp;GenerateRenstra{
                UUID:            uuid.New(),
                RenstraId:       renstraId,
                TemplateRenstra: template,
                Tugas:           tugas,
        }

        renstra.Raise(event.GenerateRenstraCreatedEvent{
                EventID:             uuid.New(),
                OccurredOn:          time.Now().UTC(),
                GenerateRenstraUUID: renstra.UUID,
        })

        return common.SuccessValue(renstra)</span>
}
</pre>
		
		<pre class="file" id="file35" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.NotFound", fmt.Sprintf("GenerateRenstra with identifier %s not found", id))
}</span>
func NotFoundFakultasUnit(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.NotFoundFakultasUnit", fmt.Sprintf("Fakultas unit with identifier %s not found", id))
}</span>
func NotFoundRenstra(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.NotFoundRenstra", fmt.Sprintf("renstra with identifier %s not found", id))
}</span>
func NotFoundTemplate(tahun string, fakultas string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.NotFoundTemplate", fmt.Sprintf("template not found with identifier tahun %s &amp; fakultas %s", tahun, fakultas))
}</span>
func NotFoundAudit(tahun string, fakultas string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.NotFoundAudit", fmt.Sprintf("previous audit not found with identifier tahun %s &amp; fakultas %s", tahun, fakultas))
}</span>

func InvalidFakultasUnit() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.InvalidFakultasUnit", "fakultas unit is invalid")
}</span>

func InvalidTahunRenstra(
        templateUuidExisting string,
        indikatorExisting string,
        tahunTemplateExisting string,
        tahun string,
        operation string,
) domain.Error <span class="cov8" title="1">{

        action := "rollback"
        if operation == "insert" </span><span class="cov8" title="1">{
                action = "generated"
        }</span>

        <span class="cov8" title="1">nextSugestion := "Please manually delete the problematic audit questions, then you can regenerate them."
        if operation == "insert" </span><span class="cov8" title="1">{
                nextSugestion = "Please check the year of the indicator question again, is it correct?"
        }</span>

        <span class="cov8" title="1">return domain.NotFoundError(
                "GenerateRenstra.InvalidTahunRenstra",
                fmt.Sprintf(
                        "template %s with indicator '%s (%s)' cannot be %s because the indicator year does not match the audit year (%s). %s",
                        templateUuidExisting,
                        indikatorExisting,
                        tahunTemplateExisting,
                        action,
                        tahun,
                        nextSugestion,
                ),
        )</span>
}

func InvalidTahunDokumenTambahan(
        templateUuidExisting string,
        jenisFileExisting string,
        tahunTemplateExisting string,
        tahun string,
        operation string,
) domain.Error <span class="cov8" title="1">{

        action := "rollback"
        if operation == "insert" </span><span class="cov8" title="1">{
                action = "generated"
        }</span>

        <span class="cov8" title="1">nextSugestion := "Please manually delete the problematic audit questions, then you can regenerate them."
        if operation == "insert" </span><span class="cov8" title="1">{
                nextSugestion = "Please check the year of the jenis file question again, is it correct?"
        }</span>

        <span class="cov8" title="1">return domain.NotFoundError(
                "GenerateRenstra.InvalidTahunDokumenTambahan",
                fmt.Sprintf(
                        "template %s with jenis file '%s (%s)' cannot be %s because the jenis file year does not match the audit year (%s). %s",
                        templateUuidExisting,
                        jenisFileExisting,
                        tahunTemplateExisting,
                        action,
                        tahun,
                        nextSugestion,
                ),
        )</span>
}

func InvalidTemplate() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.InvalidTemplate", "template is invalid")
}</span>

func InvalidRenstra() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.InvalidRenstra", "renstra is invalid")
}</span>

func InvalidType(tipe string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.InvalidType", fmt.Sprintf(
                "type %s is invalid",
                tipe,
        ))
}</span>

func InvalidTugas() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.InvalidTugas", "tugas is invalid")
}</span>

func InvalidParsing(target string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("GenerateRenstra.InvalidParsing", fmt.Sprintf("failed parsing %s to UUID", target))
}</span>
</pre>
		
		<pre class="file" id="file36" style="display: none">package application

import (
        "context"
        // "strconv"
        // "errors"
    // "gorm.io/gorm"
        "github.com/google/uuid"
        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
        domainstandarrenstra "UnpakSiamida/modules/standarrenstra/domain"
        // helper "UnpakSiamida/common/helper"
        "time"
)

type CreateIndikatorRenstraCommandHandler struct{
        Repo domainindikatorrenstra.IIndikatorRenstraRepository
        RepoStandarRenstra domainstandarrenstra.IStandarRenstraRepository
}

func (h *CreateIndikatorRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd CreateIndikatorRenstraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        standarrenstraUUID, err := uuid.Parse(cmd.StandarRenstra)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainindikatorrenstra.InvalidParent()
        }</span>

        <span class="cov8" title="1">var standar *uint
        standarRenstra, err := h.RepoStandarRenstra.GetByUuid(ctx, standarrenstraUUID)
        if err != nil </span><span class="cov8" title="1">{
                standar = nil
        }</span> else<span class="cov8" title="1"> {
                standar = &amp;standarRenstra.ID
        }</span>

        <span class="cov8" title="1">var parentUUID uuid.UUID
        if cmd.Parent != nil &amp;&amp; *cmd.Parent != "" </span><span class="cov0" title="0">{
                parsed, err := uuid.Parse(*cmd.Parent)
                if err != nil </span><span class="cov0" title="0">{
                        parentUUID = uuid.Nil
                }</span> else<span class="cov0" title="0">{
                        parentUUID = parsed
                }</span>
        } else<span class="cov8" title="1"> {
                parentUUID = uuid.Nil
        }</span> 

        <span class="cov8" title="1">var parent *uint
        parentIndikator, err := h.Repo.GetDefaultByUuid(ctx, parentUUID)
        if err != nil </span><span class="cov8" title="1">{
                parent = nil
        }</span> else<span class="cov0" title="0"> {
                parent = &amp;parentIndikator.Id
        }</span>

        <span class="cov8" title="1">operator := cmd.Operator

        isUnique, err := h.Repo.IsUniqueIndikator(ctx, cmd.Indikator, cmd.Tahun)
        if err != nil </span><span class="cov8" title="1">{
                return "", err
        }</span>

        <span class="cov8" title="1">result := domainindikatorrenstra.NewIndikatorRenstra(
                cmd.Indikator,
                standar,
                parent,
                cmd.Tahun,
                cmd.TipeTarget,
                operator,
                isUnique,
        )

        if !result.IsSuccess </span><span class="cov8" title="1">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">indikatorRenstra := result.Value

        if err := h.Repo.Create(ctx, indikatorRenstra); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">return indikatorRenstra.UUID.String(), nil</span>
}</pre>
		
		<pre class="file" id="file37" style="display: none">package application

import (
        helper "UnpakSiamida/common/helper"

        validation "github.com/go-ozzo/ozzo-validation/v4"
)

func CreateIndikatorRenstraCommandValidation(cmd CreateIndikatorRenstraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,

                validation.Field(&amp;cmd.StandarRenstra,
                        validation.Required.Error("Standar Renstra cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Indikator,
                        validation.Required.Error("Indikator cannot be blank"),
                ),

                validation.Field(&amp;cmd.Parent,
                        validation.By(helper.ValidateParent),
                        validation.When(cmd.Parent != nil,
                                validation.By(helper.ValidateUUIDv4),
                        ),
                ),

                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.TipeTarget,
                        validation.Required.Error("Tipe Target cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</span>
</pre>
		
		<pre class="file" id="file38" style="display: none">package application

import (
        "context"
        "errors"

        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type DeleteIndikatorRenstraCommandHandler struct {
        Repo domainindikatorrenstra.IIndikatorRenstraRepository
}

func (h *DeleteIndikatorRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteIndikatorRenstraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        indikatorrenstraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainindikatorrenstra.InvalidUuid()
        }</span>

        // Get existing indikatorrenstra
        <span class="cov8" title="1">_, err = h.Repo.GetByUuid(ctx, indikatorrenstraUUID)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return "", domainindikatorrenstra.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // Delete by UUID
        <span class="cov8" title="1">if err := h.Repo.Delete(ctx, indikatorrenstraUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov8" title="1">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file39" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func DeleteIndikatorRenstraCommandValidation(cmd DeleteIndikatorRenstraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file40" style="display: none">package application

import (
    "context"
    domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
    "time"
)

type GetAllIndikatorRenstrasQueryHandler struct {
    Repo domainindikatorrenstra.IIndikatorRenstraRepository
}

func (h *GetAllIndikatorRenstrasQueryHandler) Handle(
    ctx context.Context,
    q GetAllIndikatorRenstrasQuery,
) (domainindikatorrenstra.PagedIndikatorRenstras, error) <span class="cov8" title="1">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    indikatorrenstras, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domainindikatorrenstra.PagedIndikatorRenstras{}, err
    }</span>

    <span class="cov8" title="1">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov8" title="1">{
        currentPage = *q.Page
    }</span>
    <span class="cov8" title="1">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov8" title="1">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov8" title="1">return domainindikatorrenstra.PagedIndikatorRenstras{
        Data:  indikatorrenstras,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file41" style="display: none">package application

import (
    "context"

    domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetIndikatorRenstraByUuidQueryHandler struct {
    Repo domainindikatorrenstra.IIndikatorRenstraRepository
}

func (h *GetIndikatorRenstraByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetIndikatorRenstraByUuidQuery,
) (*domainindikatorrenstra.IndikatorRenstra, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov8" title="1">{
                return nil, domainindikatorrenstra.NotFound(q.Uuid)
        }</span>

    <span class="cov8" title="1">inindikatorrenstra, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainindikatorrenstra.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov8" title="1">return inindikatorrenstra, nil</span>
}
</pre>
		
		<pre class="file" id="file42" style="display: none">package application

import (
        "context"

        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
        "errors"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type GetIndikatorRenstraDefaultByUuidQueryHandler struct {
        Repo domainindikatorrenstra.IIndikatorRenstraRepository
}

func (h *GetIndikatorRenstraDefaultByUuidQueryHandler) Handle(
        ctx context.Context,
        q GetIndikatorRenstraDefaultByUuidQuery,
) (*domainindikatorrenstra.IndikatorRenstraDefault, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

        parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov8" title="1">{
                return nil, domainindikatorrenstra.NotFound(q.Uuid)
        }</span>

        <span class="cov8" title="1">inindikatorrenstra, err := h.Repo.GetDefaultByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainindikatorrenstra.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

        <span class="cov8" title="1">return inindikatorrenstra, nil</span>
}
</pre>
		
		<pre class="file" id="file43" style="display: none">package application

import (
        "context"

        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
)

type SetupUuidIndikatorRenstraCommandHandler struct {
        Repo domainindikatorrenstra.IIndikatorRenstraRepository
}

func (h *SetupUuidIndikatorRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidIndikatorRenstraCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file44" style="display: none">package application

import (
        "context"
        "errors"

        // "strconv"
        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
        domainstandarrenstra "UnpakSiamida/modules/standarrenstra/domain"

        // helper "UnpakSiamida/common/helper"
        "github.com/google/uuid"
        "gorm.io/gorm"

        // "errors"
        // "gorm.io/gorm"
        "time"
)

type UpdateIndikatorRenstraCommandHandler struct {
        Repo               domainindikatorrenstra.IIndikatorRenstraRepository
        RepoStandarRenstra domainstandarrenstra.IStandarRenstraRepository
}

func (h *UpdateIndikatorRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateIndikatorRenstraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        indikatorrenstraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainindikatorrenstra.InvalidUuid()
        }</span>

        <span class="cov8" title="1">existingIndikatorRenstra, err := h.Repo.GetByUuid(ctx, indikatorrenstraUUID) // ‚Üê memastikan pakai nama interface yg benar
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return "", domainindikatorrenstra.NotFound(cmd.Uuid)
                }</span>
                <span class="cov8" title="1">return "", err</span>
        }

        <span class="cov8" title="1">standarrenstraUUID, err := uuid.Parse(cmd.StandarRenstra)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainindikatorrenstra.InvalidParent()
        }</span>

        <span class="cov8" title="1">var standar *uint
        standarRenstra, err := h.RepoStandarRenstra.GetByUuid(ctx, standarrenstraUUID)
        if err != nil </span><span class="cov8" title="1">{
                standar = nil
        }</span> else<span class="cov8" title="1"> {
                standar = &amp;standarRenstra.ID
        }</span>

        <span class="cov8" title="1">var parentUUID uuid.UUID
        if cmd.Parent != nil &amp;&amp; *cmd.Parent != "" </span><span class="cov0" title="0">{
                parsed, err := uuid.Parse(*cmd.Parent)
                if err != nil </span><span class="cov0" title="0">{
                        parentUUID = uuid.Nil
                }</span> else<span class="cov0" title="0"> {
                        parentUUID = parsed
                }</span>
        } else<span class="cov8" title="1"> {
                parentUUID = uuid.Nil
        }</span>

        <span class="cov8" title="1">var parent *uint
        parentIndikator, err := h.Repo.GetDefaultByUuid(ctx, parentUUID)
        if err != nil </span><span class="cov8" title="1">{
                parent = nil
        }</span> else<span class="cov0" title="0"> {
                parent = &amp;parentIndikator.Id
        }</span>

        // -------------------------
        // AGGREGATE ROOT LOGIC
        // -------------------------
        <span class="cov8" title="1">result := domainindikatorrenstra.UpdateIndikatorRenstra(
                existingIndikatorRenstra,
                indikatorrenstraUUID,
                cmd.Indikator,
                standar,
                parent,
                cmd.Tahun,
                cmd.TipeTarget,
                cmd.Operator,
                // isUnique,
        )

        if !result.IsSuccess </span><span class="cov8" title="1">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">updatedIndikatorRenstra := result.Value

        // -------------------------
        // SAVE TO REPOSITORY
        // -------------------------
        if err := h.Repo.Update(ctx, updatedIndikatorRenstra); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">return updatedIndikatorRenstra.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file45" style="display: none">package application

import (
        helper "UnpakSiamida/common/helper"

        validation "github.com/go-ozzo/ozzo-validation/v4"
)

func UpdateIndikatorRenstraCommandValidation(cmd UpdateIndikatorRenstraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.StandarRenstra,
                        validation.Required.Error("Standar Renstra cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Indikator,
                        validation.Required.Error("Indikator cannot be blank"),
                ),

                validation.Field(&amp;cmd.Parent,
                        validation.By(helper.ValidateParent),
                        validation.When(cmd.Parent != nil,
                                validation.By(helper.ValidateUUIDv4),
                        ),
                ),

                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.TipeTarget,
                        validation.Required.Error("Tipe Target cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</span>
</pre>
		
		<pre class="file" id="file46" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/indikatorrenstra/event"

        "github.com/google/uuid"
)

type IndikatorRenstra struct {
        common.Entity

        ID             uint      `gorm:"primaryKey;autoIncrement"`
        UUID           uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        StandarRenstra *uint     `gorm:"column:id_master_standar;"`
        Indikator      string    `gorm:"type:longtext;not null"`
        Parent         *uint     `gorm:""`
        Tahun          string    `gorm:"size:255;not null"`
        TipeTarget     string    `gorm:"size:255;not null"`
        Operator       *string   `gorm:""`
}

func (IndikatorRenstra) TableName() string <span class="cov0" title="0">{
        return "master_indikator_renstra"
}</span>

func NewIndikatorRenstra(
        indikator string,
        standar *uint,
        parent *uint,
        tahun string,
        tipeTarget string,
        operator *string,
        isUniqueIndikator bool,
) common.ResultValue[*IndikatorRenstra] <span class="cov8" title="1">{

        if standar == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*IndikatorRenstra](InvalidStandar())
        }</span>

        <span class="cov8" title="1">if !isUniqueIndikator </span><span class="cov8" title="1">{
                return common.FailureValue[*IndikatorRenstra](NotUniqueIndikator())
        }</span>

        <span class="cov8" title="1">ir := &amp;IndikatorRenstra{
                UUID:           uuid.New(),
                Indikator:      indikator,
                StandarRenstra: standar,
                Parent:         parent,
                Tahun:          tahun,
                TipeTarget:     tipeTarget,
                Operator:       operator,
        }

        ir.Raise(event.IndikatorRenstraCreatedEvent{
                EventID:              uuid.New(),
                OccurredOn:           time.Now().UTC(),
                IndikatorRenstraUUID: ir.UUID,
        })

        return common.SuccessValue(ir)</span>
}

func UpdateIndikatorRenstra(
        prev *IndikatorRenstra,
        uid uuid.UUID,
        indikator string,
        standar *uint,
        parent *uint,
        tahun string,
        tipeTarget string,
        operator *string,
        // isUniqueIndikator bool,
) common.ResultValue[*IndikatorRenstra] <span class="cov8" title="1">{

        if standar == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*IndikatorRenstra](InvalidStandar())
        }</span>

        // if !isUniqueIndikator {
        //         return common.FailureValue[*IndikatorRenstra](NotUniqueIndikator())
        // }

        <span class="cov8" title="1">if prev == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*IndikatorRenstra](EmptyData())
        }</span>

        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*IndikatorRenstra](InvalidData())
        }</span>

        // always overwrite (required field)
        <span class="cov8" title="1">prev.Indikator = indikator
        prev.Tahun = tahun
        prev.TipeTarget = tipeTarget

        // optional pointer fields updated only if not nil
        prev.StandarRenstra = standar

        if parent != nil </span><span class="cov8" title="1">{
                prev.Parent = parent
        }</span>

        <span class="cov8" title="1">if operator != nil </span><span class="cov8" title="1">{
                prev.Operator = operator
        }</span>

        <span class="cov8" title="1">prev.Raise(event.IndikatorRenstraUpdatedEvent{
                EventID:              uuid.New(),
                OccurredOn:           time.Now().UTC(),
                IndikatorRenstraUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file47" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("IndikatorRenstra.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("IndikatorRenstra.InvalidUuid", "uuid is invalid")
}</span>

func InvalidStandar() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("IndikatorRenstra.InvalidStandar", "standar renstra is invalid")
}</span>

func InvalidParent() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("IndikatorRenstra.InvalidParent", "parent is invalid")
}</span>

func NotFoundParent(parent string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("IndikatorRenstra.InvalidParent", fmt.Sprintf("Parent with identifier %s not found", parent))
}</span>

func NotUniqueIndikator() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("IndikatorRenstra.NotUniqueIndikator", "indikator is not unique")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("IndikatorRenstra.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("IndikatorRenstra.NotFound", fmt.Sprintf("IndikatorRenstra with identifier %s not found", id) )
}</span>
</pre>
		
		<pre class="file" id="file48" style="display: none">package application

import (
        "context"
        
        domainjenisfile "UnpakSiamida/modules/jenisfile/domain"
        "time"
)

type CreateJenisFileCommandHandler struct{
        Repo domainjenisfile.IJenisFileRepository
}

func (h *CreateJenisFileCommandHandler) Handle(
        ctx context.Context,
        cmd CreateJenisFileCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        result := domainjenisfile.NewJenisFile(
                cmd.Nama,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">createJenisFile := result.Value
        if err := h.Repo.Create(ctx, createJenisFile); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">return result.Value.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file49" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func CreateJenisFileCommandValidation(cmd CreateJenisFileCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Nama,
                        validation.Required.Error("Nama cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file50" style="display: none">package application

import (
        "context"

        domainjenisfile "UnpakSiamida/modules/jenisfile/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type DeleteJenisFileCommandHandler struct {
        Repo domainjenisfile.IJenisFileRepository
}

func (h *DeleteJenisFileCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteJenisFileCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        jenisfileUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainjenisfile.InvalidUuid()
        }</span>

        // Get existing jenisfile
        <span class="cov8" title="1">_, err = h.Repo.GetByUuid(ctx, jenisfileUUID)
        if err != nil </span><span class="cov8" title="1">{
                if err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                        return "", domainjenisfile.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // Delete by UUID
        <span class="cov8" title="1">if err := h.Repo.Delete(ctx, jenisfileUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov8" title="1">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file51" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func DeleteJenisFileCommandValidation(cmd DeleteJenisFileCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file52" style="display: none">package application

import (
    "context"
    domainJenisFile "UnpakSiamida/modules/jenisfile/domain"
    "time"
)

type GetAllJenisFilesQueryHandler struct {
    Repo domainJenisFile.IJenisFileRepository
}

func (h *GetAllJenisFilesQueryHandler) Handle(
    ctx context.Context,
    q GetAllJenisFilesQuery,
) (domainJenisFile.PagedJenisFiles, error) <span class="cov8" title="1">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    JenisFiles, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domainJenisFile.PagedJenisFiles{}, err
    }</span>

    <span class="cov8" title="1">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov8" title="1">{
        currentPage = *q.Page
    }</span>
    <span class="cov8" title="1">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov8" title="1">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov8" title="1">return domainJenisFile.PagedJenisFiles{
        Data:  JenisFiles,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file53" style="display: none">package application

import (
    "context"

    domainJenisFile "UnpakSiamida/modules/jenisfile/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetJenisFileByUuidQueryHandler struct {
    Repo domainJenisFile.IJenisFileRepository
}

func (h *GetJenisFileByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetJenisFileByUuidQuery,
) (*domainJenisFile.JenisFile, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov8" title="1">{
                return nil, domainJenisFile.NotFound(q.Uuid)
        }</span>

    <span class="cov8" title="1">inJenisFile, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainJenisFile.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov8" title="1">return inJenisFile, nil</span>
}
</pre>
		
		<pre class="file" id="file54" style="display: none">package application

import (
    "context"

    domainJenisFile "UnpakSiamida/modules/jenisfile/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetJenisFileDefaultByUuidQueryHandler struct {
    Repo domainJenisFile.IJenisFileRepository
}

func (h *GetJenisFileDefaultByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetJenisFileDefaultByUuidQuery,
) (*domainJenisFile.JenisFileDefault, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov8" title="1">{
                return nil, domainJenisFile.NotFound(q.Uuid)
        }</span>

    <span class="cov8" title="1">JenisFile, err := h.Repo.GetDefaultByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainJenisFile.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov8" title="1">return JenisFile, nil</span>
}
</pre>
		
		<pre class="file" id="file55" style="display: none">package application

import (
        "context"

        domainjenisfile "UnpakSiamida/modules/jenisfile/domain"
)

type SetupUuidJenisFileCommandHandler struct {
        Repo domainjenisfile.IJenisFileRepository
}

func (h *SetupUuidJenisFileCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidJenisFileCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file56" style="display: none">package application

import (
        "context"

        domainjenisfile "UnpakSiamida/modules/jenisfile/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type UpdateJenisFileCommandHandler struct {
        Repo domainjenisfile.IJenisFileRepository
}

func (h *UpdateJenisFileCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateJenisFileCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // -------------------------
        // VALIDATE UUID
        // -------------------------
        jenisfileUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainjenisfile.InvalidUuid()
        }</span>

        // -------------------------
        // GET EXISTING jenisfile
        // -------------------------
        <span class="cov8" title="1">existingJenisFile, err := h.Repo.GetByUuid(ctx, jenisfileUUID) // ‚Üê memastikan pakai nama interface yg benar
        if err != nil </span><span class="cov8" title="1">{
                if err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                        return "", domainjenisfile.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // -------------------------
        // AGGREGATE ROOT LOGIC
        // -------------------------
        <span class="cov8" title="1">result := domainjenisfile.UpdateJenisFile(
                existingJenisFile,
                jenisfileUUID,
                cmd.Nama,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">updatedJenisFile := result.Value

        // -------------------------
        // SAVE TO REPOSITORY
        // -------------------------
        if err := h.Repo.Update(ctx, updatedJenisFile); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">return updatedJenisFile.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file57" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func UpdateJenisFileCommandValidation(cmd UpdateJenisFileCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Nama,
                        validation.Required.Error("Nama cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file58" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/jenisfile/event"

        "github.com/google/uuid"
)

type JenisFile struct {
        common.Entity

        ID   uint      `gorm:"primaryKey;autoIncrement"`
        UUID uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Nama string    `gorm:"type:longtext;not null"`
}

func (JenisFile) TableName() string <span class="cov0" title="0">{
        return "jenis_file_renstra"
}</span>

// === CREATE ===
func NewJenisFile(nama string) common.ResultValue[*JenisFile] <span class="cov8" title="1">{

        jenisfile := &amp;JenisFile{
                UUID: uuid.New(),
                Nama: nama,
        }

        jenisfile.Raise(event.JenisFileCreatedEvent{
                EventID:       uuid.New(),
                OccurredOn:    time.Now().UTC(),
                JenisFileUUID: jenisfile.UUID,
        })

        return common.SuccessValue(jenisfile)
}</span>

// === UPDATE ===
func UpdateJenisFile(
        prev *JenisFile,
        uid uuid.UUID,
        nama string,
) common.ResultValue[*JenisFile] <span class="cov8" title="1">{

        if prev == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*JenisFile](EmptyData())
        }</span>

        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*JenisFile](InvalidData())
        }</span>

        <span class="cov8" title="1">prev.Nama = nama

        prev.Raise(event.JenisFileUpdatedEvent{
                EventID:       uuid.New(),
                OccurredOn:    time.Now().UTC(),
                JenisFileUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file59" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("JenisFile.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("JenisFile.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("JenisFile.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("JenisFile.NotFound", fmt.Sprintf("JenisFile with identifier %s not found", id) )
}</pre>
		
		<pre class="file" id="file60" style="display: none">package domain

import (
        "errors"
        "strconv"
        "strings"
        "time"

        // "github.com/goforj/godump"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/kts/event"

        "github.com/google/uuid"
)

type Kts struct {
        common.Entity

        ID   uint      `gorm:"primaryKey;autoIncrement"`
        UUID uuid.UUID `gorm:"type:char(36);uniqueIndex"`

        RenstraNilai    *uint  `gorm:"column:id_renstra_nilai"`
        DokumenTambahan *uint  `gorm:"column:id_dokumen_tambahan"`
        Status          string `gorm:"column:status"`

        // auditor
        NomorLaporan     *string    `gorm:"column:nomor_laporan"`
        TanggalLaporan   *time.Time `gorm:"column:tanggal_laporan;type:date"`
        Auditor          *string    `gorm:"column:auditor"`
        KetidaksesuaianP *string    `gorm:"column:uraian_ketidaksesuaian_p"`
        KetidaksesuaianL *string    `gorm:"column:uraian_ketidaksesuaian_l"`
        KetidaksesuaianO *string    `gorm:"column:uraian_ketidaksesuaian_o"`
        KetidaksesuaianR *string    `gorm:"column:uraian_ketidaksesuaian_r"`
        AkarMasalah      *string    `gorm:"column:akar_masalah"`
        TindakanKoreksi  *string    `gorm:"column:tindakan_koreksi"`
        AccAuditor       *uint      `gorm:"column:acc_auditor"`

        // auditee
        StatusAccAuditee  *uint   `gorm:"column:status_acc_auditee"`
        AccAuditee        *uint   `gorm:"column:acc_auditee"`
        KeteranganTolak   *string `gorm:"column:keterangan_tolak_auditee"`
        TindakanPerbaikan *string `gorm:"column:tindakan_perbaikan"`

        // auditor
        TanggalPenyelesaian *time.Time `gorm:"column:tanggal_penyelesaian;type:date"`

        // auditee
        TinjauanTindakanPerbaikan *string    `gorm:"column:tinjauan_tindakan_perbaikan"`
        TanggalClosing            *time.Time `gorm:"column:tanggal_closing_auditee;type:date"`
        AccFinal                  *uint      `gorm:"column:acc_auditor_final"`

        // auditor
        TanggalClosingFinal *time.Time `gorm:"column:tanggal_closing;type:date"`
        WmmUpmfUpmps        *string    `gorm:"column:wmm_upmf_upmps"`
        ClosingBy           *uint      `gorm:"column:closingBy"`
}

func (Kts) TableName() string <span class="cov0" title="0">{
        return "kts_renstra"
}</span>

// === CREATE ===
// [pr] belum dipakai
func NewKtsRenstra(
        auditor *string,
        renstraNilai *uint,
        templateRenstra *uint,
        standar *string,
        indikator *string,
        tahun string,
        idTarget uint,
        target string,
        isDataExist bool,
) common.ResultValue[*Kts] <span class="cov8" title="1">{
        if isDataExist </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](ExistData())
        }</span>

        <span class="cov8" title="1">kts := &amp;Kts{
                UUID:         uuid.New(),
                RenstraNilai: renstraNilai,
                Auditor:      auditor,
                Status:       "draf",
        }

        kts.Raise(event.KtsCreatedEvent{
                EventID:         uuid.New(),
                OccurredOn:      time.Now().UTC(),
                KtsUUID:         kts.UUID,
                TemplateRenstra: templateRenstra,
                Standar:         standar,
                Indikator:       indikator,
                Tahun:           tahun,
                IdTarget:        idTarget,
                Target:          target,
        })

        return common.SuccessValue(kts)</span>
}

// [pr] belum dipakai
func NewKtsDokumen(
        auditor *string,
        dokumenTambahan *uint,
        templateDokumen *uint,
        pertanyaan *string,
        jenisFile *string,
        tahun string,
        idTarget uint,
        target string,
        isDataExist bool,
) common.ResultValue[*Kts] <span class="cov8" title="1">{
        if isDataExist </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](ExistData())
        }</span>

        <span class="cov8" title="1">kts := &amp;Kts{
                UUID:            uuid.New(),
                DokumenTambahan: dokumenTambahan,
                Auditor:         auditor,
                Status:          "draf",
        }

        kts.Raise(event.KtsCreatedEvent{
                EventID:         uuid.New(),
                OccurredOn:      time.Now().UTC(),
                KtsUUID:         kts.UUID,
                TemplateDokumen: templateDokumen,
                Pertanyaan:      pertanyaan,
                JenisFile:       jenisFile,
                Tahun:           tahun,
                IdTarget:        idTarget,
                Target:          target,
                Status:          "draf",
        })

        return common.SuccessValue(kts)</span>
}

//
// ======================= UPDATE STEP 1 =======================
//

func UpdateKtsStep1(
        prev *Kts,
        prevKts *KtsDefault,
        uid uuid.UUID,
        nomorLaporan string,
        tanggalLaporan string,
        ketidaksesuaianP string,
        ketidaksesuaianL string,
        ketidaksesuaianO string,
        ketidaksesuaianR string,
        akarMasalah string,
        tindakanKoreksi string,
        accAuditor uint,
        tahun string,
) common.ResultValue[*Kts] <span class="cov8" title="1">{

        if prev == nil || prevKts == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](EmptyData())
        }</span>
        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidData())
        }</span>
        <span class="cov8" title="1">if prevKts.Tahun == nil || *prevKts.Tahun != tahun </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidTahun())
        }</span>
        <span class="cov8" title="1">if accAuditor == 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidAuditor())
        }</span>
        <span class="cov8" title="1">if strings.TrimSpace(nomorLaporan) == "" </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](RequiredNomorLaporan())
        }</span>

        <span class="cov8" title="1">tgl, err := ParseDatePtr(tanggalLaporan)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidTanggal())
        }</span>

        <span class="cov8" title="1">prev.NomorLaporan = StringPtr(nomorLaporan)
        prev.TanggalLaporan = tgl
        prev.KetidaksesuaianP = StringPtr(ketidaksesuaianP)
        prev.KetidaksesuaianL = StringPtr(ketidaksesuaianL)
        prev.KetidaksesuaianO = StringPtr(ketidaksesuaianO)
        prev.KetidaksesuaianR = StringPtr(ketidaksesuaianR)
        prev.AkarMasalah = StringPtr(akarMasalah)
        prev.TindakanKoreksi = StringPtr(tindakanKoreksi)
        prev.AccAuditor = UintPtr(accAuditor)
        prev.Status = "menunggu_verif_auditee"

        if prev.DokumenTambahan != nil </span><span class="cov0" title="0">{
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prev.UUID,
                        TemplateDokumen: prevKts.DokumenTambahan,
                        Pertanyaan:      prevKts.Pertanyaan,
                        JenisFileId:     prevKts.JenisFileId,
                        JenisFile:       prevKts.JenisFile,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     StringPtr(nomorLaporan),
                        TanggalLaporan:   TimeToStringPtr(prev.TanggalLaporan),
                        KetidaksesuaianP: StringPtr(ketidaksesuaianP),
                        KetidaksesuaianL: StringPtr(ketidaksesuaianL),
                        KetidaksesuaianO: StringPtr(ketidaksesuaianO),
                        KetidaksesuaianR: StringPtr(ketidaksesuaianR),
                        AkarMasalah:      StringPtr(akarMasalah),
                        TindakanKoreksi:  StringPtr(tindakanKoreksi),
                        Status:           StringPtr("menunggu_verif_auditee"),
                })
        }</span> else<span class="cov8" title="1"> {
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prevKts.UUID,
                        TemplateRenstra: prevKts.TemplateRenstra,
                        StandarId:       prevKts.StandarId,
                        Standar:         prevKts.Standar,
                        IndikatorId:     prevKts.IndikatorId,
                        Indikator:       prevKts.Indikator,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     StringPtr(nomorLaporan),
                        TanggalLaporan:   TimeToStringPtr(prev.TanggalLaporan),
                        KetidaksesuaianP: StringPtr(ketidaksesuaianP),
                        KetidaksesuaianL: StringPtr(ketidaksesuaianL),
                        KetidaksesuaianO: StringPtr(ketidaksesuaianO),
                        KetidaksesuaianR: StringPtr(ketidaksesuaianR),
                        AkarMasalah:      StringPtr(akarMasalah),
                        TindakanKoreksi:  StringPtr(tindakanKoreksi),
                        Status:           StringPtr("menunggu_verif_auditee"),
                })
        }</span>

        <span class="cov8" title="1">return common.SuccessValue(prev)</span>
}

//
// ======================= UPDATE STEP 2 =======================
//

func UpdateKtsStep2(
        prev *Kts,
        prevKts *KtsDefault,
        uid uuid.UUID,
        statusAccAuditee uint,
        accAuditee uint,
        keteranganTolak *string,
        tindakanPerbaikan *string,
        tahun string,
) common.ResultValue[*Kts] <span class="cov8" title="1">{

        if prev == nil || prevKts == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](EmptyData())
        }</span>
        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidData())
        }</span>
        <span class="cov8" title="1">if prevKts.Tahun == nil || *prevKts.Tahun != tahun </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidTahun())
        }</span>
        <span class="cov8" title="1">if accAuditee == 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidAuditee())
        }</span>
        <span class="cov8" title="1">if statusAccAuditee &gt; 1 </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidStatusAcc())
        }</span>
        <span class="cov8" title="1">if statusAccAuditee == 0 &amp;&amp; (keteranganTolak == nil || strings.TrimSpace(*keteranganTolak) == "") </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](RequiredKeteranganTolak())
        }</span>

        <span class="cov8" title="1">prev.StatusAccAuditee = UintPtr(statusAccAuditee)
        prev.AccAuditee = UintPtr(accAuditee)
        prev.KeteranganTolak = keteranganTolak
        prev.TindakanPerbaikan = tindakanPerbaikan
        if statusAccAuditee == 1 </span><span class="cov8" title="1">{
                prev.Status = "terima_auditee"
        }</span> else<span class="cov8" title="1"> {
                prev.Status = "tolak_auditee"
        }</span>

        <span class="cov8" title="1">if prev.DokumenTambahan != nil </span><span class="cov0" title="0">{
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prev.UUID,
                        TemplateDokumen: prevKts.DokumenTambahan,
                        Pertanyaan:      prevKts.Pertanyaan,
                        JenisFile:       prevKts.JenisFile,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        Status: StringPtr(prev.Status),
                })
        }</span> else<span class="cov8" title="1"> {
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prevKts.UUID,
                        TemplateRenstra: prevKts.TemplateRenstra,
                        StandarId:       prevKts.StandarId,
                        Standar:         prevKts.Standar,
                        IndikatorId:     prevKts.IndikatorId,
                        Indikator:       prevKts.Indikator,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        Status: StringPtr(prev.Status),
                })
        }</span>

        <span class="cov8" title="1">return common.SuccessValue(prev)</span>
}

func UpdateKtsTindakan(
        prev *Kts,
        prevKts *KtsDefault,
        uid uuid.UUID,
        tindakanPerbaikan string,
        tahun string,
) common.ResultValue[*Kts] <span class="cov8" title="1">{

        if prev == nil || prevKts == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](EmptyData())
        }</span>
        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidData())
        }</span>
        <span class="cov8" title="1">if prevKts.Tahun == nil || *prevKts.Tahun != tahun </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidTahun())
        }</span>

        <span class="cov8" title="1">prev.TindakanPerbaikan = StringPtr(tindakanPerbaikan)

        if prev.DokumenTambahan != nil </span><span class="cov0" title="0">{
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prev.UUID,
                        TemplateDokumen: prevKts.DokumenTambahan,
                        Pertanyaan:      prevKts.Pertanyaan,
                        JenisFile:       prevKts.JenisFile,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: StringPtr(tindakanPerbaikan),
                        Status:            StringPtr(prevKts.Status),
                })
        }</span> else<span class="cov8" title="1"> {
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prevKts.UUID,
                        TemplateRenstra: prevKts.TemplateRenstra,
                        StandarId:       prevKts.StandarId,
                        Standar:         prevKts.Standar,
                        IndikatorId:     prevKts.IndikatorId,
                        Indikator:       prevKts.Indikator,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: StringPtr(tindakanPerbaikan),
                        Status:            StringPtr(prevKts.Status),
                })
        }</span>

        <span class="cov8" title="1">return common.SuccessValue(prev)</span>
}

//
// ======================= UPDATE STEP 3 =======================
//

func UpdateKtsStep3(
        prev *Kts,
        prevKts *KtsDefault,
        uid uuid.UUID,
        accAuditor uint,
        tanggalPenyelesaian string,
        tahun string,
) common.ResultValue[*Kts] <span class="cov8" title="1">{

        if prev == nil || prevKts == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](EmptyData())
        }</span>
        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidData())
        }</span>
        <span class="cov8" title="1">if prevKts.Tahun == nil || *prevKts.Tahun != tahun </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidTahun())
        }</span>
        <span class="cov8" title="1">if accAuditor == 0 || prevKts.Auditor == nil || *prevKts.Auditor != strconv.FormatUint(uint64(accAuditor), 10) </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidAuditor())
        }</span>

        <span class="cov8" title="1">tgl, err := ParseDatePtr(tanggalPenyelesaian)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidTanggal())
        }</span>

        <span class="cov8" title="1">prev.TanggalPenyelesaian = tgl
        prev.Status = "menunggu_penyelesaian"

        if prev.DokumenTambahan != nil </span><span class="cov0" title="0">{
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prev.UUID,
                        TemplateDokumen: prevKts.DokumenTambahan,
                        Pertanyaan:      prevKts.Pertanyaan,
                        JenisFile:       prevKts.JenisFile,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        TanggalPenyelesaian: TimeToStringPtr(prev.TanggalPenyelesaian),
                        Status:              StringPtr("menunggu_penyelesaian"),
                })
        }</span> else<span class="cov8" title="1"> {
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prevKts.UUID,
                        TemplateRenstra: prevKts.TemplateRenstra,
                        StandarId:       prevKts.StandarId,
                        Standar:         prevKts.Standar,
                        IndikatorId:     prevKts.IndikatorId,
                        Indikator:       prevKts.Indikator,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        TanggalPenyelesaian: TimeToStringPtr(prev.TanggalPenyelesaian),
                        Status:              StringPtr("menunggu_penyelesaian"),
                })
        }</span>

        <span class="cov8" title="1">return common.SuccessValue(prev)</span>
}

//
// ======================= UPDATE STEP 4 =======================
//

func UpdateKtsStep4(
        prev *Kts,
        prevKts *KtsDefault,
        uid uuid.UUID,
        tinjauan string,
        tanggalClosing string,
        accFinal uint,
        tahun string,
) common.ResultValue[*Kts] <span class="cov8" title="1">{

        if prev == nil || prevKts == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](EmptyData())
        }</span>
        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidData())
        }</span>
        <span class="cov8" title="1">if prevKts.Tahun == nil || *prevKts.Tahun != tahun </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidTahun())
        }</span>
        <span class="cov8" title="1">if accFinal == 0 || prevKts.Auditee == nil || *prevKts.Auditee != strconv.FormatUint(uint64(accFinal), 10) </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidAuditee())
        }</span>

        <span class="cov8" title="1">tgl, err := ParseDatePtr(tanggalClosing)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidTanggal())
        }</span>

        <span class="cov8" title="1">prev.TinjauanTindakanPerbaikan = StringPtr(tinjauan)
        prev.TanggalClosing = tgl
        prev.AccFinal = UintPtr(accFinal)
        prev.Status = "tindakan_penyelesaian"

        if prev.DokumenTambahan != nil </span><span class="cov0" title="0">{
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prev.UUID,
                        TemplateDokumen: prevKts.DokumenTambahan,
                        Pertanyaan:      prevKts.Pertanyaan,
                        JenisFile:       prevKts.JenisFile,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        TanggalPenyelesaian: TimeToStringPtr(prev.TanggalPenyelesaian),

                        TanggalClosing: TimeToStringPtr(prev.TanggalClosing),
                        Status:         StringPtr("tindakan_penyelesaian"),
                })
        }</span> else<span class="cov8" title="1"> {
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prevKts.UUID,
                        TemplateRenstra: prevKts.TemplateRenstra,
                        StandarId:       prevKts.StandarId,
                        Standar:         prevKts.Standar,
                        IndikatorId:     prevKts.IndikatorId,
                        Indikator:       prevKts.Indikator,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        TanggalPenyelesaian: TimeToStringPtr(prev.TanggalPenyelesaian),

                        TanggalClosing: TimeToStringPtr(prev.TanggalClosing),
                        Status:         StringPtr("tindakan_penyelesaian"),
                })
        }</span>

        <span class="cov8" title="1">return common.SuccessValue(prev)</span>
}

//
// ======================= UPDATE STEP 5 =======================
//

func UpdateKtsStep5(
        prev *Kts,
        prevKts *KtsDefault,
        uid uuid.UUID,
        tanggalClosingFinal string,
        wmmUpmfUpmps string,
        closingBy uint,
        tahun string,
) common.ResultValue[*Kts] <span class="cov8" title="1">{
        if prev == nil || prevKts == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](EmptyData())
        }</span>
        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidData())
        }</span>
        <span class="cov8" title="1">if prevKts.Tahun == nil || *prevKts.Tahun != tahun </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidTahun())
        }</span>
        <span class="cov8" title="1">if closingBy == 0 || prevKts.Auditor == nil || *prevKts.Auditor != strconv.FormatUint(uint64(closingBy), 10) </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidAuditor())
        }</span>

        <span class="cov8" title="1">tgl, err := ParseDatePtr(tanggalClosingFinal)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Kts](InvalidTanggal())
        }</span>

        <span class="cov8" title="1">prev.TanggalClosingFinal = tgl
        prev.WmmUpmfUpmps = StringPtr(wmmUpmfUpmps)
        prev.ClosingBy = UintPtr(closingBy)
        prev.Status = "tutup_kts"

        if prev.DokumenTambahan != nil </span><span class="cov0" title="0">{
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prev.UUID,
                        TemplateDokumen: prevKts.DokumenTambahan,
                        Pertanyaan:      prevKts.Pertanyaan,
                        JenisFile:       prevKts.JenisFile,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        TanggalPenyelesaian: TimeToStringPtr(prev.TanggalPenyelesaian),

                        TanggalClosing: TimeToStringPtr(prev.TanggalClosing),

                        TanggalClosingFinal: TimeToStringPtr(prev.TanggalClosingFinal),
                        WmmUpmfUpmps:        StringPtr(wmmUpmfUpmps),
                        Status:              StringPtr("tutup_kts"),
                })
        }</span> else<span class="cov8" title="1"> {
                prev.Raise(event.KtsUpdatedEvent{
                        EventID:         uuid.New(),
                        OccurredOn:      time.Now().UTC(),
                        KtsUUID:         prevKts.UUID,
                        TemplateRenstra: prevKts.TemplateRenstra,
                        StandarId:       prevKts.StandarId,
                        Standar:         prevKts.Standar,
                        IndikatorId:     prevKts.IndikatorId,
                        Indikator:       prevKts.Indikator,
                        Tahun:           prevKts.Tahun,
                        IdTarget:        prevKts.IdTarget,
                        Target:          prevKts.Target,

                        NomorLaporan:     prevKts.NomorLaporan,
                        TanggalLaporan:   prevKts.TanggalLaporan,
                        KetidaksesuaianP: prevKts.KetidaksesuaianP,
                        KetidaksesuaianL: prevKts.KetidaksesuaianL,
                        KetidaksesuaianO: prevKts.KetidaksesuaianO,
                        KetidaksesuaianR: prevKts.KetidaksesuaianR,
                        AkarMasalah:      prevKts.AkarMasalah,
                        TindakanKoreksi:  prevKts.TindakanKoreksi,

                        StatusAccAuditee:  prev.StatusAccAuditee,
                        KeteranganTolak:   prev.KeteranganTolak,
                        TindakanPerbaikan: prev.TindakanPerbaikan,

                        TanggalPenyelesaian: TimeToStringPtr(prev.TanggalPenyelesaian),

                        TanggalClosing: TimeToStringPtr(prev.TanggalClosing),

                        TanggalClosingFinal: TimeToStringPtr(prev.TanggalClosingFinal),
                        WmmUpmfUpmps:        StringPtr(wmmUpmfUpmps),
                        Status:              StringPtr("tutup_kts"),
                })
        }</span>

        <span class="cov8" title="1">return common.SuccessValue(prev)</span>
}

//
// ======================= HELPERS =======================
//

func StringPtr(v string) *string <span class="cov8" title="1">{ return &amp;v }</span>
func UintPtr(v uint) *uint       <span class="cov8" title="1">{ return &amp;v }</span>

func ParseDatePtr(input string) (*time.Time, error) <span class="cov8" title="1">{
        if strings.TrimSpace(input) == "" </span><span class="cov0" title="0">{
                return nil, nil
        }</span>
        <span class="cov8" title="1">layouts := []string{
                "2006-01-02",
                time.RFC3339,
                "2006-01-02T15:04:05-07:00",
        }
        for _, l := range layouts </span><span class="cov8" title="1">{
                if t, err := time.Parse(l, input); err == nil </span><span class="cov8" title="1">{
                        tt := t.Truncate(24 * time.Hour)
                        return &amp;tt, nil
                }</span>
        }
        <span class="cov8" title="1">return nil, errors.New("invalid date format")</span>
}

func TimeToStringPtr(t *time.Time) *string <span class="cov8" title="1">{
        if t == nil </span><span class="cov8" title="1">{
                return nil
        }</span>
        <span class="cov8" title="1">s := t.Format("2006-01-02")
        return &amp;s</span>
}
</pre>
		
		<pre class="file" id="file61" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.EmptyData", "data is not found")
}</span>

func ExistData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.ExistData", "data is exist")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.InvalidData", "data is invalid")
}</span>

func InvalidTahun() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.InvalidTahun", "tahun is invalid")
}</span>

func InvalidAuditor() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.InvalidAuditor", "auditor is invalid")
}</span>

func InvalidAuditee() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.InvalidAuditee", "auditee is invalid")
}</span>

func InvalidStatusAcc() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.InvalidStatusAcc", "auditor is invalid")
}</span>

func InvalidTanggal() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.InvalidTanggal", "tanggal is invalid")
}</span>

func InvalidStep() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.InvalidStep", "tanggal is invalid")
}</span>

func RequiredNomorLaporan() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.RequiredNomorLaporan", "nomor laporan is required")
}</span>

func RequiredKeteranganTolak() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.RequiredKeteranganTolak", "keterangan tolak is required")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.NotFound", fmt.Sprintf("Kts with identifier %s not found", id))
}</span>

func NotFoundUser() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Kts.NotFoundUser", "user not found")
}</span>
</pre>
		
		<pre class="file" id="file62" style="display: none">package application

import (
        domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
        domainpreviewtemplate "UnpakSiamida/modules/previewtemplate/domain"
        "context"
        "errors"
        "fmt"
        "strconv"
        "time"

        "github.com/google/uuid"
        "golang.org/x/sync/errgroup"
        "gorm.io/gorm"
)

type GetPreviewTemplateByTahunFakultasUnitQueryHandler struct {
        Repo             domainpreviewtemplate.IPreviewTemplateRepository
        RepoIndikator    domainindikatorrenstra.IIndikatorRenstraRepository
        RepoFakultasUnit domainfakultasunit.IFakultasUnitRepository
}

func (h *GetPreviewTemplateByTahunFakultasUnitQueryHandler) Handle(
        ctx context.Context,
        q GetPreviewTemplateByTahunFakultasUnitQuery,
) ([]domainpreviewtemplate.PreviewTemplate, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

        UuidFakultasUnit, err := uuid.Parse(q.FakultasUnit)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domainpreviewtemplate.NotFoundFakultasUnit(q.FakultasUnit)
        }</span>

        <span class="cov8" title="1">fakultasunit, err := h.RepoFakultasUnit.GetDefaultByUuid(ctx, UuidFakultasUnit)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainpreviewtemplate.NotFoundFakultasUnit(q.FakultasUnit)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

        <span class="cov8" title="1">var (
                tree    []domainindikatorrenstra.IndikatorTree
                preview []domainpreviewtemplate.PreviewTemplate
        )

        g, ctxg := errgroup.WithContext(ctx)

        g.Go(func() error </span><span class="cov8" title="1">{
                // var err error
                if q.Tipe == "renstra" </span><span class="cov8" title="1">{
                        tree, err = h.RepoIndikator.GetIndikatorTree(ctxg, q.Tahun)
                        return err
                }</span>
                // if err != nil {
                //         if errors.Is(err, gorm.ErrRecordNotFound) {
                //                 return domainpreviewtemplate.NotFoundTreeIndikator()
                //         }
                //         return err
                // }
                <span class="cov8" title="1">return nil</span>
        })

        <span class="cov8" title="1">g.Go(func() error </span><span class="cov8" title="1">{
                // var err error
                if q.Tipe == "renstra" </span><span class="cov8" title="1">{
                        preview, err = h.Repo.GetByTahunFakultasUnit(ctxg, q.Tahun, strconv.FormatUint(uint64(fakultasunit.ID), 10))
                        if err != nil </span><span class="cov0" title="0">{
                                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                                        return domainpreviewtemplate.NotFound()
                                }</span>
                                <span class="cov0" title="0">return err</span>
                        }
                } else<span class="cov8" title="1"> {
                        preview, err = h.Repo.GetByTahunTag(ctxg, q.Tahun, fmt.Sprintf("%s#all", fakultasunit.Type))
                        if err != nil </span><span class="cov8" title="1">{
                                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                                        return domainpreviewtemplate.NotFound()
                                }</span>
                                <span class="cov0" title="0">return err</span>
                        }
                }
                <span class="cov8" title="1">return nil</span>
        })

        <span class="cov8" title="1">if err := g.Wait(); err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return mapPointing(preview, tree), nil</span>
}

func mapPointing(
        preview []domainpreviewtemplate.PreviewTemplate,
        tree []domainindikatorrenstra.IndikatorTree,
) []domainpreviewtemplate.PreviewTemplate <span class="cov8" title="1">{

        pointMap := make(map[int]string)

        for _, t := range tree </span><span class="cov8" title="1">{
                pointMap[t.IndikatorId] = t.Pointing
        }</span>

        <span class="cov8" title="1">for i := range preview </span><span class="cov8" title="1">{
                if p, ok := pointMap[preview[i].IndikatorId]; ok </span><span class="cov8" title="1">{
                        preview[i].Pointing = p
                }</span>
        }

        <span class="cov8" title="1">return preview</span>
}
</pre>
		
		<pre class="file" id="file63" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("PreviewTemplate.EmptyData", "data is not found")
}</span>

// func NotFoundTreeIndikator() domain.Error {
//         return domain.NotFoundError("PreviewTemplate.NotFoundTreeIndikator", "Tree Indikator not found")
// }

func NotFound() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("PreviewTemplate.NotFound", "Preview Template not found")
}</span>

func NotFoundFakultasUnit(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("PreviewTemplate.NotFoundFakultasUnit", fmt.Sprintf("FakultasUnit with identifier %s not found", id))
}</span>
</pre>
		
		<pre class="file" id="file64" style="display: none">package application

import (
        "context"

        domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
        domainrenstra "UnpakSiamida/modules/renstra/domain"
        domainuser "UnpakSiamida/modules/user/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type CreateRenstraCommandHandler struct {
        Repo             domainrenstra.IRenstraRepository
        FakultasUnitRepo domainfakultasunit.IFakultasUnitRepository
        UserRepo         domainuser.IUserRepository
}

func (h *CreateRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd CreateRenstraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        uuidFakultasUnit, err := uuid.Parse(cmd.FakultasUnit)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstra.InvalidParsing("Fakultas Unit")
        }</span>
        <span class="cov8" title="1">uuidAuditee, err := uuid.Parse(cmd.Auditee)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstra.InvalidParsing("auditee")
        }</span>
        <span class="cov8" title="1">uuidAuditor1, err := uuid.Parse(cmd.Auditor1)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstra.InvalidParsing("auditor1")
        }</span>
        <span class="cov8" title="1">uuidAuditor2, err := uuid.Parse(cmd.Auditor2)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstra.InvalidParsing("auditor2")
        }</span>

        <span class="cov8" title="1">fakultasUnit, err := h.FakultasUnitRepo.GetDefaultByUuid(ctx, uuidFakultasUnit)
        if err != nil </span><span class="cov8" title="1">{
                if err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                        return "", domainrenstra.InvalidFakultasUnit()
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        <span class="cov8" title="1">auditee, err := h.UserRepo.GetByUuid(ctx, uuidAuditee)
        if err != nil </span><span class="cov0" title="0">{
                if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                        return "", domainrenstra.MissingAuditee()
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        <span class="cov8" title="1">auditor1, err := h.UserRepo.GetByUuid(ctx, uuidAuditor1)
        if err != nil </span><span class="cov0" title="0">{
                if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                        return "", domainrenstra.MissingAuditor1()
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        <span class="cov8" title="1">auditor2, err := h.UserRepo.GetByUuid(ctx, uuidAuditor2)
        if err != nil </span><span class="cov0" title="0">{
                if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                        return "", domainrenstra.MissingAuditor2()
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        <span class="cov8" title="1">isUnique, err := h.Repo.IsUnique(ctx, fakultasUnit.ID, cmd.Tahun)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">result := domainrenstra.NewRenstra(
                cmd.Tahun,
                fakultasUnit.ID,
                cmd.PeriodeUploadMulai,
                cmd.PeriodeUploadAkhir,
                cmd.PeriodeAssesmentDokumenMulai,
                cmd.PeriodeAssesmentDokumenAkhir,
                cmd.PeriodeAssesmentLapanganMulai,
                cmd.PeriodeAssesmentLapanganAkhir,
                auditee.ID,
                auditor1.ID,
                auditor2.ID,
                isUnique,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">renstra := result.Value

        if err := h.Repo.Create(ctx, renstra); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">return renstra.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file65" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func CreateRenstraCommandValidation(cmd CreateRenstraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,

                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.FakultasUnit,
                        validation.Required.Error("Fakultas Unit cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.PeriodeUploadMulai,
                        validation.Required.Error("Periode Upload Mulai cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.PeriodeUploadAkhir,
                        validation.Required.Error("Periode Upload Akhir cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.PeriodeAssesmentDokumenMulai,
                        validation.Required.Error("Periode Upload Mulai cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.PeriodeAssesmentDokumenAkhir,
                        validation.Required.Error("Periode Upload Akhir cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.PeriodeAssesmentLapanganMulai,
                        validation.Required.Error("Periode Upload Mulai cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.PeriodeAssesmentLapanganAkhir,
                        validation.Required.Error("Periode Upload Akhir cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Auditee,
                        validation.Required.Error("Auditee cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Auditor1,
                        validation.Required.Error("Auditor1 cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Auditor2,
                        validation.Required.Error("Auditor2 cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</span>
</pre>
		
		<pre class="file" id="file66" style="display: none">package application

import (
        "context"

        domainrenstra "UnpakSiamida/modules/renstra/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type DeleteRenstraCommandHandler struct {
        Repo domainrenstra.IRenstraRepository
}

func (h *DeleteRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteRenstraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        renstraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstra.InvalidUuid()
        }</span>

        // Get existing renstra
        <span class="cov8" title="1">_, err = h.Repo.GetByUuid(ctx, renstraUUID)
        if err != nil </span><span class="cov8" title="1">{
                if err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                        return "", domainrenstra.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // Delete by UUID
        <span class="cov8" title="1">if err := h.Repo.Delete(ctx, renstraUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov8" title="1">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file67" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func DeleteRenstraCommandValidation(cmd DeleteRenstraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file68" style="display: none">package application

import (
    "context"
    domainrenstra "UnpakSiamida/modules/renstra/domain"
    "time"
)

type GetAllRenstrasQueryHandler struct {
    Repo domainrenstra.IRenstraRepository
}

func (h *GetAllRenstrasQueryHandler) Handle(
    ctx context.Context,
    q GetAllRenstrasQuery,
) (domainrenstra.PagedRenstras, error) <span class="cov8" title="1">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    renstras, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
        q.Scope,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domainrenstra.PagedRenstras{}, err
    }</span>

    <span class="cov8" title="1">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov8" title="1">{
        currentPage = *q.Page
    }</span>
    <span class="cov8" title="1">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov8" title="1">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov8" title="1">return domainrenstra.PagedRenstras{
        Data:  renstras,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file69" style="display: none">package application

import (
    "context"

    domainrenstra "UnpakSiamida/modules/renstra/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetRenstraByUuidQueryHandler struct {
    Repo domainrenstra.IRenstraRepository
}

func (h *GetRenstraByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetRenstraByUuidQuery,
) (*domainrenstra.Renstra, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domainrenstra.NotFound(q.Uuid)
        }</span>

    <span class="cov0" title="0">inrenstra, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domainrenstra.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov0" title="0">return inrenstra, nil</span>
}
</pre>
		
		<pre class="file" id="file70" style="display: none">package application

import (
    "context"

    domainrenstra "UnpakSiamida/modules/renstra/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetRenstraDefaultByUuidQueryHandler struct {
    Repo domainrenstra.IRenstraRepository
}

func (h *GetRenstraDefaultByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetRenstraDefaultByUuidQuery,
) (*domainrenstra.RenstraDefault, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov8" title="1">{
                return nil, domainrenstra.NotFound(q.Uuid)
        }</span>

    <span class="cov8" title="1">inrenstra, err := h.Repo.GetDefaultByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainrenstra.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov8" title="1">return inrenstra, nil</span>
}
</pre>
		
		<pre class="file" id="file71" style="display: none">package application

import (
        "context"
        "errors"

        domainrenstra "UnpakSiamida/modules/renstra/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type GiveCodeAccessRenstraCommandHandler struct {
        Repo domainrenstra.IRenstraRepository
}

func (h *GiveCodeAccessRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd GiveCodeAccessRenstraCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

        renstraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstra.InvalidUuid()
        }</span>

        <span class="cov0" title="0">existingRenstra, err := h.Repo.GetByUuid(ctx, renstraUUID) // ‚Üê memastikan pakai nama interface yg benar
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return "", domainrenstra.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // -------------------------
        // AGGREGATE ROOT LOGIC
        // -------------------------
        <span class="cov0" title="0">result := domainrenstra.GiveCodeAccessRenstra(
                existingRenstra,
                renstraUUID,
                cmd.KodeAkses,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov0" title="0">updatedRenstra := result.Value

        // -------------------------
        // SAVE TO REPOSITORY
        // -------------------------
        if err := h.Repo.Update(ctx, updatedRenstra); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return updatedRenstra.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file72" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func GiveCodeAccessRenstraCommandValidation(cmd GiveCodeAccessRenstraCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.KodeAkses,
                        validation.Required.Error("Kode Akses cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file73" style="display: none">package application

import (
        "context"

        domainrenstra "UnpakSiamida/modules/renstra/domain"
)

type SetupUuidRenstraCommandHandler struct {
        Repo domainrenstra.IRenstraRepository
}

func (h *SetupUuidRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidRenstraCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file74" style="display: none">package application

import (
        "context"

        domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
        domainrenstra "UnpakSiamida/modules/renstra/domain"
        domainuser "UnpakSiamida/modules/user/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type UpdateRenstraCommandHandler struct {
        Repo             domainrenstra.IRenstraRepository
        FakultasUnitRepo domainfakultasunit.IFakultasUnitRepository
        UserRepo         domainuser.IUserRepository
}

func (h *UpdateRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateRenstraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        renstraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstra.InvalidUuid()
        }</span>
        <span class="cov8" title="1">uuidFakultasUnit, err := uuid.Parse(cmd.FakultasUnit)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstra.InvalidParsing("Fakultas Unit")
        }</span>
        <span class="cov8" title="1">uuidAuditee, err := uuid.Parse(cmd.Auditee)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstra.InvalidParsing("auditee")
        }</span>
        <span class="cov8" title="1">uuidAuditor1, err := uuid.Parse(cmd.Auditor1)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstra.InvalidParsing("auditor1")
        }</span>
        <span class="cov8" title="1">uuidAuditor2, err := uuid.Parse(cmd.Auditor2)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstra.InvalidParsing("auditor2")
        }</span>

        <span class="cov8" title="1">existingRenstra, err := h.Repo.GetByUuid(ctx, renstraUUID) // ‚Üê memastikan pakai nama interface yg benar
        if err != nil </span><span class="cov8" title="1">{
                if err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                        return "", domainrenstra.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        <span class="cov8" title="1">fakultasUnit, err := h.FakultasUnitRepo.GetDefaultByUuid(ctx, uuidFakultasUnit)
        if err != nil </span><span class="cov8" title="1">{
                if err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                        return "", domainrenstra.InvalidFakultasUnit()
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        <span class="cov8" title="1">auditee, err := h.UserRepo.GetByUuid(ctx, uuidAuditee)
        if err != nil </span><span class="cov8" title="1">{
                if err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                        return "", domainrenstra.MissingAuditee()
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        <span class="cov8" title="1">auditor1, err := h.UserRepo.GetByUuid(ctx, uuidAuditor1)
        if err != nil </span><span class="cov8" title="1">{
                if err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                        return "", domainrenstra.MissingAuditor1()
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        <span class="cov8" title="1">auditor2, err := h.UserRepo.GetByUuid(ctx, uuidAuditor2)
        if err != nil </span><span class="cov8" title="1">{
                if err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                        return "", domainrenstra.MissingAuditor2()
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // -------------------------
        // AGGREGATE ROOT LOGIC
        // -------------------------
        <span class="cov8" title="1">result := domainrenstra.UpdateRenstra(
                existingRenstra,
                renstraUUID,
                cmd.Tahun,
                fakultasUnit.ID,
                cmd.PeriodeUploadMulai,
                cmd.PeriodeUploadAkhir,
                cmd.PeriodeAssesmentDokumenMulai,
                cmd.PeriodeAssesmentDokumenAkhir,
                cmd.PeriodeAssesmentLapanganMulai,
                cmd.PeriodeAssesmentLapanganAkhir,
                auditee.ID,
                auditor1.ID,
                auditor2.ID,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">updatedRenstra := result.Value

        // -------------------------
        // SAVE TO REPOSITORY
        // -------------------------
        if err := h.Repo.Update(ctx, updatedRenstra); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">return updatedRenstra.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file75" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func UpdateRenstraCommandValidation(cmd UpdateRenstraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                        validation.By(helper.ValidateUUIDv4),
                ),

                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.FakultasUnit,
                        validation.Required.Error("Fakultas Unit cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                        validation.By(helper.ValidateUUIDv4),
                ),

                validation.Field(&amp;cmd.PeriodeUploadMulai,
                        validation.Required.Error("Periode Upload Mulai cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.PeriodeUploadAkhir,
                        validation.Required.Error("Periode Upload Akhir cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.PeriodeAssesmentDokumenMulai,
                        validation.Required.Error("Periode Upload Mulai cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.PeriodeAssesmentDokumenAkhir,
                        validation.Required.Error("Periode Upload Akhir cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.PeriodeAssesmentLapanganMulai,
                        validation.Required.Error("Periode Upload Mulai cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.PeriodeAssesmentLapanganAkhir,
                        validation.Required.Error("Periode Upload Akhir cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Auditee,
                        validation.Required.Error("Auditee cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Auditor1,
                        validation.Required.Error("Auditor1 cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Auditor2,
                        validation.Required.Error("Auditor2 cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file76" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/renstra/event"

        "github.com/google/uuid"
)

type Renstra struct {
        common.Entity

        ID                            uint      `gorm:"primaryKey;autoIncrement"`
        UUID                          uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Tahun                         string    `gorm:"size:255;not null"`
        FakultasUnit                  uint      `gorm:"column:fakultas_unit;"`
        PeriodeUploadMulai            string    `gorm:"column:periode_upload_mulai;"`
        PeriodeUploadAkhir            string    `gorm:"column:periode_upload_akhir;"`
        PeriodeAssesmentDokumenMulai  string    `gorm:"column:periode_assesment_dokumen_mulai;"`
        PeriodeAssesmentDokumenAkhir  string    `gorm:"column:periode_assesment_dokumen_akhir;"`
        PeriodeAssesmentLapanganMulai string    `gorm:"column:periode_assesment_lapangan_mulai;"`
        PeriodeAssesmentLapanganAkhir string    `gorm:"column:periode_assesment_lapangan_akhir;"`
        KodeAkses                     *string   `gorm:"column:kodeAkses;"`
        Auditee                       uint      `gorm:""`
        Auditor1                      uint      `gorm:""`
        Auditor2                      uint      `gorm:""`
        Catatan1                      *string   `gorm:"column:catatan;"`
        Catatan2                      *string   `gorm:"column:catatan2;"`
}

func (Renstra) TableName() string <span class="cov0" title="0">{
        return "renstra"
}</span>

// ------------------------
// Helper: check overlap
// ------------------------
func isOverlap(start1, end1, start2, end2 time.Time) bool <span class="cov8" title="1">{
        return !end1.Before(start2) &amp;&amp; !end2.Before(start1)
}</span>

// ------------------------
// Create New Renstra
// ------------------------
func NewRenstra(
        tahun string,
        fakultasUnit uint,
        periodeUploadMulai, periodeUploadAkhir string,
        periodeDokumenMulai, periodeDokumenAkhir string,
        periodeLapanganMulai, periodeLapanganAkhir string,
        auditee, auditor1, auditor2 uint,
        isUniqueData bool,
) common.ResultValue[*Renstra] <span class="cov8" title="1">{

        if fakultasUnit &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidFakultasUnit())
        }</span>

        <span class="cov8" title="1">if !isUniqueData </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](DataExisting())
        }</span>

        <span class="cov8" title="1">if auditee &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](MissingAuditee())
        }</span>
        <span class="cov8" title="1">if auditor1 &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](MissingAuditor1())
        }</span>
        <span class="cov8" title="1">if auditor2 &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](MissingAuditor2())
        }</span>

        <span class="cov8" title="1">if auditee == auditor1 || auditee == auditor2 || auditor1 == auditor2 </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](DuplicateAssigment())
        }</span>

        <span class="cov8" title="1">format := "2006-01-02"

        // Periode Upload
        startUpload, err := time.Parse(format, periodeUploadMulai)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidDate("upload"))
        }</span>
        <span class="cov8" title="1">endUpload, err := time.Parse(format, periodeUploadAkhir)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidDate("upload"))
        }</span>

        // Periode Assessment Dokumen
        <span class="cov8" title="1">startDokumen, err := time.Parse(format, periodeDokumenMulai)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidDate("assessment dokumen"))
        }</span>
        <span class="cov8" title="1">endDokumen, err := time.Parse(format, periodeDokumenAkhir)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidDate("assessment dokumen"))
        }</span>

        // Periode Assessment Lapangan
        <span class="cov8" title="1">startLapangan, err := time.Parse(format, periodeLapanganMulai)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidDate("assessment lapangan"))
        }</span>
        <span class="cov8" title="1">endLapangan, err := time.Parse(format, periodeLapanganAkhir)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidDate("assessment lapangan"))
        }</span>

        // Cek overlap
        <span class="cov8" title="1">if isOverlap(startUpload, endUpload, startDokumen, endDokumen) </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](PeriodOverlapUploadDokumen())
        }</span>

        <span class="cov8" title="1">if isOverlap(startUpload, endUpload, startLapangan, endLapangan) </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](PeriodOverlapUploadLapangan())
        }</span>

        <span class="cov8" title="1">if isOverlap(startDokumen, endDokumen, startLapangan, endLapangan) </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](PeriodOverlapDokumenLapangan())
        }</span>

        <span class="cov8" title="1">renstra := &amp;Renstra{
                UUID:                          uuid.New(),
                Tahun:                         tahun,
                FakultasUnit:                  fakultasUnit,
                PeriodeUploadMulai:            periodeUploadMulai,
                PeriodeUploadAkhir:            periodeUploadAkhir,
                PeriodeAssesmentDokumenMulai:  periodeDokumenMulai,
                PeriodeAssesmentDokumenAkhir:  periodeDokumenAkhir,
                PeriodeAssesmentLapanganMulai: periodeLapanganMulai,
                PeriodeAssesmentLapanganAkhir: periodeLapanganAkhir,
                Auditee:                       auditee,
                Auditor1:                      auditor1,
                Auditor2:                      auditor2,
        }

        renstra.Raise(event.RenstraCreatedEvent{
                EventID:     uuid.New(),
                OccurredOn:  time.Now().UTC(),
                RenstraUUID: renstra.UUID,
        })

        return common.SuccessValue(renstra)</span>
}

func GiveCodeAccessRenstra(
        prev *Renstra,
        uid uuid.UUID,
        kodeAkses string,
) common.ResultValue[*Renstra] <span class="cov8" title="1">{

        if prev == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](EmptyData())
        }</span>

        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidData())
        }</span>

        <span class="cov8" title="1">prev.KodeAkses = &amp;kodeAkses

        prev.Raise(event.RenstraGiveCodeAccessEvent{
                EventID:     uuid.New(),
                OccurredOn:  time.Now().UTC(),
                RenstraUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}

func UpdateRenstra(
        prev *Renstra,
        uid uuid.UUID,
        tahun string,
        fakultasUnit uint,
        periodeUploadMulai, periodeUploadAkhir string,
        periodeDokumenMulai, periodeDokumenAkhir string,
        periodeLapanganMulai, periodeLapanganAkhir string,
        auditee, auditor1, auditor2 uint,
) common.ResultValue[*Renstra] <span class="cov8" title="1">{

        if prev == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](EmptyData())
        }</span>

        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidData())
        }</span>

        <span class="cov8" title="1">if fakultasUnit &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidFakultasUnit())
        }</span>

        <span class="cov8" title="1">if auditee &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](MissingAuditee())
        }</span>
        <span class="cov8" title="1">if auditor1 &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](MissingAuditor1())
        }</span>
        <span class="cov8" title="1">if auditor2 &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](MissingAuditor2())
        }</span>

        <span class="cov8" title="1">if auditee == auditor1 || auditee == auditor2 || auditor1 == auditor2 </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](DuplicateAssigment())
        }</span>

        <span class="cov8" title="1">format := "2006-01-02"

        // Periode Upload
        startUpload, err := time.Parse(format, periodeUploadMulai)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidDate("upload"))
        }</span>
        <span class="cov8" title="1">endUpload, err := time.Parse(format, periodeUploadAkhir)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidDate("upload"))
        }</span>

        // Periode Assessment Dokumen
        <span class="cov8" title="1">startDokumen, err := time.Parse(format, periodeDokumenMulai)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidDate("assessment dokumen"))
        }</span>
        <span class="cov8" title="1">endDokumen, err := time.Parse(format, periodeDokumenAkhir)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidDate("assessment dokumen"))
        }</span>

        // Periode Assessment Lapangan
        <span class="cov8" title="1">startLapangan, err := time.Parse(format, periodeLapanganMulai)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidDate("assessment lapangan"))
        }</span>
        <span class="cov8" title="1">endLapangan, err := time.Parse(format, periodeLapanganAkhir)
        if err != nil </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](InvalidDate("assessment lapangan"))
        }</span>

        // Cek overlap
        <span class="cov8" title="1">if isOverlap(startUpload, endUpload, startDokumen, endDokumen) </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](PeriodOverlapUploadDokumen())
        }</span>

        <span class="cov8" title="1">if isOverlap(startUpload, endUpload, startLapangan, endLapangan) </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](PeriodOverlapUploadLapangan())
        }</span>

        <span class="cov8" title="1">if isOverlap(startDokumen, endDokumen, startLapangan, endLapangan) </span><span class="cov8" title="1">{
                return common.FailureValue[*Renstra](PeriodOverlapDokumenLapangan())
        }</span>

        // always overwrite (required field)
        <span class="cov8" title="1">prev.Tahun = tahun
        prev.FakultasUnit = fakultasUnit
        prev.PeriodeUploadMulai = periodeUploadMulai
        prev.PeriodeUploadAkhir = periodeUploadAkhir
        prev.PeriodeAssesmentDokumenMulai = periodeDokumenMulai
        prev.PeriodeAssesmentDokumenAkhir = periodeDokumenAkhir
        prev.PeriodeAssesmentLapanganMulai = periodeLapanganMulai
        prev.PeriodeAssesmentLapanganAkhir = periodeLapanganAkhir
        prev.Auditee = auditee
        prev.Auditor1 = auditor1
        prev.Auditor2 = auditor2

        prev.Raise(event.RenstraUpdatedEvent{
                EventID:     uuid.New(),
                OccurredOn:  time.Now().UTC(),
                RenstraUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file77" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.NotFound", fmt.Sprintf("Renstra with identifier %s not found", id))
}</span>

func InvalidFakultasUnit() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.InvalidFakultasUnit", "fakultas unit is invalid")
}</span>

func DataExisting() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.DataExisting", "the audit data form already existed before")
}</span>

func MissingAuditee() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.MissingAuditee", "auditee have not been assigned")
}</span>

func MissingAuditor1() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.MissingAuditor1", "auditor1 have not been assigned")
}</span>

func MissingAuditor2() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.MissingAuditor2", "auditor2 have not been assigned")
}</span>

func InvalidParsing(target string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.InvalidParsing", fmt.Sprintf("failed parsing %s to UUID", target))
}</span>

func DuplicateAssigment() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.DuplicateAssigment", "auditee, auditee 1, and auditor 2 must not have the same target")
}</span>

func InvalidDate(target string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.InvalidDate", fmt.Sprintf("%s period have wrong date format", target))
}</span>

func PeriodOverlapUploadDokumen() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.PeriodOverlapUploadDokumen", "upload period overlaps with document period")
}</span>

func PeriodOverlapUploadLapangan() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.PeriodOverlapUploadLapangan", "upload period overlaps with AL period")
}</span>

func PeriodOverlapDokumenLapangan() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("Renstra.PeriodOverlapDokumenLapangan", "document period overlaps with AL period")
}</span>
</pre>
		
		<pre class="file" id="file78" style="display: none">package application

import (
        "context"
        "errors"

        domainrenstranilai "UnpakSiamida/modules/renstranilai/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type DeleteRenstraNilaiCommandHandler struct {
        Repo domainrenstranilai.IRenstraNilaiRepository
}

func (h *DeleteRenstraNilaiCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteRenstraNilaiCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        renstranilaiUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstranilai.InvalidUuid()
        }</span>

        // Get existing renstranilai
        <span class="cov8" title="1">_, err = h.Repo.GetByUuid(ctx, renstranilaiUUID)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return "", domainrenstranilai.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // Delete by UUID
        <span class="cov8" title="1">if err := h.Repo.Delete(ctx, renstranilaiUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov8" title="1">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file79" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func DeleteRenstraNilaiCommandValidation(cmd DeleteRenstraNilaiCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file80" style="display: none">package application

import (
    "context"
    domainrenstranilai "UnpakSiamida/modules/renstranilai/domain"
    "time"
)

type GetAllRenstraNilaisQueryHandler struct {
    Repo domainrenstranilai.IRenstraNilaiRepository
}

func (h *GetAllRenstraNilaisQueryHandler) Handle(
    ctx context.Context,
    q GetAllRenstraNilaisQuery,
) (domainrenstranilai.PagedRenstraNilais, error) <span class="cov0" title="0">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    renstranilais, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domainrenstranilai.PagedRenstraNilais{}, err
    }</span>

    <span class="cov0" title="0">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov0" title="0">{
        currentPage = *q.Page
    }</span>
    <span class="cov0" title="0">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov0" title="0">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov0" title="0">return domainrenstranilai.PagedRenstraNilais{
        Data:  renstranilais,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file81" style="display: none">package application

import (
    "context"

    domainrenstranilai "UnpakSiamida/modules/renstranilai/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetRenstraNilaiByUuidQueryHandler struct {
    Repo domainrenstranilai.IRenstraNilaiRepository
}

func (h *GetRenstraNilaiByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetRenstraNilaiByUuidQuery,
) (*domainrenstranilai.RenstraNilai, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return nil, domainrenstranilai.NotFound(q.Uuid)
        }</span>

    <span class="cov0" title="0">inrenstranilai, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                        return nil, domainrenstranilai.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov0" title="0">return inrenstranilai, nil</span>
}
</pre>
		
		<pre class="file" id="file82" style="display: none">package application

import (
        "context"

        domainrenstranilai "UnpakSiamida/modules/renstranilai/domain"
)

type SetupUuidRenstraNilaiCommandHandler struct {
        Repo domainrenstranilai.IRenstraNilaiRepository
}

func (h *SetupUuidRenstraNilaiCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidRenstraNilaiCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file83" style="display: none">package application

import (
        domainrenstra "UnpakSiamida/modules/renstra/domain"
        domainrenstranilai "UnpakSiamida/modules/renstranilai/domain"
        "context"
        "errors"
        "strings"
        "time"

        "github.com/go-sql-driver/mysql"
        "github.com/google/uuid"
        "golang.org/x/sync/errgroup"
)

type UpdateRenstraNilaiCommandHandler struct {
        Repo        domainrenstranilai.IRenstraNilaiRepository
        RepoRenstra domainrenstra.IRenstraRepository
}

func (h *UpdateRenstraNilaiCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateRenstraNilaiCommand,
) (string, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        renstraNilaiUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstranilai.InvalidUuid()
        }</span>

        <span class="cov0" title="0">renstraUUID, err := uuid.Parse(cmd.UuidRenstra)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainrenstranilai.InvalidRenstra()
        }</span>

        //paralel
        <span class="cov0" title="0">var (
                prev    *domainrenstranilai.RenstraNilai
                renstra *domainrenstra.Renstra
        )

        g, gctx := errgroup.WithContext(ctx)

        g.Go(func() error </span><span class="cov0" title="0">{
                var err error
                prev, err = h.Repo.GetByUuid(gctx, renstraNilaiUUID)
                if err != nil </span><span class="cov0" title="0">{
                        return domainrenstranilai.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return nil</span>
        })

        <span class="cov0" title="0">g.Go(func() error </span><span class="cov0" title="0">{
                var err error
                renstra, err = h.RepoRenstra.GetByUuid(gctx, renstraUUID)
                if err != nil </span><span class="cov0" title="0">{
                        return domainrenstranilai.NotFoundRenstra(cmd.UuidRenstra)
                }</span>
                <span class="cov0" title="0">return nil</span>
        })

        <span class="cov0" title="0">if err := g.Wait(); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">result := domainrenstranilai.UpdateRenstraNilai(
                prev,
                renstra,
                renstraNilaiUUID,
                renstraUUID,
                cmd.Tahun,
                cmd.Mode,
                cmd.Granted,
                cmd.Capaian,
                cmd.Catatan,
                cmd.LinkBukti,
                cmd.CapaianAuditor,
                cmd.CatatanAuditor,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov0" title="0">renstraNilai := result.Value

        if err := h.Repo.Update(ctx, renstraNilai); err != nil </span><span class="cov0" title="0">{
                //[note] ini harusnya ada di generate renstra bagian create + update
                //ini rule mustahil masuk, tapi memungkinan jika datanya hardcode oleh developer untuk duplicate lalu di update baru kena ini
                //ini tidak dapat di tes karena di domainnya ada rule pengecekan prev data
                var mysqlErr *mysql.MySQLError
                if errors.As(err, &amp;mysqlErr) </span><span class="cov0" title="0">{
                        if mysqlErr.Number == 1062 </span><span class="cov0" title="0">{
                                return "", domainrenstranilai.DuplicateData()
                        }</span>
                }
                <span class="cov0" title="0">if strings.Contains(err.Error(), "Duplicate entry") </span><span class="cov0" title="0">{
                        return "", domainrenstranilai.DuplicateData()
                }</span>

                <span class="cov0" title="0">return "", err</span>
        }

        <span class="cov0" title="0">return renstraNilai.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file84" style="display: none">package application

import (
        helper "UnpakSiamida/common/helper"

        validation "github.com/go-ozzo/ozzo-validation/v4"
)

func UpdateRenstraNilaiCommandValidation(cmd UpdateRenstraNilaiCommand) error <span class="cov0" title="0">{
        return validation.ValidateStruct(&amp;cmd,

                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.UuidRenstra,
                        validation.Required.Error("UUID Renstra cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Mode,
                        validation.Required.Error("Mode cannot be blank"),
                        validation.In("auditee", "auditor1", "auditor2").Error("Mode must be auditee, auditor1 or auditor2"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Granted,
                        validation.Required.Error("Granted cannot be blank"),
                ),

                // conditional validation
                validation.Field(&amp;cmd.Capaian,
                        validation.When(cmd.Mode == "auditee",
                                validation.Required.Error("Capaian cannot be blank for auditee"),
                                validation.By(helper.NoXSSFullScanWithDecode()),
                        ),
                ),

                /*
                        [vuln] case jika link bukan google drive maupun unpak, serangan yg memungkinkan memasukkan link external yg dimana tujuannya mengambil token pengguna seperti admin maupun auditor
                        CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:L/A:N (8.1)
                        | Metric                       | Value            | Alasan                           |
                        | ---------------------------- | ---------------- | -------------------------------- |
                        | Attack Vector (AV)                  | Network (N)      | Link via web                     |
                        | Attack Complexity (AC)       | Low (L)          | Cukup klik link                  |
                        | Privileges Required (PR)     | Low (L)          | Auditee bisa submit              |
                        | User Interaction (UI)        | Required (R)     | Admin/Auditor harus klik         |
                        | Scope (S)                    | Changed (C)      | Token dicuri ‚Üí akses sistem lain |
                        | Confidentiality (C)          | High (H)         | Token auth                       |
                        | Integrity (I)                | Low (L)          | Impersonation                    |
                        | Availability (A)             | None (N)         | Tidak DoS                        |
                */
                validation.Field(&amp;cmd.LinkBukti,
                        validation.When(cmd.Mode == "auditee",
                                validation.Required.Error("Link Bukti cannot be blank for auditee"),
                                validation.By(helper.NoXSSFullScanWithDecode()),
                        ),
                ),

                validation.Field(&amp;cmd.CapaianAuditor,
                        validation.When(cmd.Mode == "auditor1",
                                validation.Required.Error("CapaianAuditor cannot be blank for auditor1"),
                                validation.By(helper.NoXSSFullScanWithDecode()),
                        ),
                ),
        )
}</span>
</pre>
		
		<pre class="file" id="file85" style="display: none">package domain

import (
        "slices"
        "strings"
        "time"

        common "UnpakSiamida/common/domain"
        domainrenstra "UnpakSiamida/modules/renstra/domain"
        event "UnpakSiamida/modules/renstranilai/event"

        "github.com/google/uuid"
)

type RenstraNilai struct {
        common.Entity

        ID              uint      `gorm:"primaryKey;autoIncrement"`
        UUID            uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Renstra         uint      `gorm:"column:id_renstra;"`
        TemplateRenstra uint      `gorm:""`
        Tugas           string    `gorm:""`
        Capaian         *string   `gorm:""`
        Catatan         *string   `gorm:""`
        LinkBukti       *string   `gorm:"column:link_bukti;"`
        CapaianAuditor  *string   `gorm:"column:capaian_auditor;"`
        CatatanAuditor  *string   `gorm:"column:catatan_auditor;"`
}

func (RenstraNilai) TableName() string <span class="cov0" title="0">{
        return "renstra_nilai"
}</span>

func UpdateRenstraNilai(
        prev *RenstraNilai,
        renstra *domainrenstra.Renstra,
        Uuid uuid.UUID,
        UuidRenstra uuid.UUID,
        Tahun string,
        Mode string,
        Granted string,
        Capaian *string,
        Catatan *string,
        LinkBukti *string,
        CapaianAuditor *string,
        CatatanAuditor *string,
) common.ResultValue[*RenstraNilai] <span class="cov8" title="1">{

        if renstra == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*RenstraNilai](InvalidRenstra())
        }</span>

        <span class="cov8" title="1">if prev == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*RenstraNilai](EmptyData())
        }</span>

        <span class="cov8" title="1">if prev.UUID != Uuid ||
                renstra.UUID != UuidRenstra ||
                renstra.Tahun != Tahun </span><span class="cov8" title="1">{
                return common.FailureValue[*RenstraNilai](InvalidData())
        }</span>

        <span class="cov8" title="1">if !contains([]string{"auditee", "auditor1", "auditor2"}, Mode) </span><span class="cov8" title="1">{
                return common.FailureValue[*RenstraNilai](RejectAction())
        }</span>

        <span class="cov8" title="1">if !IsGrantedAccess(Tahun, Mode, Granted) </span><span class="cov8" title="1">{
                return common.FailureValue[*RenstraNilai](NotGranted())
        }</span>

        <span class="cov8" title="1">switch Mode </span>{
        case "auditee":<span class="cov8" title="1">
                prev.Capaian = Capaian
                prev.Catatan = Catatan
                prev.LinkBukti = LinkBukti</span>

        case "auditor1":<span class="cov8" title="1">
                prev.CapaianAuditor = CapaianAuditor
                prev.CatatanAuditor = CatatanAuditor</span>
        }

        <span class="cov8" title="1">prev.Raise(event.RenstraNilaiUpdatedEvent{ //[pr] ketika tersave maka buat kts
                EventID:          uuid.New(),
                OccurredOn:       time.Now().UTC(),
                RenstraNilaiUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}

func contains(list []string, value string) bool <span class="cov8" title="1">{
        return slices.Contains(list, value)
}</span>

func IsGrantedAccess(tahun, mode, granted string) bool <span class="cov8" title="1">{
        requiredKey := tahun + "#" + mode

        grantedList := strings.SplitSeq(granted, ",")

        for g := range grantedList </span><span class="cov8" title="1">{
                if strings.TrimSpace(g) == requiredKey </span><span class="cov8" title="1">{
                        return true
                }</span>
        }

        <span class="cov8" title="1">return false</span>
}
</pre>
		
		<pre class="file" id="file86" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("RenstraNilai.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("RenstraNilai.InvalidUuid", "uuid is invalid")
}</span>

func InvalidRenstra() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("RenstraNilai.InvalidRenstra", "renstra is invalid")
}</span>

func RejectAction() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("RenstraNilai.RejectAction", "your action was rejected")
}</span>

func NotGranted() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("RenstraNilai.NotGranted", "you are not granted permission in this action")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("RenstraNilai.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("RenstraNilai.NotFound", fmt.Sprintf("RenstraNilai with identifier %s not found", id))
}</span>
func NotFoundRenstra(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("RenstraNilai.NotFoundRenstra", fmt.Sprintf("Renstra with identifier %s not found", id))
}</span>

func DuplicateData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("RenstraNilai.DuplicateData", "data not allowed duplicate")
}</span>
</pre>
		
		<pre class="file" id="file87" style="display: none">package application

import (
        "context"
        
        domainstandarrenstra "UnpakSiamida/modules/standarrenstra/domain"
        "time"
)

type CreateStandarRenstraCommandHandler struct{
        Repo domainstandarrenstra.IStandarRenstraRepository
}

func (h *CreateStandarRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd CreateStandarRenstraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        result := domainstandarrenstra.NewStandarRenstra(
                cmd.Nama,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">createStandarRenstra := result.Value
        if err := h.Repo.Create(ctx, createStandarRenstra); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">return result.Value.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file88" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func CreateStandarRenstraCommandValidation(cmd CreateStandarRenstraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Nama,
                        validation.Required.Error("Nama cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file89" style="display: none">package application

import (
        "context"
        "errors"

        domainstandarrenstra "UnpakSiamida/modules/standarrenstra/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type DeleteStandarRenstraCommandHandler struct {
        Repo domainstandarrenstra.IStandarRenstraRepository
}

func (h *DeleteStandarRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteStandarRenstraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        standarrenstraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainstandarrenstra.InvalidUuid()
        }</span>

        // Get existing standarrenstra
        <span class="cov8" title="1">_, err = h.Repo.GetByUuid(ctx, standarrenstraUUID)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return "", domainstandarrenstra.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // Delete by UUID
        <span class="cov8" title="1">if err := h.Repo.Delete(ctx, standarrenstraUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov8" title="1">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file90" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func DeleteStandarRenstraCommandValidation(cmd DeleteStandarRenstraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file91" style="display: none">package application

import (
    "context"
    domainstandarrenstra "UnpakSiamida/modules/standarrenstra/domain"
    "time"
)

type GetAllStandarRenstrasQueryHandler struct {
    Repo domainstandarrenstra.IStandarRenstraRepository
}

func (h *GetAllStandarRenstrasQueryHandler) Handle(
    ctx context.Context,
    q GetAllStandarRenstrasQuery,
) (domainstandarrenstra.PagedStandarRenstras, error) <span class="cov8" title="1">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    standarrenstras, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domainstandarrenstra.PagedStandarRenstras{}, err
    }</span>

    <span class="cov8" title="1">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov8" title="1">{
        currentPage = *q.Page
    }</span>
    <span class="cov8" title="1">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov8" title="1">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov8" title="1">return domainstandarrenstra.PagedStandarRenstras{
        Data:  standarrenstras,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file92" style="display: none">package application

import (
    "context"

    domainstandarrenstra "UnpakSiamida/modules/standarrenstra/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetStandarRenstraByUuidQueryHandler struct {
    Repo domainstandarrenstra.IStandarRenstraRepository
}

func (h *GetStandarRenstraByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetStandarRenstraByUuidQuery,
) (*domainstandarrenstra.StandarRenstra, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov8" title="1">{
                return nil, domainstandarrenstra.NotFound(q.Uuid)
        }</span>

    <span class="cov8" title="1">standarrenstra, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainstandarrenstra.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov8" title="1">return standarrenstra, nil</span>
}
</pre>
		
		<pre class="file" id="file93" style="display: none">package application

import (
        "context"

        domainstandarrenstra "UnpakSiamida/modules/standarrenstra/domain"
)

type SetupUuidStandarRenstraCommandHandler struct {
        Repo domainstandarrenstra.IStandarRenstraRepository
}

func (h *SetupUuidStandarRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidStandarRenstraCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file94" style="display: none">package application

import (
        "context"
        "errors"

        domainstandarrenstra "UnpakSiamida/modules/standarrenstra/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type UpdateStandarRenstraCommandHandler struct {
        Repo domainstandarrenstra.IStandarRenstraRepository
}

func (h *UpdateStandarRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateStandarRenstraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // -------------------------
        // VALIDATE UUID
        // -------------------------
        standarrenstraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domainstandarrenstra.InvalidUuid()
        }</span>

        // -------------------------
        // GET EXISTING standarrenstra
        // -------------------------
        <span class="cov8" title="1">existingStandarRenstra, err := h.Repo.GetByUuid(ctx, standarrenstraUUID) // ‚Üê memastikan pakai nama interface yg benar
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return "", domainstandarrenstra.NotFound(cmd.Uuid)
                }</span>
                <span class="cov0" title="0">return "", err</span>
        }

        // -------------------------
        // AGGREGATE ROOT LOGIC
        // -------------------------
        <span class="cov8" title="1">result := domainstandarrenstra.UpdateStandarRenstra(
                existingStandarRenstra,
                standarrenstraUUID,
                cmd.Nama,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">updatedStandarRenstra := result.Value

        // -------------------------
        // SAVE TO REPOSITORY
        // -------------------------
        if err := h.Repo.Update(ctx, updatedStandarRenstra); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">return updatedStandarRenstra.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file95" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func UpdateStandarRenstraCommandValidation(cmd UpdateStandarRenstraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Nama,
                        validation.Required.Error("Nama cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file96" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/standarrenstra/event"

        "github.com/google/uuid"
)

type StandarRenstra struct {
        common.Entity
        ID   uint      `gorm:"primaryKey;autoIncrement"`
        UUID uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Nama string    `gorm:"type:longtext;not null"`
}

func (StandarRenstra) TableName() string <span class="cov0" title="0">{
        return "master_standar_renstra"
}</span>

// === CREATE ===
func NewStandarRenstra(nama string) common.ResultValue[*StandarRenstra] <span class="cov8" title="1">{

        standarrenstra := &amp;StandarRenstra{
                UUID: uuid.New(),
                Nama: nama,
        }

        standarrenstra.Raise(event.StandarRenstraCreatedEvent{
                EventID:            uuid.New(),
                OccurredOn:         time.Now().UTC(),
                StandarRenstraUUID: standarrenstra.UUID,
        })

        return common.SuccessValue(standarrenstra)
}</span>

// === UPDATE ===
func UpdateStandarRenstra(
        prev *StandarRenstra,
        uid uuid.UUID,
        nama string,
) common.ResultValue[*StandarRenstra] <span class="cov8" title="1">{

        if prev == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*StandarRenstra](EmptyData())
        }</span>

        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*StandarRenstra](InvalidData())
        }</span>

        <span class="cov8" title="1">prev.Nama = nama

        prev.Raise(event.StandarRenstraUpdatedEvent{
                EventID:            uuid.New(),
                OccurredOn:         time.Now().UTC(),
                StandarRenstraUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file97" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("StandarRenstra.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("StandarRenstra.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("StandarRenstra.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("StandarRenstra.NotFound", fmt.Sprintf("StandarRenstra with identifier %s not found", id) )
}</span>
</pre>
		
		<pre class="file" id="file98" style="display: none">package application

import (
    "context"

    domainTahunRenstra "UnpakSiamida/modules/tahunrenstra/domain"
    "errors"
    "gorm.io/gorm"
    "time"
)

type GetActiveTahunRenstraQueryHandler struct {
    Repo domainTahunRenstra.ITahunRenstraRepository
}

func (h *GetActiveTahunRenstraQueryHandler) Handle(
    ctx context.Context,
    q GetActiveTahunRenstraQuery,
) (*domainTahunRenstra.TahunRenstra, error) <span class="cov8" title="1">{
    ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    tahunrenstra, err := h.Repo.GetActive(ctx)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domainTahunRenstra.EmptyData()
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov8" title="1">return tahunrenstra, nil</span>
}
</pre>
		
		<pre class="file" id="file99" style="display: none">package application

import (
    "context"
    domainTahunRenstra "UnpakSiamida/modules/tahunrenstra/domain"
    "time"
)

type GetAllTahunRenstrasQueryHandler struct {
    Repo domainTahunRenstra.ITahunRenstraRepository
}

func (h *GetAllTahunRenstrasQueryHandler) Handle(
    ctx context.Context,
    q GetAllTahunRenstrasQuery,
) (domainTahunRenstra.PagedTahunRenstras, error) <span class="cov8" title="1">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    TahunRenstras, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domainTahunRenstra.PagedTahunRenstras{}, err
    }</span>

    <span class="cov8" title="1">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov8" title="1">{
        currentPage = *q.Page
    }</span>
    <span class="cov8" title="1">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov8" title="1">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov8" title="1">return domainTahunRenstra.PagedTahunRenstras{
        Data:  TahunRenstras,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file100" style="display: none">package domain

import (
        common "UnpakSiamida/common/domain"
)

type TahunRenstra struct {
        common.Entity
        Tahun        string     `gorm:""`
        Status       string     `gorm:""`
}
func (TahunRenstra) TableName() string <span class="cov0" title="0">{
        return "v_tahun_renstra"
}</pre>
		
		<pre class="file" id="file101" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TahunRenstra.EmptyData", "data is not found")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TahunRenstra.NotFound", fmt.Sprintf("TahunRenstra with identifier %s not found", id) )
}</span>
</pre>
		
		<pre class="file" id="file102" style="display: none">package application

import (
        "context"

        "github.com/google/uuid"

        domainjenisfile "UnpakSiamida/modules/jenisfile/domain"
        domaintemplatedokumentambahan "UnpakSiamida/modules/templatedokumentambahan/domain"
        "errors"
        "time"

        "gorm.io/gorm"
)

type CreateTemplateDokumenTambahanCommandHandler struct {
        Repo          domaintemplatedokumentambahan.ITemplateDokumenTambahanRepository
        JenisFileRepo domainjenisfile.IJenisFileRepository
}

func (h *CreateTemplateDokumenTambahanCommandHandler) Handle(
        ctx context.Context,
        cmd CreateTemplateDokumenTambahanCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        uuidJenisFile, err := uuid.Parse(cmd.JenisFile)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaintemplatedokumentambahan.JenisFileNotFound()
        }</span>

        <span class="cov8" title="1">jenisfile, err := h.JenisFileRepo.GetDefaultByUuid(ctx, uuidJenisFile)

        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return "", domaintemplatedokumentambahan.JenisFileNotFound()
                }</span>

                <span class="cov0" title="0">return "", err</span>
        }

        <span class="cov8" title="1">result := domaintemplatedokumentambahan.NewTemplateDokumenTambahan(
                cmd.Tahun,
                jenisfile.Id,
                cmd.Pertanyaan,
                cmd.Klasifikasi,
                cmd.Kategori,
                cmd.Tugas,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">templateDokumenTambahan := result.Value

        // --------------------------
        // SAVE REPOSITORY
        // --------------------------
        if err := h.Repo.Create(ctx, templateDokumenTambahan); err != nil </span><span class="cov0" title="0">{
                // var mysqlErr *mysql.MySQLError
                // if errors.As(err, &amp;mysqlErr) { //gagal masuk kesini
                //         if mysqlErr.Number == 1062 {
                //                 return "", domaintemplatedokumentambahan.DuplicateData()
                //         }
                // }
                // if strings.Contains(err.Error(), "Duplicate entry") { //gagal masuk kesini
                //         return "", domaintemplatedokumentambahan.DuplicateData()
                // }

                return "", err
        }</span>

        <span class="cov8" title="1">return templateDokumenTambahan.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file103" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func CreateTemplateDokumenTambahanCommandValidation(cmd CreateTemplateDokumenTambahanCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.JenisFile,
                        validation.Required.Error("JenisFile cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                        validation.By(helper.ValidateUUIDv4),
                ),
                validation.Field(&amp;cmd.Pertanyaan,
                        validation.Required.Error("Pertanyaan cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Klasifikasi,
                        validation.Required.Error("Klasifikasi cannot be blank"),
                        validation.In("minor", "major").Error("Klasifikasi invalid value"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Kategori, //fakultas_prodi_unit
                        validation.Required.Error("Kategori cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Tugas,
                        validation.Required.Error("Tugas cannot be blank"),
                        validation.In("auditor1", "auditor2").Error("Tugas invalid value"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file104" style="display: none">package application

import (
        "context"
        "errors"

        domaintemplatedokumentambahan "UnpakSiamida/modules/templatedokumentambahan/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type DeleteTemplateDokumenTambahanCommandHandler struct {
        Repo domaintemplatedokumentambahan.ITemplateDokumenTambahanRepository
}

func (h *DeleteTemplateDokumenTambahanCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteTemplateDokumenTambahanCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        templatedokumentambahanUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaintemplatedokumentambahan.InvalidUuid()
        }</span>

        // Get existing templatedokumentambahan
        <span class="cov8" title="1">_, err = h.Repo.GetByUuid(ctx, templatedokumentambahanUUID)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return "", domaintemplatedokumentambahan.NotFound(cmd.Uuid)
                }</span>
                <span class="cov8" title="1">return "", err</span>
        }

        // Delete by UUID
        <span class="cov8" title="1">if err := h.Repo.Delete(ctx, templatedokumentambahanUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov8" title="1">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file105" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func DeleteTemplateDokumenTambahanCommandValidation(cmd DeleteTemplateDokumenTambahanCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file106" style="display: none">package application

import (
    "context"
    domaintemplatedokumentambahan "UnpakSiamida/modules/templatedokumentambahan/domain"
    "time"
)

type GetAllTemplateDokumenTambahansQueryHandler struct {
    Repo domaintemplatedokumentambahan.ITemplateDokumenTambahanRepository
}

func (h *GetAllTemplateDokumenTambahansQueryHandler) Handle(
    ctx context.Context,
    q GetAllTemplateDokumenTambahansQuery,
) (domaintemplatedokumentambahan.PagedTemplateDokumenTambahans, error) <span class="cov8" title="1">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    templatedokumentambahans, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domaintemplatedokumentambahan.PagedTemplateDokumenTambahans{}, err
    }</span>

    <span class="cov8" title="1">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov8" title="1">{
        currentPage = *q.Page
    }</span>
    <span class="cov8" title="1">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov8" title="1">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov8" title="1">return domaintemplatedokumentambahan.PagedTemplateDokumenTambahans{
        Data:  templatedokumentambahans,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file107" style="display: none">package application

import (
    "context"

    domaintemplatedokumentambahan "UnpakSiamida/modules/templatedokumentambahan/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetTemplateDokumenTambahanByUuidQueryHandler struct {
    Repo domaintemplatedokumentambahan.ITemplateDokumenTambahanRepository
}

func (h *GetTemplateDokumenTambahanByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetTemplateDokumenTambahanByUuidQuery,
) (*domaintemplatedokumentambahan.TemplateDokumenTambahan, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov8" title="1">{
                return nil, domaintemplatedokumentambahan.NotFound(q.Uuid)
        }</span>

    <span class="cov8" title="1">templatedokumentambahan, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domaintemplatedokumentambahan.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov8" title="1">return templatedokumentambahan, nil</span>
}
</pre>
		
		<pre class="file" id="file108" style="display: none">package application

import (
        "context"

        domaintemplatedokumentambahan "UnpakSiamida/modules/templatedokumentambahan/domain"
)

type SetupUuidTemplateDokumenTambahanCommandHandler struct {
        Repo domaintemplatedokumentambahan.ITemplateDokumenTambahanRepository
}

func (h *SetupUuidTemplateDokumenTambahanCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidTemplateDokumenTambahanCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file109" style="display: none">package application

import (
        "context"
        "strings"

        "github.com/go-sql-driver/mysql"
        "github.com/google/uuid"
        "golang.org/x/sync/errgroup"

        domainjenisfile "UnpakSiamida/modules/jenisfile/domain"
        domaintemplatedokumentambahan "UnpakSiamida/modules/templatedokumentambahan/domain"
        "errors"
        "time"

        "gorm.io/gorm"
)

type UpdateTemplateDokumenTambahanCommandHandler struct {
        Repo          domaintemplatedokumentambahan.ITemplateDokumenTambahanRepository
        JenisFileRepo domainjenisfile.IJenisFileRepository
}

func (h *UpdateTemplateDokumenTambahanCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateTemplateDokumenTambahanCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // -------------------------
        // VALIDATE UUID
        // -------------------------
        templatedokumentambahanUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaintemplatedokumentambahan.InvalidUuid()
        }</span>
        <span class="cov8" title="1">uuidJenisFile, err := uuid.Parse(cmd.JenisFile)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaintemplatedokumentambahan.JenisFileNotFound()
        }</span>

        // -------------------------
        // GET EXISTING templatedokumentambahan
        // -------------------------
        <span class="cov8" title="1">var (
                jenisfile                       *domainjenisfile.JenisFileDefault
                existingTemplateDokumenTambahan *domaintemplatedokumentambahan.TemplateDokumenTambahan
        )

        g, gctx := errgroup.WithContext(context.Background())

        g.Go(func() error </span><span class="cov8" title="1">{
                r, err := h.JenisFileRepo.GetDefaultByUuid(gctx, uuidJenisFile)
                if err != nil </span><span class="cov8" title="1">{
                        if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                                return domaintemplatedokumentambahan.JenisFileNotFound()
                        }</span>
                        <span class="cov8" title="1">return err</span>
                }
                <span class="cov8" title="1">jenisfile = r
                return nil</span>
        })

        <span class="cov8" title="1">g.Go(func() error </span><span class="cov8" title="1">{
                r, err := h.Repo.GetByUuid(ctx, templatedokumentambahanUUID)
                if err != nil </span><span class="cov8" title="1">{
                        if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                                return domaintemplatedokumentambahan.NotFound(cmd.Uuid)
                        }</span>
                        <span class="cov0" title="0">return err</span>
                }
                <span class="cov8" title="1">existingTemplateDokumenTambahan = r
                return nil</span>
        })

        <span class="cov8" title="1">if err := g.Wait(); err != nil </span><span class="cov8" title="1">{
                return "", err
        }</span>

        // -------------------------
        // AGGREGATE ROOT LOGIC
        // -------------------------
        <span class="cov8" title="1">result := domaintemplatedokumentambahan.UpdateTemplateDokumenTambahan(
                existingTemplateDokumenTambahan,
                templatedokumentambahanUUID,
                cmd.Tahun,
                jenisfile.Id,
                cmd.Pertanyaan,
                cmd.Klasifikasi,
                cmd.Kategori,
                cmd.Tugas,
        )

        if !result.IsSuccess </span><span class="cov0" title="0">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">updatedTemplateDokumenTambahan := result.Value

        // -------------------------
        // SAVE TO REPOSITORY
        // -------------------------
        if err := h.Repo.Update(ctx, updatedTemplateDokumenTambahan); err != nil </span><span class="cov0" title="0">{
                var mysqlErr *mysql.MySQLError
                if errors.As(err, &amp;mysqlErr) </span><span class="cov0" title="0">{
                        if mysqlErr.Number == 1062 </span><span class="cov0" title="0">{
                                return "", domaintemplatedokumentambahan.DuplicateData()
                        }</span>
                }
                <span class="cov0" title="0">if strings.Contains(err.Error(), "Duplicate entry") </span><span class="cov0" title="0">{
                        return "", domaintemplatedokumentambahan.DuplicateData()
                }</span>

                <span class="cov0" title="0">return "", err</span>
        }

        <span class="cov8" title="1">return updatedTemplateDokumenTambahan.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file110" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func UpdateTemplateDokumenTambahanCommandValidation(cmd UpdateTemplateDokumenTambahanCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun cannot be blank"),
                ),
                validation.Field(&amp;cmd.JenisFile,
                        validation.Required.Error("JenisFile cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Pertanyaan,
                        validation.Required.Error("Pertanyaan cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Klasifikasi,
                        validation.Required.Error("Klasifikasi cannot be blank"),
                        validation.In("minor", "major").Error("Klasifikasi invalid value"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Kategori, //fakultas_prodi_unit
                        validation.Required.Error("Kategori cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Tugas,
                        validation.Required.Error("Tugas cannot be blank"),
                        validation.In("auditor1", "auditor2").Error("Tugas invalid value"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file111" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/templatedokumentambahan/event"

        "github.com/google/uuid"
)

type TemplateDokumenTambahan struct {
        common.Entity
        ID          uint      `gorm:"primaryKey;autoIncrement"`
        UUID        uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Tahun       string
        JenisFileID uint   `gorm:"column:jenis_file"`
        Pertanyaan  string `gorm:"type:longtext"`
        Klasifikasi string
        Kategori    string `gorm:"column:fakultas_prodi_unit"`
        Tugas       string
}

func (TemplateDokumenTambahan) TableName() string <span class="cov0" title="0">{
        return "template_dokumen_tambahan"
}</span>

// === CREATE ===
func NewTemplateDokumenTambahan(
        tahun string,
        jenisFileID uint,
        pertanyaan string,
        klasifikasi string,
        kategori string,
        tugas string,
) common.ResultValue[*TemplateDokumenTambahan] <span class="cov8" title="1">{
        if jenisFileID &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*TemplateDokumenTambahan](JenisFileNotFound())
        }</span>

        <span class="cov8" title="1">templatedokumentambahan := &amp;TemplateDokumenTambahan{
                UUID:        uuid.New(),
                Tahun:       tahun,
                JenisFileID: jenisFileID,
                Pertanyaan:  pertanyaan,
                Klasifikasi: klasifikasi,
                Kategori:    kategori,
                Tugas:       tugas,
        }

        templatedokumentambahan.Raise(event.TemplateDokumenTambahanCreatedEvent{
                EventID:                     uuid.New(),
                OccurredOn:                  time.Now().UTC(),
                TemplateDokumenTambahanUUID: templatedokumentambahan.UUID,
        })

        return common.SuccessValue(templatedokumentambahan)</span>
}

// === UPDATE ===
func UpdateTemplateDokumenTambahan(
        prev *TemplateDokumenTambahan,
        uid uuid.UUID,
        tahun string,
        jenisFileID uint,
        pertanyaan string,
        klasifikasi string,
        kategori string,
        tugas string,
) common.ResultValue[*TemplateDokumenTambahan] <span class="cov8" title="1">{

        if prev == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*TemplateDokumenTambahan](EmptyData())
        }</span>
        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*TemplateDokumenTambahan](InvalidData())
        }</span>
        <span class="cov8" title="1">if jenisFileID &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*TemplateDokumenTambahan](JenisFileNotFound())
        }</span>

        <span class="cov8" title="1">prev.Tahun = tahun
        prev.JenisFileID = jenisFileID
        prev.Pertanyaan = pertanyaan
        prev.Klasifikasi = klasifikasi
        prev.Kategori = kategori
        prev.Tugas = tugas

        prev.Raise(event.TemplateDokumenTambahanUpdatedEvent{
                EventID:                     uuid.New(),
                OccurredOn:                  time.Now().UTC(),
                TemplateDokumenTambahanUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file112" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateDokumenTambahan.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateDokumenTambahan.InvalidUuid", "uuid is invalid")
}</span>

func JenisFileNotFound() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateDokumenTambahan.JenisFileNotFound", "JenisFile is not found")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateDokumenTambahan.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateDokumenTambahan.NotFound", fmt.Sprintf("TemplateDokumenTambahan with identifier %s not found", id))
}</span>

func DuplicateData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateDokumenTambahan.DuplicateData", "data not allowed duplicate")
}</span>
</pre>
		
		<pre class="file" id="file113" style="display: none">package application

import (
        "context"
        "strings"

        "github.com/go-sql-driver/mysql"
        "github.com/google/uuid"
        "golang.org/x/sync/errgroup"

        domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
        domaintemplaterenstra "UnpakSiamida/modules/templaterenstra/domain"
        "errors"
        "time"

        "gorm.io/gorm"
)

type CreateTemplateRenstraCommandHandler struct {
        Repo                 domaintemplaterenstra.ITemplateRenstraRepository
        IndikatorRenstraRepo domainindikatorrenstra.IIndikatorRenstraRepository
        FakultasUnitRepo     domainfakultasunit.IFakultasUnitRepository
}

func (h *CreateTemplateRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd CreateTemplateRenstraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        uuidIndikator, err := uuid.Parse(cmd.Indikator)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaintemplaterenstra.IndikatorNotFound()
        }</span>

        <span class="cov8" title="1">uuidFakultasUnit, err := uuid.Parse(cmd.FakultasUnit)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaintemplaterenstra.FakultasUnitNotFound()
        }</span>

        <span class="cov8" title="1">var (
                indikatorDefault    *domainindikatorrenstra.IndikatorRenstraDefault
                fakultasunitDefault *domainfakultasunit.FakultasUnit
        )

        g, gctx := errgroup.WithContext(context.Background())

        g.Go(func() error </span><span class="cov8" title="1">{
                r, err := h.IndikatorRenstraRepo.GetDefaultByUuid(gctx, uuidIndikator)
                if err != nil </span><span class="cov8" title="1">{
                        if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                                return domaintemplaterenstra.IndikatorNotFound()
                        }</span>
                        <span class="cov0" title="0">return err</span>
                }
                <span class="cov8" title="1">indikatorDefault = r
                return nil</span>
        })

        <span class="cov8" title="1">g.Go(func() error </span><span class="cov8" title="1">{
                r, err := h.FakultasUnitRepo.GetDefaultByUuid(gctx, uuidFakultasUnit)
                if err != nil </span><span class="cov8" title="1">{
                        if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                                return domaintemplaterenstra.FakultasUnitNotFound()
                        }</span>
                        <span class="cov8" title="1">return err</span>
                }
                <span class="cov8" title="1">fakultasunitDefault = r
                return nil</span>
        })

        <span class="cov8" title="1">if err := g.Wait(); err != nil </span><span class="cov8" title="1">{
                return "", err
        }</span>

        <span class="cov8" title="1">result := domaintemplaterenstra.NewTemplateRenstra(
                cmd.Tahun,
                indikatorDefault.Id,
                cmd.IsPertanyaan == "1",
                fakultasunitDefault.ID,
                cmd.Kategori,
                cmd.Klasifikasi,
                cmd.Satuan,
                cmd.Target,
                cmd.TargetMin,
                cmd.TargetMax,
                cmd.Tugas,
        )

        if !result.IsSuccess </span><span class="cov8" title="1">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">templateRenstra := result.Value

        // --------------------------
        // SAVE REPOSITORY
        // --------------------------
        if err := h.Repo.Create(ctx, templateRenstra); err != nil </span><span class="cov8" title="1">{
                var mysqlErr *mysql.MySQLError
                if errors.As(err, &amp;mysqlErr) </span><span class="cov0" title="0">{
                        if mysqlErr.Number == 1062 </span><span class="cov0" title="0">{
                                return "", domaintemplaterenstra.DuplicateData()
                        }</span>
                }
                <span class="cov8" title="1">if strings.Contains(err.Error(), "Duplicate entry") </span><span class="cov0" title="0">{
                        return "", domaintemplaterenstra.DuplicateData()
                }</span>

                <span class="cov8" title="1">return "", err</span>
        }

        <span class="cov8" title="1">return templateRenstra.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file114" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func CreateTemplateRenstraCommandValidation(cmd CreateTemplateRenstraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Indikator,
                        validation.Required.Error("Indikator cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.IsPertanyaan,
                        validation.Required.Error("IsPertanyaan cannot be blank"),
                        validation.In("1", "0").Error("IsPertanyaan invalid value"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.FakultasUnit,
                        validation.Required.Error("FakultasUnit cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Kategori,
                        validation.Required.Error("Kategori cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Klasifikasi,
                        validation.Required.Error("Klasifikasi cannot be blank"),
                        validation.In("minor", "major").Error("Klasifikasi invalid value"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                // validation.Field(&amp;cmd.Target,
                //         validation.When(cmd.Target != nil, validation.Nil), // skip TargetMin/Max jika Target ada
                // ),
                // validation.Field(&amp;cmd.TargetMin,
                //         validation.When(cmd.Target == nil, validation.Required.Error("TargetMin cannot be blank")),
                // ),
                // validation.Field(&amp;cmd.TargetMax,
                //         validation.When(cmd.Target == nil, validation.Required.Error("TargetMin cannot be blank")),
                // ),
                validation.Field(&amp;cmd.Tugas,
                        validation.Required.Error("Tugas cannot be blank"),
                        validation.In("auditor1", "auditor2").Error("Tugas invalid value"),
                ),
        )
}</pre>
		
		<pre class="file" id="file115" style="display: none">package application

import (
        "context"
        "errors"

        domaintemplaterenstra "UnpakSiamida/modules/templaterenstra/domain"
        "time"

        "github.com/google/uuid"
        "gorm.io/gorm"
)

type DeleteTemplateRenstraCommandHandler struct {
        Repo domaintemplaterenstra.ITemplateRenstraRepository
}

func (h *DeleteTemplateRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd DeleteTemplateRenstraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // Validate UUID
        templaterenstraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaintemplaterenstra.InvalidUuid()
        }</span>

        // Get existing templaterenstra
        <span class="cov8" title="1">_, err = h.Repo.GetByUuid(ctx, templaterenstraUUID)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return "", domaintemplaterenstra.NotFound(cmd.Uuid)
                }</span>
                <span class="cov8" title="1">return "", err</span>
        }

        // Delete by UUID
        <span class="cov8" title="1">if err := h.Repo.Delete(ctx, templaterenstraUUID); err != nil </span><span class="cov0" title="0">{ // FIXED
                return "", err
        }</span>

        <span class="cov8" title="1">return cmd.Uuid, nil</span>
}
</pre>
		
		<pre class="file" id="file116" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func DeleteTemplateRenstraCommandValidation(cmd DeleteTemplateRenstraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
        )
}</pre>
		
		<pre class="file" id="file117" style="display: none">package application

import (
    "context"
    domaintemplaterenstra "UnpakSiamida/modules/templaterenstra/domain"
    "time"
)

type GetAllTemplateRenstrasQueryHandler struct {
    Repo domaintemplaterenstra.ITemplateRenstraRepository
}

func (h *GetAllTemplateRenstrasQueryHandler) Handle(
    ctx context.Context,
    q GetAllTemplateRenstrasQuery,
) (domaintemplaterenstra.PagedTemplateRenstras, error) <span class="cov8" title="1">{
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
        defer cancel()

    templaterenstras, total, err := h.Repo.GetAll(
        ctx,
        q.Search,
        q.SearchFilters,
        q.Page,
        q.Limit,
    )
    if err != nil </span><span class="cov0" title="0">{
        return domaintemplaterenstra.PagedTemplateRenstras{}, err
    }</span>

    <span class="cov8" title="1">currentPage := 1
    totalPages := 1

    if q.Page != nil </span><span class="cov8" title="1">{
        currentPage = *q.Page
    }</span>
    <span class="cov8" title="1">if q.Limit != nil &amp;&amp; *q.Limit &gt; 0 </span><span class="cov8" title="1">{
        totalPages = int((total + int64(*q.Limit) - 1) / int64(*q.Limit))
    }</span>

    <span class="cov8" title="1">return domaintemplaterenstra.PagedTemplateRenstras{
        Data:  templaterenstras,
        Total: total,
        CurrentPage: currentPage,
        TotalPages:  totalPages,
    }, nil</span>
}</pre>
		
		<pre class="file" id="file118" style="display: none">package application

import (
    "context"

    domaintemplaterenstra "UnpakSiamida/modules/templaterenstra/domain"
    "github.com/google/uuid"
        "errors"
    "gorm.io/gorm"
        "time"
)

type GetTemplateRenstraByUuidQueryHandler struct {
    Repo domaintemplaterenstra.ITemplateRenstraRepository
}

func (h *GetTemplateRenstraByUuidQueryHandler) Handle(
    ctx context.Context,
    q GetTemplateRenstraByUuidQuery,
) (*domaintemplaterenstra.TemplateRenstra, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
        defer cancel()

    parsed, err := uuid.Parse(q.Uuid)
        if err != nil </span><span class="cov8" title="1">{
                return nil, domaintemplaterenstra.NotFound(q.Uuid)
        }</span>

    <span class="cov8" title="1">templaterenstra, err := h.Repo.GetByUuid(ctx, parsed)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                        return nil, domaintemplaterenstra.NotFound(q.Uuid)
                }</span>
                <span class="cov0" title="0">return nil, err</span>
        }

    <span class="cov8" title="1">return templaterenstra, nil</span>
}
</pre>
		
		<pre class="file" id="file119" style="display: none">package application

import (
        "context"

        domaintemplaterenstra "UnpakSiamida/modules/templaterenstra/domain"
)

type SetupUuidTemplateRenstraCommandHandler struct {
        Repo domaintemplaterenstra.ITemplateRenstraRepository
}

func (h *SetupUuidTemplateRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd SetupUuidTemplateRenstraCommand,
) (string, error) <span class="cov0" title="0">{

        err := h.Repo.SetupUuid(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return "berhasil setup uuid pada data", nil</span>
}
</pre>
		
		<pre class="file" id="file120" style="display: none">package application

import (
        "context"
        "strings"

        "github.com/go-sql-driver/mysql"
        "github.com/google/uuid"
        "golang.org/x/sync/errgroup"

        domainfakultasunit "UnpakSiamida/modules/fakultasunit/domain"
        domainindikatorrenstra "UnpakSiamida/modules/indikatorrenstra/domain"
        domaintemplaterenstra "UnpakSiamida/modules/templaterenstra/domain"
        "errors"
        "time"

        "gorm.io/gorm"
)

type UpdateTemplateRenstraCommandHandler struct {
        Repo                 domaintemplaterenstra.ITemplateRenstraRepository
        IndikatorRenstraRepo domainindikatorrenstra.IIndikatorRenstraRepository
        FakultasUnitRepo     domainfakultasunit.IFakultasUnitRepository
}

func (h *UpdateTemplateRenstraCommandHandler) Handle(
        ctx context.Context,
        cmd UpdateTemplateRenstraCommand,
) (string, error) <span class="cov8" title="1">{
        ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
        defer cancel()

        // -------------------------
        // VALIDATE UUID
        // -------------------------
        templaterenstraUUID, err := uuid.Parse(cmd.Uuid)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaintemplaterenstra.InvalidUuid()
        }</span>
        <span class="cov8" title="1">uuidIndikator, err := uuid.Parse(cmd.Indikator)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaintemplaterenstra.IndikatorNotFound()
        }</span>
        <span class="cov8" title="1">uuidFakultasUnit, err := uuid.Parse(cmd.FakultasUnit)
        if err != nil </span><span class="cov0" title="0">{
                return "", domaintemplaterenstra.FakultasUnitNotFound()
        }</span>

        // -------------------------
        // GET EXISTING templaterenstra
        // -------------------------
        <span class="cov8" title="1">var (
                indikatorDefault        *domainindikatorrenstra.IndikatorRenstraDefault
                fakultasunitDefault     *domainfakultasunit.FakultasUnit
                existingTemplateRenstra *domaintemplaterenstra.TemplateRenstra
        )

        g, gctx := errgroup.WithContext(context.Background())

        g.Go(func() error </span><span class="cov8" title="1">{
                r, err := h.IndikatorRenstraRepo.GetDefaultByUuid(gctx, uuidIndikator)
                if err != nil </span><span class="cov8" title="1">{
                        if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                                return domaintemplaterenstra.IndikatorNotFound()
                        }</span>
                        <span class="cov8" title="1">return err</span>
                }
                <span class="cov8" title="1">indikatorDefault = r
                return nil</span>
        })

        <span class="cov8" title="1">g.Go(func() error </span><span class="cov8" title="1">{
                r, err := h.FakultasUnitRepo.GetDefaultByUuid(gctx, uuidFakultasUnit)
                if err != nil </span><span class="cov8" title="1">{
                        if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov8" title="1">{
                                return domaintemplaterenstra.FakultasUnitNotFound()
                        }</span>
                        <span class="cov8" title="1">return err</span>
                }
                <span class="cov8" title="1">fakultasunitDefault = r
                return nil</span>
        })

        <span class="cov8" title="1">g.Go(func() error </span><span class="cov8" title="1">{
                r, err := h.Repo.GetByUuid(ctx, templaterenstraUUID)
                if err != nil </span><span class="cov8" title="1">{
                        if errors.Is(err, gorm.ErrRecordNotFound) </span><span class="cov0" title="0">{
                                return domaintemplaterenstra.NotFound(cmd.Uuid)
                        }</span>
                        <span class="cov8" title="1">return err</span>
                }
                <span class="cov8" title="1">existingTemplateRenstra = r
                return nil</span>
        })

        <span class="cov8" title="1">if err := g.Wait(); err != nil </span><span class="cov8" title="1">{
                return "", err
        }</span>

        // -------------------------
        // AGGREGATE ROOT LOGIC
        // -------------------------
        <span class="cov8" title="1">result := domaintemplaterenstra.UpdateTemplateRenstra(
                existingTemplateRenstra,
                templaterenstraUUID,
                cmd.Tahun,
                indikatorDefault.Id,
                cmd.IsPertanyaan == "1",
                fakultasunitDefault.ID,
                cmd.Kategori,
                cmd.Klasifikasi,
                cmd.Satuan,
                cmd.Target,
                cmd.TargetMin,
                cmd.TargetMax,
                cmd.Tugas,
        )

        if !result.IsSuccess </span><span class="cov8" title="1">{
                return "", result.Error
        }</span>

        <span class="cov8" title="1">updatedTemplateRenstra := result.Value

        // -------------------------
        // SAVE TO REPOSITORY
        // -------------------------
        if err := h.Repo.Update(ctx, updatedTemplateRenstra); err != nil </span><span class="cov0" title="0">{
                var mysqlErr *mysql.MySQLError
                if errors.As(err, &amp;mysqlErr) </span><span class="cov0" title="0">{
                        if mysqlErr.Number == 1062 </span><span class="cov0" title="0">{
                                return "", domaintemplaterenstra.DuplicateData()
                        }</span>
                }
                <span class="cov0" title="0">if strings.Contains(err.Error(), "Duplicate entry") </span><span class="cov0" title="0">{
                        return "", domaintemplaterenstra.DuplicateData()
                }</span>

                <span class="cov0" title="0">return "", err</span>
        }

        <span class="cov8" title="1">return updatedTemplateRenstra.UUID.String(), nil</span>
}
</pre>
		
		<pre class="file" id="file121" style="display: none">package application

import (
        validation "github.com/go-ozzo/ozzo-validation/v4"
        helper "UnpakSiamida/common/helper"
)

func UpdateTemplateRenstraCommandValidation(cmd UpdateTemplateRenstraCommand) error <span class="cov8" title="1">{
        return validation.ValidateStruct(&amp;cmd,
                validation.Field(&amp;cmd.Uuid,
                        validation.Required.Error("UUID cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),

                validation.Field(&amp;cmd.Tahun,
                        validation.Required.Error("Tahun cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Indikator,
                        validation.Required.Error("Indikator cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.IsPertanyaan,
                        validation.Required.Error("IsPertanyaan cannot be blank"),
                        validation.In("1", "0").Error("IsPertanyaan invalid value"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.FakultasUnit,
                        validation.Required.Error("FakultasUnit cannot be blank"),
                        validation.By(helper.ValidateUUIDv4),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Kategori,
                        validation.Required.Error("Kategori cannot be blank"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                validation.Field(&amp;cmd.Klasifikasi,
                        validation.Required.Error("Klasifikasi cannot be blank"),
                        validation.In("minor", "major").Error("Klasifikasi invalid value"),
                        validation.By(helper.NoXSSFullScanWithDecode()),
                ),
                // validation.Field(&amp;cmd.Target,
                //         validation.When(cmd.Target != nil, validation.Nil), // skip TargetMin/Max jika Target ada
                // ),
                // validation.Field(&amp;cmd.TargetMin,
                //         validation.When(cmd.Target == nil, validation.Required.Error("TargetMin cannot be blank")),
                // ),
                // validation.Field(&amp;cmd.TargetMax,
                //         validation.When(cmd.Target == nil, validation.Required.Error("TargetMin cannot be blank")),
                // ),
                validation.Field(&amp;cmd.Tugas,
                        validation.Required.Error("Tugas cannot be blank"),
                        validation.In("auditor1", "auditor2").Error("Tugas invalid value"),
                ),
        )
}</pre>
		
		<pre class="file" id="file122" style="display: none">package domain

import (
        "errors"
        "math"
        "strconv"
        "time"

        common "UnpakSiamida/common/domain"
        event "UnpakSiamida/modules/templaterenstra/event"

        "github.com/google/uuid"
)

type TemplateRenstra struct {
        common.Entity
        ID                 uint      `gorm:"primaryKey;autoIncrement"`
        UUID               uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Tahun              string    `gorm:""`
        IndikatorRenstraID uint      `gorm:"column:indikator;"`
        IsPertanyaan       bool      `gorm:"column:pertanyaan;"`
        FakultasUnit       uint      `gorm:"column:fakultas_unit;"`
        Kategori           string    `gorm:""`
        Klasifikasi        string    `gorm:""`
        Satuan             *string   `gorm:""`
        Target             *string   `gorm:""`
        TargetMin          *string   `gorm:"column:target_min;"`
        TargetMax          *string   `gorm:"column:target_max;"`
        Tugas              string    `gorm:""`
}

func (TemplateRenstra) TableName() string <span class="cov0" title="0">{
        return "template_renstra"
}</span>

// === CREATE ===
func NewTemplateRenstra(
        tahun string,
        indikatorRenstraID uint,
        isPertanyaan bool,
        fakultasUnit uint,
        kategori string,
        klasifikasi string,
        satuan *string,
        target *string,
        targetMin *string,
        targetMax *string,
        tugas string,
) common.ResultValue[*TemplateRenstra] <span class="cov8" title="1">{
        hasTarget := target != nil &amp;&amp; *target != ""
        hasTargetMin := targetMin != nil &amp;&amp; *targetMin != ""
        hasTargetMax := targetMax != nil &amp;&amp; *targetMax != ""

        // Valid hanya jika:
        // - Mode A: hasTarget == true AND hasTargetMin == false AND hasTargetMax == false
        // - Mode B: hasTarget == false AND hasTargetMin == true AND hasTargetMax == true
        if !((hasTarget &amp;&amp; !hasTargetMin &amp;&amp; !hasTargetMax) ||
                (!hasTarget &amp;&amp; hasTargetMin &amp;&amp; hasTargetMax)) </span><span class="cov8" title="1">{
                return common.FailureValue[*TemplateRenstra](InvalidValueTarget())
        }</span>
        <span class="cov8" title="1">if hasTargetMin &amp;&amp; hasTargetMax </span><span class="cov8" title="1">{
                minVal, err := strconv.ParseFloat(*targetMin, 64)
                if err != nil </span><span class="cov0" title="0">{
                        if errors.Is(err, strconv.ErrRange) </span><span class="cov0" title="0">{
                                return common.FailureValue[*TemplateRenstra](OutRange())
                        }</span>
                        <span class="cov0" title="0">return common.FailureValue[*TemplateRenstra](InvalidParseMin())</span>
                }

                <span class="cov8" title="1">maxVal, err := strconv.ParseFloat(*targetMax, 64)
                if err != nil </span><span class="cov0" title="0">{
                        if errors.Is(err, strconv.ErrRange) </span><span class="cov0" title="0">{
                                return common.FailureValue[*TemplateRenstra](OutRange())
                        }</span>
                        <span class="cov0" title="0">return common.FailureValue[*TemplateRenstra](InvalidParseMax())</span>
                }

                <span class="cov8" title="1">if math.IsNaN(minVal) || math.IsNaN(maxVal) || math.IsInf(minVal, 0) || math.IsInf(maxVal, 0) || minVal &lt; 0 || maxVal &lt; 0 || minVal &gt; maxVal </span><span class="cov0" title="0">{
                        return common.FailureValue[*TemplateRenstra](OutRange())
                }</span>
        }
        <span class="cov8" title="1">if indikatorRenstraID &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*TemplateRenstra](IndikatorNotFound())
        }</span>
        <span class="cov8" title="1">if fakultasUnit &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*TemplateRenstra](FakultasUnitNotFound())
        }</span>

        <span class="cov8" title="1">templaterenstra := &amp;TemplateRenstra{
                UUID:               uuid.New(),
                Tahun:              tahun,
                IndikatorRenstraID: indikatorRenstraID,
                IsPertanyaan:       isPertanyaan,
                FakultasUnit:       fakultasUnit,
                Kategori:           kategori,
                Klasifikasi:        klasifikasi,
                Satuan:             satuan,
                Target:             target,
                TargetMin:          targetMin,
                TargetMax:          targetMax,
                Tugas:              tugas,
        }

        templaterenstra.Raise(event.TemplateRenstraCreatedEvent{
                EventID:             uuid.New(),
                OccurredOn:          time.Now().UTC(),
                TemplateRenstraUUID: templaterenstra.UUID,
        })

        return common.SuccessValue(templaterenstra)</span>
}

// === UPDATE ===
func UpdateTemplateRenstra(
        prev *TemplateRenstra,
        uid uuid.UUID,
        tahun string,
        indikatorRenstraID uint,
        isPertanyaan bool,
        fakultasUnit uint,
        kategori string,
        klasifikasi string,
        satuan *string,
        target *string,
        targetMin *string,
        targetMax *string,
        tugas string,
) common.ResultValue[*TemplateRenstra] <span class="cov8" title="1">{

        hasTarget := target != nil &amp;&amp; *target != ""
        hasTargetMin := targetMin != nil &amp;&amp; *targetMin != ""
        hasTargetMax := targetMax != nil &amp;&amp; *targetMax != ""

        if prev == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*TemplateRenstra](EmptyData())
        }</span>
        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*TemplateRenstra](InvalidData())
        }</span>
        // Valid hanya jika:
        // - Mode A: hasTarget == true AND hasTargetMin == false AND hasTargetMax == false
        // - Mode B: hasTarget == false AND hasTargetMin == true AND hasTargetMax == true
        <span class="cov8" title="1">if !((hasTarget &amp;&amp; !hasTargetMin &amp;&amp; !hasTargetMax) ||
                (!hasTarget &amp;&amp; hasTargetMin &amp;&amp; hasTargetMax)) </span><span class="cov8" title="1">{
                return common.FailureValue[*TemplateRenstra](InvalidValueTarget())
        }</span>
        <span class="cov8" title="1">if indikatorRenstraID &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*TemplateRenstra](IndikatorNotFound())
        }</span>
        <span class="cov8" title="1">if fakultasUnit &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*TemplateRenstra](FakultasUnitNotFound())
        }</span>

        <span class="cov8" title="1">prev.Tahun = tahun
        prev.IndikatorRenstraID = indikatorRenstraID
        prev.IsPertanyaan = isPertanyaan
        prev.FakultasUnit = fakultasUnit
        prev.Kategori = kategori
        prev.Klasifikasi = klasifikasi
        prev.Satuan = satuan
        prev.Target = target
        prev.TargetMin = targetMin
        prev.TargetMax = targetMax
        prev.Tugas = tugas

        prev.Raise(event.TemplateRenstraUpdatedEvent{
                EventID:             uuid.New(),
                OccurredOn:          time.Now().UTC(),
                TemplateRenstraUUID: prev.UUID,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file123" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateRenstra.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateRenstra.InvalidUuid", "uuid is invalid")
}</span>

func IndikatorNotFound() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateRenstra.IndikatorNotFound", "indikator not found")
}</span>

func FakultasUnitNotFound() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateRenstra.FakultasUnitNotFound", "fakultas unit not found")
}</span>

func InvalidValueTarget() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateRenstra.InvalidValueTarget", "invalid target combination, either provide Target only or provide both TargetMin and TargetMax")
}</span>

func OutRange() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateRenstra.OutRange", "TargetMin &amp; TargetMax is out of range")
}</span>

func InvalidParseMin() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateRenstra.InvalidParseMin", "invalid parse value TargetMin")
}</span>

func InvalidParseMax() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateRenstra.InvalidParseMax", "invalid parse value TargetMax")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateRenstra.InvalidData", "data is invalid")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateRenstra.NotFound", fmt.Sprintf("TemplateRenstra with identifier %s not found", id))
}</span>

func DuplicateData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("TemplateRenstra.DuplicateData", "data not allowed duplicate")
}</span>
</pre>
		
		<pre class="file" id="file124" style="display: none">package domain

import (
        "time"

        common "UnpakSiamida/common/domain"
        helper "UnpakSiamida/common/helper"
        event "UnpakSiamida/modules/user/event"

        "github.com/google/uuid"
)

type User struct {
        common.Entity
        ID           uint      `gorm:"primaryKey;autoIncrement"`
        UUID         uuid.UUID `gorm:"type:char(36);uniqueIndex"`
        Username     string    `gorm:"column:nidn_username;size:100;not null"`
        Password     string    `gorm:"type:longtext;not null"`
        Name         string    `gorm:"size:255;not null"`
        Email        string    `gorm:"size:255;"`
        Level        string    `gorm:"size:255;"`
        FakultasUnit *int      `gorm:"column:fakultas_unit;"`
}

func (User) TableName() string <span class="cov0" title="0">{
        return "users"
}</span>

// === CREATE ===
func NewUser(username string, password string, name string, email string, level string, fakultasunit *int, target *string, tipe *string) common.ResultValue[*User] <span class="cov8" title="1">{

        if !helper.IsValidUnpakEmail(email) </span><span class="cov8" title="1">{
                return common.FailureValue[*User](InvalidEmail())
        }</span>

        <span class="cov8" title="1">if fakultasunit != nil &amp;&amp; *fakultasunit &lt;= 0 </span><span class="cov0" title="0">{
                return common.FailureValue[*User](InvalidFakultasUnit())
        }</span>

        <span class="cov8" title="1">user := &amp;User{
                UUID:         uuid.New(),
                Username:     username,
                Password:     password,
                Name:         name,
                Email:        email,
                Level:        level,
                FakultasUnit: fakultasunit,
        }

        user.Raise(event.UserCreatedEvent{
                EventID:      uuid.New(),
                OccurredOn:   time.Now().UTC(),
                UserUUID:     user.UUID,
                Username:     username,
                Password:     password,
                Name:         name,
                Email:        email,
                Level:        level,
                FakultasUnit: target,
                Tipe:         tipe,
        })

        return common.SuccessValue(user)</span>
}

// === UPDATE ===
func UpdateUser(
        prev *User,
        uid uuid.UUID,
        username string,
        password *string,
        name string,
        email string,
        level string,
        fakultasunit *int,
        target *string,
        tipe *string,
) common.ResultValue[*User] <span class="cov8" title="1">{

        if prev == nil </span><span class="cov8" title="1">{
                return common.FailureValue[*User](EmptyData())
        }</span>

        <span class="cov8" title="1">if prev.UUID != uid </span><span class="cov8" title="1">{
                return common.FailureValue[*User](InvalidData())
        }</span>

        <span class="cov8" title="1">if fakultasunit != nil &amp;&amp; *fakultasunit &lt;= 0 </span><span class="cov8" title="1">{
                return common.FailureValue[*User](InvalidFakultasUnit())
        }</span>

        <span class="cov8" title="1">if !helper.IsValidUnpakEmail(email) </span><span class="cov8" title="1">{
                return common.FailureValue[*User](InvalidEmail())
        }</span>

        // update opsional
        <span class="cov8" title="1">updatedPassword := prev.Password
        if password != nil </span><span class="cov8" title="1">{
                updatedPassword = *password
                prev.Password = *password
        }</span>

        <span class="cov8" title="1">prev.Name = name
        prev.Email = email
        prev.Level = level

        if fakultasunit != nil </span><span class="cov8" title="1">{
                prev.FakultasUnit = fakultasunit
        }</span>

        <span class="cov8" title="1">prev.Raise(event.UserUpdatedEvent{
                EventID:      uuid.New(),
                OccurredOn:   time.Now().UTC(),
                UserUUID:     prev.UUID,
                Username:     username,
                Password:     updatedPassword,
                Name:         name,
                Email:        email,
                Level:        level,
                FakultasUnit: target,
                Tipe:         tipe,
        })

        return common.SuccessValue(prev)</span>
}
</pre>
		
		<pre class="file" id="file125" style="display: none">package domain

import (
        "UnpakSiamida/common/domain"
        "fmt"
)

func EmptyData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("User.EmptyData", "data is not found")
}</span>

func InvalidUuid() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("User.InvalidUuid", "uuid is invalid")
}</span>

func InvalidData() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("User.InvalidData", "data is invalid")
}</span>

func InvalidEmail() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("User.InvalidEmail", "email tidak valid atau tidak diperbolehkan")
}</span>

func InvalidFakultasUnit() domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("User.InvalidFakultasUnit", "fakultas unit tidak valid")
}</span>

func NotFound(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("User.NotFound", fmt.Sprintf("user with identifier %s not found", id))
}</span>

func InvalidParsing(target string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("User.InvalidParsing", fmt.Sprintf("failed parsing %s to UUID", target))
}</span>

func NotFoundFakultasUnit(id string) domain.Error <span class="cov8" title="1">{
        return domain.NotFoundError("User.NotFoundFakultasUnit", fmt.Sprintf("fakultas unit with identifier %s not found", id))
}</span>
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
